<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeFlow | Personal Life Log</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Custom Components -->
    <script type="module" src="js/components.js"></script>
    <!-- Global Styles -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(12px, 1fr));
            gap: 2px;
        }

        .pixel-block {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 1px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .pixel-filled {
            box-shadow: 0 0 6px rgba(244, 63, 94, 0.5);
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.4);
        }

        @keyframes pulse-yellow {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
                opacity: 0.7;
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(234, 179, 8, 0);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
                opacity: 0.7;
            }
        }

        .animate-pulse-yellow {
            animation: pulse-yellow 2s infinite;
        }

        @keyframes breathing {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.95;
            }

            50% {
                transform: scale(1.02);
                opacity: 1;
            }
        }

        .animate-breathing {
            animation: breathing 3s ease-in-out infinite;
        }

        #digitalTimer {
            transition: all 0.8s ease;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.1);
        }

        .timer-approaching {
            background: linear-gradient(135deg, #fff 0%, #fb7185 100%);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow: 0 0 40px rgba(251, 113, 133, 0.2);
        }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <local-sidebar></local-sidebar>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col min-w-0 relative">

        <!-- Header -->
        <local-header title="LifeFlow">
            <i slot="icon" class="fas fa-clock text-rose-500"></i>
            <div slot="actions" class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="openTagsManagement()" class="p-3 text-slate-400 hover:text-white transition"
                        title="Manage Tags">
                        <i class="fas fa-tags text-xl"></i>
                    </button>
                    <button onclick="openStats()" class="p-3 text-slate-400 hover:text-white transition"
                        title="View Stats">
                        <i class="fas fa-history text-xl"></i>
                    </button>
                </div>
            </div>
        </local-header>

        <div class="flex-1 overflow-y-auto">
            <main class="max-w-4xl mx-auto px-4 py-8">

                <!-- Tab Switcher -->
                <div class="flex justify-center mb-12">
                    <div
                        class="flex p-1 bg-slate-800/80 backdrop-blur rounded-2xl border border-slate-700/50 shadow-xl">
                        <button onclick="switchTab('timer')" id="tabBtnTimer"
                            class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-indigo-600 text-white shadow-lg">
                            <i class="fas fa-clock"></i> Timer
                        </button>
                        <button onclick="switchTab('log')" id="tabBtnLog"
                            class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-slate-400 hover:text-white">
                            <i class="fas fa-edit"></i> Quick Log
                        </button>
                    </div>
                </div>

                <!-- Timer Tab Content -->
                <div id="tabContentTimer" class="flex flex-col items-center justify-center min-h-[60vh] py-8">
                    <!-- Grid Layout: 2 columns, 2 rows -->
                    <div class="grid grid-cols-2 gap-x-16 gap-y-8 items-center">
                        <!-- Row 1, Col 1: Pixel Tomato -->
                        <div class="flex flex-col items-center">
                            <div id="pixelGrid"
                                class="pixel-grid bg-slate-800/50 p-6 rounded-2xl border border-slate-700/50 backdrop-blur-sm w-[345px]">
                                <!-- Blocks injected here -->
                            </div>
                            <div class="text-center mt-2 text-sm text-slate-500">
                                <span id="progressText">0 / 25 min</span>
                            </div>
                        </div>

                        <!-- Row 1, Col 2: Digital Timer -->
                        <div class="flex flex-col items-center">
                            <div class="text-[10rem] font-bold font-mono tracking-tighter leading-none tabular-nums text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400 drop-shadow-2xl"
                                id="digitalTimer">
                                25:00
                            </div>
                        </div>

                        <!-- Row 2, Col 1: Duration Settings -->
                        <div class="flex items-center justify-center">
                            <div id="durationSettings"
                                class="flex items-center bg-slate-800 rounded-full p-1.5 border border-slate-700">
                                <button onclick="setDuration(5)"
                                    class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                    data-min="5">5</button>
                                <button onclick="setDuration(15)"
                                    class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                    data-min="15">15</button>
                                <button onclick="setDuration(25)"
                                    class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm"
                                    data-min="25">25</button>
                                <button onclick="setDuration(45)"
                                    class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                    data-min="45">45</button>
                                <button onclick="setDuration(60)"
                                    class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                    data-min="60">60</button>
                                <button onclick="askCustomDuration()"
                                    class="px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"><i
                                        class="fas fa-edit"></i></button>
                            </div>
                        </div>

                        <!-- Row 2, Col 2: Action Buttons -->
                        <div class="flex items-center justify-center gap-3">
                            <button onclick="startTimer()" id="startBtn"
                                class="bg-gradient-to-br from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 text-white font-bold py-3 px-14 rounded-xl shadow-lg shadow-purple-900/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-play"></i>
                                START LOGGING
                            </button>
                            <button onclick="stopTimer()" id="stopBtn"
                                class="hidden bg-gradient-to-br from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 text-white font-bold py-3 px-14 rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-exchange-alt"></i>
                                SWITCH ACTIVITY
                            </button>
                            <button onclick="skipTimer()" id="skipBtn"
                                class="hidden w-12 h-12 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-xl transition-all flex items-center justify-center border border-slate-700/50"
                                title="Skip Log">
                                <i class="fas fa-forward"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Notification Toggle (Outside Grid) -->
                    <div class="mt-16 flex items-center gap-2 opacity-30 hover:opacity-100 transition duration-300">
                        <input type="checkbox" id="notifyToggle" checked
                            class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-rose-500 focus:ring-rose-500 focus:ring-offset-slate-900 cursor-pointer accent-rose-500">
                        <label for="notifyToggle" class="text-sm text-slate-400 cursor-pointer select-none">Task
                            Completion Notification</label>
                    </div>
                </div>

                <!-- Quick Log Tab Content -->
                <div id="tabContentLog" class="hidden max-w-md mx-auto py-8">
                    <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700/50 backdrop-blur-sm shadow-xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-white">Quick Activity Log</h3>
                                <p class="text-xs text-slate-500">Record past activities manually</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <!-- Tag Selector -->
                            <div>
                                <label class="block text-xs text-slate-400 uppercase font-bold mb-1.5 ml-1">Tag</label>
                                <div class="relative" id="quickLogTagSelector">
                                    <button type="button" onclick="toggleQuickLogTagMenu()" id="quickLogTagBtn"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white hover:border-slate-600 focus:border-indigo-500 outline-none transition text-left flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <span id="quickLogTagDot"
                                                class="w-2.5 h-2.5 rounded-full bg-indigo-500"></span>
                                            <span id="quickLogTagName">Default</span>
                                        </div>
                                        <i class="fas fa-chevron-down text-xs text-slate-500"></i>
                                    </button>
                                    <div id="quickLogTagMenu"
                                        class="hidden absolute top-full left-0 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-1 z-50 max-h-48 overflow-y-auto mt-1">
                                        <!-- Items rendered by JS -->
                                    </div>
                                    <input type="hidden" id="quickLogTagValue">
                                </div>
                            </div>
                            <!-- Start DateTime -->
                            <div>
                                <label class="block text-xs text-slate-400 uppercase font-bold mb-1.5 ml-1">Start
                                    Time</label>
                                <input type="datetime-local" id="quickLogStartTime"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition">
                            </div>
                            <!-- Title -->
                            <div>
                                <label
                                    class="block text-xs text-slate-400 uppercase font-bold mb-1.5 ml-1">Title</label>
                                <input type="text" id="quickLogTitle" placeholder="What did you do?"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition">
                            </div>
                            <!-- Duration -->
                            <div>
                                <label class="block text-xs text-slate-400 uppercase font-bold mb-1.5 ml-1">Duration
                                    (minutes)</label>
                                <input type="number" id="quickLogDuration" value="25" min="1"
                                    class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition">
                            </div>
                            <!-- Notes -->
                            <div>
                                <label class="block text-xs text-slate-400 uppercase font-bold mb-1.5 ml-1">Notes
                                    (optional)</label>
                                <textarea id="quickLogNotes" rows="2" placeholder="Additional notes..."
                                    class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2.5 text-sm text-white focus:border-indigo-500 outline-none transition resize-none"></textarea>
                            </div>
                            <!-- Submit -->
                            <button onclick="submitQuickLog()"
                                class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-600/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i>
                                CONFIRM LOG
                            </button>
                        </div>
                    </div>
                </div>



            </main>
        </div>
    </div>

    <!-- Save Modal -->
    <!-- Stats View (Modal/Overlay) -->
    <div id="statsOverlay"
        class="fixed inset-0 bg-slate-900 z-[60] transform translate-y-full transition duration-300 overflow-y-auto">
        <div class="max-w-5xl mx-auto px-4 pb-8">
            <div
                class="sticky top-0 z-[70] bg-slate-900/95 backdrop-blur pt-8 pb-4 mb-6 flex justify-between items-center border-b border-slate-800/50">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-chart-pie text-indigo-500"></i> Data Overview
                </h2>
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Unified Time Range Selector -->
                    <div class="flex items-center gap-2 bg-slate-800 rounded-xl p-1 border border-slate-700/50">
                        <!-- Presets -->
                        <div class="flex p-0.5 bg-slate-900/50 rounded-lg mr-1">
                            <button onclick="setStatsRange('today')" id="rangeBtnToday"
                                class="px-3 py-1.5 text-xs rounded-md transition hover:text-white">Today</button>
                            <button onclick="setStatsRange('last7')" id="rangeBtnLast7"
                                class="px-3 py-1.5 text-xs rounded-md transition hover:text-white">Last 7 Days</button>
                        </div>

                        <div class="w-px h-4 bg-slate-700 mx-1"></div>

                        <!-- Custom Date -->
                        <div class="flex items-center gap-1.5 px-2">
                            <input type="date" id="statsDatePicker"
                                class="bg-slate-900 border border-slate-700 text-xs rounded px-2 py-1.5 text-white outline-none focus:border-rose-500 transition w-32"
                                onchange="setStatsRange('customDay')">
                            <div class="flex p-0.5 bg-slate-900/50 rounded-lg">
                                <button onclick="setStatsRange('customDay')" id="rangeBtnCustomDay"
                                    class="px-2 py-1.5 text-[10px] uppercase tracking-wider rounded-md transition hover:text-white"
                                    title="Stats for selected day">Single Day</button>
                                <button onclick="setStatsRange('customWeek')" id="rangeBtnCustomWeek"
                                    class="px-2 py-1.5 text-[10px] uppercase tracking-wider rounded-md transition hover:text-white"
                                    title="Stats for selected day and 7 days prior">7 Days</button>
                            </div>
                        </div>
                    </div>

                    <button onclick="closeStats()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl transition text-sm font-medium">
                        Close
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">Logged Events</div>
                    <div class="text-2xl font-bold text-white"><span id="statsFocusCount">0</span> <span
                            class="text-sm font-normal text-slate-500">records</span></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">Logged Today</div>
                    <div class="text-xl font-bold text-indigo-400" id="statsTotalTime">0 minutes</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">Active Activities</div>
                    <div class="text-xl font-bold text-purple-400" id="statsEffectiveTime">0 minutes</div>
                    <div class="text-xs text-slate-500 mt-1">Excluding Default</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">Tags</div>
                    <div class="text-2xl font-bold text-amber-400"><span id="statsTagCount">0</span> <span
                            class="text-sm font-normal text-slate-500">tags</span></div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="md:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-medium text-slate-300">Activity Trend</h3>
                        <div class="flex items-center gap-4">
                            <button onclick="toggleFullView()" id="fullViewBtn"
                                class="px-2 py-1 text-xs border border-slate-600 rounded text-slate-400 hover:text-white hover:border-slate-400 transition">
                                <i class="fas fa-expand"></i> Panorama
                            </button>
                            <button onclick="openExportPanoramaModal()"
                                class="px-2 py-1 text-xs border border-emerald-600 rounded text-emerald-400 hover:text-white hover:border-emerald-400 hover:bg-emerald-600/20 transition">
                                <i class="fas fa-image"></i> Export
                            </button>
                            <div class="flex items-center gap-2 text-xs text-slate-400" id="sliderContainer">
                                <button onclick="moveSlider(-1)" class="p-1 hover:text-white transition"><i
                                        class="fas fa-chevron-left"></i></button>
                                <input type="range" id="chartSlider" min="0" max="20" step="1" value="0"
                                    class="w-24 md:w-32 h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                    oninput="onSliderChange(this.value)">
                                <button onclick="moveSlider(1)" class="p-1 hover:text-white transition"><i
                                        class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-medium text-slate-300">Distribution</h3>
                    </div>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="distChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- History List (Unified with Export) -->
            <div class="bg-slate-800 rounded-xl border border-slate-700/50 overflow-hidden">
                <!-- Header with Filters -->
                <div class="p-4 border-b border-slate-700">
                    <div class="flex flex-wrap gap-3 items-center justify-between">
                        <h3 class="font-medium text-slate-300">Detailed Records</h3>
                        <div class="flex flex-wrap gap-2 items-center">
                            <!-- Statistics range is now unified at the top -->
                        </div>
                    </div>
                    <!-- Status & Export Controls -->
                    <div
                        class="flex flex-wrap gap-3 items-center justify-between mt-3 pt-3 border-t border-slate-700/50">
                        <div id="historyStatus" class="text-xs text-slate-500">Loading...</div>
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-1.5 text-xs text-slate-400 cursor-pointer">
                                <input type="checkbox" id="exportExcludeRelax" class="rounded w-3 h-3">
                                Exclude breaks when exporting
                            </label>
                            <button onclick="exportCurrentList()"
                                class="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition flex items-center gap-1.5"
                                title="Copy current list to clipboard">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button onclick="openExportRecordsModal()"
                                class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition flex items-center gap-1.5"
                                title="Export daily Markdown report">
                                <i class="fas fa-file-export"></i> Export MD
                            </button>
                        </div>
                    </div>
                </div>
                <!-- History Items -->
                <div id="historyList" class="divide-y divide-slate-700/50 max-h-[400px] overflow-y-auto">
                    <!-- Items rendered by JS -->
                </div>
            </div>
        </div>
    </div>
    <!-- Save Modal -->
    <div id="saveModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div
            class="bg-slate-800 border-t-4 border-rose-500 rounded-2xl w-full max-w-sm p-8 shadow-2xl transform scale-90 transition-transform duration-300">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-3xl animate-bounce">
                    <i class="fas fa-check"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">Activity Logged!</h3>
                <p class="text-slate-400 text-sm mb-6">Congratulations! You just recorded <span id="saveDuration"
                        class="text-white font-bold">25</span> minutes of life.</p>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6">
                <div class="mb-3 relative">
                    <label class="block text-xs text-slate-500 mb-1">Tag</label>
                    <div class="relative" id="saveTagCustomSelector">
                        <button type="button" onclick="toggleSaveTagMenu()" id="saveTagBtn"
                            class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white hover:border-slate-600 focus:border-rose-500 outline-none transition text-left flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span id="saveSelectedTagDot" class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                                <span id="saveSelectedTagName">Default</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-slate-500"></i>
                        </button>
                        <div id="saveTagMenu"
                            class="hidden absolute top-full left-0 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-1 z-50 max-h-48 overflow-y-auto mt-1">
                            <!-- Items rendered here -->
                        </div>
                        <!-- Hidden input to store value -->
                        <input type="hidden" id="saveTagValue">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-500 mb-1">Title</label>
                    <input type="text" id="saveTitle" placeholder="What did you do?"
                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white placeholder-slate-500 focus:border-rose-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-500 mb-1">Notes (Optional)</label>
                    <textarea id="saveDescription" rows="2" placeholder="Additional notes..."
                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white placeholder-slate-500 focus:border-rose-500 outline-none transition resize-none"></textarea>
                </div>
            </div>

            <div class="flex justify-center">
                <button onclick="confirmSaveSession()"
                    class="w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold shadow-lg shadow-indigo-600/20 transition">
                    CONFIRM LOG
                </button>
            </div>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagsManagementModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-white flex items-center gap-2">
                    <i class="fas fa-tags text-rose-500"></i> Tag Management
                </h3>
                <button onclick="closeTagsManagement()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <button onclick="openAddTagModal()"
                    class="w-full py-2 bg-slate-700/50 hover:bg-slate-700 border border-slate-600 border-dashed text-slate-300 rounded-lg text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Tag
                </button>
            </div>

            <div id="manageTagList" class="space-y-2 max-h-80 overflow-y-auto pr-1">
                <!-- Tags rendered here -->
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="closeTagsManagement()"
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <div id="addTagModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4" id="tagModalTitle">New Tag</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Name</label>
                    <input type="text" id="newTagName" placeholder="e.g., Coding"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="newTagColor" value="#3b82f6"
                            class="w-10 h-10 p-0 rounded border-none cursor-pointer bg-transparent">
                        <span class="text-xs text-slate-500">Click to choose color</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="newTagDefault"
                        class="w-4 h-4 rounded border-slate-600 bg-slate-900 text-blue-500 focus:ring-blue-500 cursor-pointer accent-blue-500">
                    <label for="newTagDefault" class="text-xs text-slate-400 cursor-pointer select-none">Set as default
                        tag</label>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('addTagModal').classList.add('hidden')"
                    class="px-3 py-1.5 text-xs text-slate-400 hover:text-white">Cancel</button>
                <button onclick="confirmAddTag()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-white">Edit Record</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Start Time</label>
                    <input type="datetime-local" id="editStartTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">End Time</label>
                    <input type="datetime-local" id="editEndTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tag</label>
                        <select id="editTagSelect"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status</label>
                        <select id="editStatusSelect"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                            <option value="completed">✅ Completed</option>
                            <option value="aborted">⏹️ Aborted</option>
                            <option value="in_progress">⏳ In Progress</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Title</label>
                    <input type="text" id="editTitle" placeholder="Event Name"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Notes</label>
                    <textarea id="editDescription" rows="2" placeholder="Optional notes..."
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEditSessionModal()"
                    class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">Cancel</button>
                <button onclick="confirmEditSession()"
                    class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">Save</button>
            </div>
        </div>
    </div>

    <!-- Custom Duration Modal -->
    <div id="customDurationModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">Custom Duration</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <button onclick="adjustCustomInput(-5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-minus"></i></button>
                        <div class="text-3xl font-bold font-mono text-blue-400 w-20 text-center">
                            <span id="customInputDisplay">25</span>
                        </div>
                        <button onclick="adjustCustomInput(5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-plus"></i></button>
                    </div>
                    <input type="range" id="customInputRange" min="1" max="180" step="1" value="25"
                        class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2"
                        oninput="updateCustomDisplay(this.value)">
                    <p class="text-center text-xs text-slate-500">minutes</p>
                </div>
            </div>
            <div class="flex justify-between gap-3 mt-6">
                <button onclick="closeCustomDuration()"
                    class="flex-1 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">Cancel</button>
                <button onclick="confirmCustomDuration()"
                    class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Export Records Modal (Daily Markdown) -->
    <div id="exportRecordsModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-white flex items-center gap-2">
                <i class="fas fa-file-export text-blue-400"></i> Export Records
                <span id="exportDateLabel" class="text-sm font-normal text-slate-400 ml-auto"></span>
            </h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3 pb-3 border-b border-slate-700/50">
                    <div>
                        <label class="block text-[10px] text-slate-500 uppercase tracking-wider mb-1">Select
                            Date</label>
                        <input type="date" id="exportDatePicker" onchange="onExportDateChange()"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col justify-end">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="exportIncludeRelax" onchange="onExportDateChange()"
                                class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-blue-500 cursor-pointer accent-blue-500">
                            <label for="exportIncludeRelax"
                                class="text-sm text-slate-300 cursor-pointer select-none">Include Breaks</label>
                        </div>
                    </div>
                </div>
                <!-- Status Message -->
                <div id="exportPreviewStatus" class="text-xs text-slate-500">Select a date to load data</div>
                <div id="exportPreviewArea">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Markdown Output</label>
                        <textarea id="exportRecordsOutput" rows="10" readonly
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-slate-300 font-mono focus:border-blue-500 outline-none resize-none"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="closeExportRecordsModal()"
                        class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">Close</button>
                    <button onclick="copyExportRecords()"
                        class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition flex items-center gap-2">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Panorama Modal (7-Day PNG) -->
    <div id="exportPanoramaModal" style="z-index: 200;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center overflow-y-auto py-8">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-7xl p-8 shadow-2xl my-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-white flex items-center gap-2">
                    <i class="fas fa-image text-emerald-400"></i> Export 7-Day Panorama
                </h3>
                <div class="flex gap-3">
                    <button onclick="closeExportPanoramaModal()"
                        class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">Close</button>
                    <button onclick="downloadPanoramaPNG()"
                        class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-600/20 transition flex items-center gap-2">
                        <i class="fas fa-download"></i> Download PNG
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <p id="exportPanoramaHeader" class="text-xs text-slate-400">Generated based on current stats range</p>
                <!-- Preview Container -->
                <div id="panoramaPreview" class="bg-slate-900 rounded-lg p-4 border border-slate-700 overflow-x-auto">
                    <div class="text-center text-slate-500 py-8">Generating preview...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/db-client.js';

        console.log('[LifeFlow] Script starting...');

        // === State ===
        let currentState = 'stopped'; // stopped, running
        let currentMode = 'work'; // work, short_break, long_break
        let currentEditTagId = null; // null for add, id for edit
        let pendingAbort = false; // true if user clicked stop button (for save modal)
        let durationMinutes = 25;
        let timeLeftSeconds = 25 * 60;
        let timerInterval = null;
        let startTime = null;
        let sessionEndTime = null; // Track when timer actually ends (not when user confirms)

        let currentTag = null; // Will be set on load
        let tags = [];
        let sessions = [];
        let statsMode = 'today'; // Default to Today
        let statsBaseDate = new Date();
        let trendChart = null;
        let distChart = null;

        // === Session Tracking ===
        let currentSessionId = null; // Track record ID in DB for early save/periodic update
        let lastSyncTime = 0;       // Last time we updated DB
        let lastUpdateCheckSecs = 0; // The timeLeft value at last DB update
        let segmentStartTime = null; // Track segment start for session
        let targetEndTime = null;    // Target end time for accurate countdown

        // === DOM Elements ===
        const els = {
            digital: document.getElementById('digitalTimer'),
            pixelGrid: document.getElementById('pixelGrid'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            skipBtn: document.getElementById('skipBtn'),
            durationBtns: document.querySelectorAll('.duration-btn'),
            statsOverlay: document.getElementById('statsOverlay'),
            saveModal: document.getElementById('saveModal'),
            saveDuration: document.getElementById('saveDuration'), // Added for quick log
            tagMenu: document.getElementById('tagMenu'),
            tagList: document.getElementById('tagList'),
            currentTagName: document.getElementById('currentTagName'),
            currentTagDot: document.getElementById('currentTagDot'),
            currentTagBtn: document.getElementById('currentTagBtn'),
            progressText: document.getElementById('progressText')
        };

        // === Init ===
        async function init() {
            console.log('[LifeFlow] init() called.');

            // 1. DB Init
            await initTables();

            // 2. Data Init
            await requestData();

            // Notify Toggle & Permission Sync
            const notifyToggle = document.getElementById('notifyToggle');

            if ('Notification' in window) {
                // Always default to checked as requested
                notifyToggle.checked = true;

                // Sync initial UI state with permission
                if (notifyToggle.checked && Notification.permission === 'granted') {
                    notifyToggle.parentElement.classList.remove('opacity-30');
                } else {
                    notifyToggle.parentElement.classList.add('opacity-30');
                }

                // Handle User Click - request permission when checked
                notifyToggle.addEventListener('change', (e) => {
                    if (notifyToggle.checked) {
                        if (Notification.permission === 'granted') {
                            notifyToggle.parentElement.classList.remove('opacity-30');
                        } else if (Notification.permission === 'denied') {
                            notifyToggle.checked = false;
                            alert('Please allow notification permissions in your browser settings.');
                        } else {
                            Notification.requestPermission().then(perm => {
                                if (perm === 'granted') {
                                    notifyToggle.parentElement.classList.remove('opacity-30');
                                } else {
                                    notifyToggle.checked = false;
                                    if (perm === 'denied') {
                                        alert('Please allow notification permissions in your browser settings.');
                                    }
                                }
                            });
                        }
                    } else {
                        notifyToggle.parentElement.classList.add('opacity-30');
                    }
                });
            } else {
                notifyToggle.parentElement.classList.add('opacity-30');
                notifyToggle.checked = false;
                notifyToggle.disabled = true;
            }

            // 3. Global Click Listener for Tag Menu
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('tagMenu');
                const btn = document.getElementById('currentTagBtn');
                // If menu is open, and click is NOT on menu AND NOT on button, close it.
                if (menu && btn && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.add('hidden');
                }

                const saveMenu = document.getElementById('saveTagMenu');
                const saveBtn = document.getElementById('saveTagBtn');
                // Check if elements exist (save modal might be hidden/inactive but elements are in DOM)
                if (saveMenu && saveBtn && !saveMenu.classList.contains('hidden') && !saveMenu.contains(e.target) && !saveBtn.contains(e.target)) {
                    saveMenu.classList.add('hidden');
                }
            });

            // 4. Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                // Ignore if currently typing in an input or textarea
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                const key = e.key.toLowerCase();
                if (key === 'escape') {
                    // Close all modals
                    document.querySelectorAll('[id$="Modal"], [id$="Overlay"]').forEach(el => {
                        if (el.id === 'statsOverlay') {
                            closeStats();
                        } else {
                            el.classList.add('hidden');
                        }
                    });
                } else if (key === 's') {
                    openStats();
                } else if (key === 't') {
                    openTagsManagement();
                }
            });
        }

        // === Timer State Persistence ===
        // Note: Sessions are now written to DB early to prevent data loss.
        // We use currentSessionId to track the row across updates.

        let isUpserting = false; // Prevent concurrent upsert calls
        async function upsertSessionRecord() {
            if (!startTime || !currentTag || isUpserting) return;
            isUpserting = true;

            const startStr = startTime.toISOString();
            const tagId = currentTag.id;

            try {
                // Check if already exists (prevent duplicate start for same tag and time)
                const existing = await db.query(
                    "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                    [startStr, tagId]
                );

                if (existing && existing[0] && existing[0].values.length > 0) {
                    currentSessionId = existing[0].values[0][0];
                    console.log('[LifeFlow] Resumed existing record:', currentSessionId);
                    isUpserting = false;
                    return;
                }

                // Create new record
                const res = await db.execute(
                    `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) 
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                    [startStr, startStr, 0, tagId, 'in_progress', '', '', new Date().toISOString()]
                );

                if (res && res.lastInsertRowid) {
                    currentSessionId = res.lastInsertRowid;
                    localStorage.setItem('lifeflow_active_session_id', currentSessionId);
                    localStorage.setItem('lifeflow_active_target_mins', durationMinutes);
                    console.log('[LifeFlow] Created early session record:', currentSessionId);
                }
            } catch (err) {
                console.error('[LifeFlow] upsertSessionRecord failed:', err);
            } finally {
                isUpserting = false;
            }
        }

        async function checkSessionRecovery() {
            try {
                // Find most recent in_progress session
                const res = await db.query(
                    "SELECT id, start_time, tag_id FROM pomodoro_sessions WHERE status = 'in_progress' ORDER BY start_time DESC LIMIT 1"
                );

                if (res && res[0] && res[0].values.length > 0) {
                    const [id, startIso, tagId] = res[0].values[0];
                    const start = new Date(startIso);
                    const now = new Date();

                    // Only recover if within the last 4 hours
                    if (now - start > 4 * 3600 * 1000) return;

                    const targetMins = parseInt(localStorage.getItem('lifeflow_active_target_mins')) || 25;
                    const elapsedSecs = Math.floor((now - start) / 1000);
                    const totalSecs = targetMins * 60;

                    if (elapsedSecs < totalSecs) {
                        const remaining = totalSecs - elapsedSecs;
                        if (confirm(`An interrupted activity log (${targetMins} minutes) was detected. Continue?`)) {
                            // Resume
                            currentSessionId = id;
                            durationMinutes = targetMins;
                            timeLeftSeconds = remaining;

                            // Find tag
                            const tag = tags.find(t => t.id === tagId);
                            if (tag) currentTag = tag;

                            // Start timer logic (mimic startTimer but with existing state)
                            currentState = 'running';
                            startTime = start; // Keep original start time
                            targetEndTime = Date.now() + (timeLeftSeconds * 1000);
                            lastUpdateCheckSecs = timeLeftSeconds;

                            // UI
                            els.startBtn.classList.add('hidden');
                            els.stopBtn.classList.remove('hidden');
                            els.skipBtn.classList.remove('hidden');
                            els.digital.classList.add('animate-breathing');
                            els.pixelGrid.classList.add('animate-breathing');

                            updateDigitalDisplay();
                            renderPixels();
                            updatePixelDisplay();

                            if (timerInterval) clearInterval(timerInterval);
                            timerInterval = setInterval(() => {
                                const now = Date.now();
                                const diff = Math.ceil((targetEndTime - now) / 1000);

                                if (diff > 0) {
                                    if (timeLeftSeconds !== diff) {
                                        timeLeftSeconds = diff;
                                        updateDigitalDisplay();
                                        if (timeLeftSeconds < 60) els.digital.classList.add('timer-approaching');

                                        if (lastUpdateCheckSecs - timeLeftSeconds >= 30) {
                                            updateActiveSessionProgress();
                                        }
                                        updatePixelDisplay();
                                    }
                                } else {
                                    timeLeftSeconds = 0;
                                    updateDigitalDisplay();
                                    updatePixelDisplay();
                                    completeSession();
                                }
                            }, 200);

                            console.log('[LifeFlow] Session recovered:', id);
                        } else {
                            // Mark as aborted
                            await db.execute("UPDATE pomodoro_sessions SET status = 'aborted' WHERE id = ?", [id]);
                            localStorage.removeItem('lifeflow_active_session_id');
                            localStorage.removeItem('lifeflow_active_target_mins');
                        }
                    } else {
                        // Mark as aborted if time is up but it was never completed
                        // But we don't know if the user was actually focused. 
                        // Let's mark as aborted to be safe for life-log accuracy.
                        await db.execute("UPDATE pomodoro_sessions SET status = 'aborted' WHERE id = ?", [id]);
                    }
                }
            } catch (err) {
                console.error('[LifeFlow] Recovery failed:', err);
            }
        }

        async function updateActiveSessionProgress() {
            if (!currentSessionId) return;

            const elapsedMinutes = Math.max(0, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));
            const nowStr = new Date().toISOString();

            try {
                await db.execute(
                    "UPDATE pomodoro_sessions SET duration_minutes = ?, end_time = ? WHERE id = ?",
                    [elapsedMinutes, nowStr, currentSessionId]
                );
                lastSyncTime = Date.now();
                lastUpdateCheckSecs = timeLeftSeconds;
                console.log('[LifeFlow] Session progress synced:', elapsedMinutes, 'mins');
            } catch (err) {
                console.error('[LifeFlow] updateActiveSessionProgress failed:', err);
            }
        }


        // === Timer Logic ===
        function setDuration(mins) {
            if (currentState === 'running') return;
            durationMinutes = mins;
            timeLeftSeconds = mins * 60;
            updateDigitalDisplay();
            renderPixels();

            // UI Update
            els.durationBtns.forEach(btn => {
                const btnMins = parseInt(btn.dataset.min);
                if (btnMins === mins) {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm';
                } else {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white';
                }
            });
        }
        window.setDuration = setDuration; // Immediate export for onclick

        function askCustomDuration() {
            if (currentState === 'running') return;
            const modal = document.getElementById('customDurationModal');
            const range = document.getElementById('customInputRange');
            // Set current
            range.value = durationMinutes;
            updateCustomDisplay(durationMinutes);

            modal.classList.remove('hidden');
        }

        function closeCustomDuration() {
            document.getElementById('customDurationModal').classList.add('hidden');
        }

        function updateCustomDisplay(val) {
            document.getElementById('customInputDisplay').innerText = val;
            document.getElementById('customInputRange').value = val;
        }

        function adjustCustomInput(delta) {
            const range = document.getElementById('customInputRange');
            let val = parseInt(range.value) + delta;
            if (val < 1) val = 1;
            if (val > 180) val = 180;
            updateCustomDisplay(val);
        }

        function confirmCustomDuration() {
            const val = parseInt(document.getElementById('customInputRange').value);
            setDuration(val);
            closeCustomDuration();
        }

        // setMode function is no longer needed as break buttons are removed.
        // Keeping it commented out for reference if needed later.
        /*
        function setMode(mode) {
            if (currentState === 'running') return;
            currentMode = mode;

            // UI Update
            const btnWork = document.getElementById('modeWork');
            const btnShort = document.getElementById('modeShortBreak');
            const btnLong = document.getElementById('modeLongBreak');

            [btnWork, btnShort, btnLong].forEach(btn => {
                btn.className = 'px-6 py-2 rounded-lg text-sm font-medium transition text-slate-400 hover:text-white';
            });

            if (mode === 'work') {
                btnWork.className = 'px-6 py-2 rounded-lg text-sm font-medium transition bg-rose-500 text-white shadow-lg shadow-rose-500/20';
                setDuration(25);
                // Reset to default tag for work
                resetTimerToDefaultTag();
            } else if (mode === 'short_break') {
                btnShort.className = 'px-6 py-2 rounded-lg text-sm font-medium transition bg-emerald-500 text-white shadow-lg shadow-emerald-500/20';
                setDuration(5);
                setBreakTag();
            } else if (mode === 'long_break') {
                btnLong.className = 'px-6 py-2 rounded-lg text-sm font-medium transition bg-blue-500 text-white shadow-lg shadow-blue-500/20';
                setDuration(15);
                setBreakTag();
            }
        }
        */

        function setBreakTag() {
            const breakTag = tags.find(t => t.name === 'Relax' || t.name === 'Break' || t.name === 'Rest' || t.name === 'Relaxing');
            if (breakTag) {
                currentTag = breakTag;
                els.currentTagName.innerText = breakTag.name;
                els.currentTagDot.style.backgroundColor = breakTag.color;
            }
        }

        async function startTimer() {
            if (currentState === 'running') return;
            currentState = 'running'; // Set immediately to prevent toggle race

            // Initialize new session
            startTime = new Date();
            timeLeftSeconds = durationMinutes * 60;

            // Reset session tracking
            currentSessionId = null;
            lastSyncTime = Date.now();
            lastUpdateCheckSecs = timeLeftSeconds;

            // Track segment start time
            segmentStartTime = new Date();

            // Calculate target end time based on current remaining seconds
            targetEndTime = Date.now() + (timeLeftSeconds * 1000);

            // UI Adjustments
            els.startBtn.classList.add('hidden');
            els.stopBtn.classList.remove('hidden');
            els.skipBtn.classList.remove('hidden');
            if (els.tagMenu) els.tagMenu.classList.add('hidden');
            if (els.currentTagBtn) els.currentTagBtn.classList.add('opacity-50', 'cursor-not-allowed');
            els.digital.classList.add('animate-breathing');
            els.pixelGrid.classList.add('animate-breathing');

            // Early save to prevent data loss - Await to ensure ID is set before interval or save actions
            await upsertSessionRecord();

            // Use timestamp diffing for accuracy
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((targetEndTime - now) / 1000);

                if (diff > 0) {
                    if (timeLeftSeconds !== diff) {
                        timeLeftSeconds = diff;
                        updateDigitalDisplay();

                        // Visual cue for last minute
                        if (timeLeftSeconds < 60) {
                            els.digital.classList.add('timer-approaching');
                        } else {
                            els.digital.classList.remove('timer-approaching');
                        }

                        // Periodic Sync every 30 seconds
                        if (lastUpdateCheckSecs - timeLeftSeconds >= 30) {
                            updateActiveSessionProgress();
                        }

                        updatePixelDisplay();
                    }
                } else {
                    timeLeftSeconds = 0;
                    updateDigitalDisplay();
                    updatePixelDisplay();
                    completeSession();
                }
            }, 200);
        }

        // pauseTimer removed - no pause functionality

        async function stopTimer() {
            // Stop timer and show save modal with abort status
            currentState = 'stopped';
            clearInterval(timerInterval);

            pendingAbort = true; // Mark as abort for save modal
            sessionEndTime = new Date(); // Record actual end time

            // Show Modal (same as completeSession, but status will be 'aborted')
            const elapsedMinutes = Math.max(1, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));
            openSaveModal(elapsedMinutes, 'aborted');
        }

        async function skipTimer() {
            // This is essentially discarding the current session without saving it.
            // It will reset the timer and UI.
            currentState = 'stopped';
            clearInterval(timerInterval);
            currentSessionId = null; // Clear tracking
            resetTimerUI();
            console.log('[LifeFlow] Timer skipped, session discarded.');
        }

        // Immediate exports for timer control onclick handlers
        window.startTimer = startTimer;
        window.stopTimer = stopTimer;
        window.skipTimer = skipTimer;

        function openSaveModal(duration = durationMinutes, status = 'completed') {
            // Auto-tagging logic
            const tagName = duration <= 15 ? 'Relax' : 'Default';
            const tag = tags.find(t => t.name === tagName) || tags[0];

            document.getElementById('saveDuration').innerText = duration;
            renderSaveModalTagOptions(); // Populate tag dropdown

            // Set auto-selected tag in UI
            if (tag) {
                selectSaveTag(tag.id);
            }

            document.getElementById('saveTitle').value = '';
            document.getElementById('saveDescription').value = '';

            const modal = els.saveModal;
            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    const innerDiv = modal.querySelector('div');
                    if (innerDiv) {
                        innerDiv.classList.remove('scale-90');
                        innerDiv.classList.add('scale-100');
                    }
                }, 10);
            }
        }

        async function completeSession() {
            // Stop intervals without completing segment (will be done via save modal)
            currentState = 'stopped';
            clearInterval(timerInterval);
            pendingAbort = false; // This is a completed session, not aborted
            sessionEndTime = new Date(); // Record actual end time

            playCompletionSound();

            // System Notification
            const notifyToggle = document.getElementById('notifyToggle');
            if (notifyToggle && notifyToggle.checked) {
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    try {
                        const n = new Notification('Activity Logged!', {
                            body: `Congratulations! You just recorded ${durationMinutes} minutes of life.`,
                            icon: 'favicon.png',
                            tag: 'lifeflow-complete'
                        });
                        console.log('[LifeFlow] Notification sent:', n);
                    } catch (e) {
                        console.error('[LifeFlow] Notify Error:', e);
                    }
                } else {
                    Notification.requestPermission();
                }
            }

            openSaveModal(durationMinutes, 'completed');
        }

        // discardSession function is no longer needed as the "Discard" button is removed.
        /*
        async function discardSession() {
            // Get selected tag from modal dropdown (in case user selected one before discarding)
            const selectedTagId = parseInt(document.getElementById('saveTagValue').value);
            const selectedTag = tags.find(t => t.id === selectedTagId) || currentTag;

            closeSaveModal();

            // Write an aborted record to track the discarded session
            const end = sessionEndTime || new Date();
            const start = startTime || new Date(end.getTime() - durationMinutes * 60000);
            const actualDuration = Math.max(0, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));

            try {
                if (currentSessionId) {
                    await db.execute(
                        "UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ? WHERE id = ?",
                        [end.toISOString(), actualDuration, selectedTag.id, 'aborted', currentSessionId]
                    );
                } else {
                    // Fallback: Triple check if record exists before inserting
                    const existing = await db.query(
                        "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                        [start.toISOString(), selectedTag.id]
                    );

                    if (existing && existing[0] && existing[0].values.length > 0) {
                        const foundId = existing[0].values[0][0];
                        await db.execute(
                            "UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ? WHERE id = ?",
                            [end.toISOString(), actualDuration, selectedTag.id, 'aborted', foundId]
                        );
                    } else {
                        await db.execute(
                            `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                            [start.toISOString(), end.toISOString(), actualDuration, selectedTag.id, 'aborted', '', '', new Date().toISOString()]
                        );
                    }
                }
                console.log('[LifeFlow] Discarded session saved as aborted');
            } catch (err) {
                console.error('[LifeFlow] Failed to save aborted session:', err);
            }

            currentSessionId = null; // Clear tracking
            resetTimerUI();
        }
        */

        // === Save Modal Tag Logic ===
        function toggleSaveTagMenu() {
            const menu = document.getElementById('saveTagMenu');
            menu.classList.toggle('hidden');
        }

        function selectSaveTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                document.getElementById('saveSelectedTagName').innerText = t.name;
                document.getElementById('saveSelectedTagDot').style.backgroundColor = t.color;
                document.getElementById('saveTagValue').value = t.id;
            }
            document.getElementById('saveTagMenu').classList.add('hidden');
        }

        // Render tag options for save modal dropdown
        function renderSaveModalTagOptions() {
            const menu = document.getElementById('saveTagMenu');
            if (!menu) return;

            const listHtml = tags.map(t => `
                <button type="button" onclick="selectSaveTag(${t.id})" class="w-full text-left px-3 py-2 hover:bg-slate-700 transition flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                    <span class="text-sm text-slate-300 hover:text-white">${t.name}</span>
                </button>
            `).join('');

            menu.innerHTML = listHtml;

            // Set initial selection
            if (currentTag) {
                selectSaveTag(currentTag.id);
            } else if (tags.length > 0) {
                selectSaveTag(tags[0].id);
            }
        }

        function resetTimerUI() {
            currentState = 'stopped';
            pendingAbort = false; // Reset abort flag
            sessionEndTime = null; // Clear end time
            timeLeftSeconds = durationMinutes * 60;
            updateDigitalDisplay();
            renderPixels();

            // Reset animations
            els.digital.classList.remove('animate-breathing', 'timer-approaching');
            els.pixelGrid.classList.remove('animate-breathing');

            // Enable tag selection
            if (els.currentTagBtn) els.currentTagBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show main button again
            els.startBtn.classList.remove('hidden');
            els.stopBtn.classList.add('hidden');
            els.skipBtn.classList.add('hidden');

            resetTimerToDefaultTag();
        }

        function resetTimerToDefaultTag() {
            const defaultTag = tags.find(t => t.isDefault) || tags[0];
            if (defaultTag) {
                currentTag = defaultTag;
                if (els.currentTagName) els.currentTagName.innerText = defaultTag.name;
                if (els.currentTagDot) els.currentTagDot.style.backgroundColor = defaultTag.color;
            }
        }

        let activitiesCompleted = 0;
        let lastWorkTagId = null;

        async function confirmSaveSession() {
            // Get inputs
            const title = document.getElementById('saveTitle').value.trim();
            const desc = document.getElementById('saveDescription').value.trim();

            // Get selected tag
            const selectedTagId = parseInt(document.getElementById('saveTagValue').value);
            const selectedTag = tags.find(t => t.id === selectedTagId) || currentTag;

            // Update currentTag for auto-flow
            currentTag = selectedTag;

            // Time calculation
            const end = sessionEndTime || new Date();
            const start = startTime || new Date(end.getTime() - durationMinutes * 60000);

            // Status and duration
            const status = pendingAbort ? 'aborted' : 'completed';
            const actualDuration = pendingAbort
                ? Math.max(1, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60))
                : durationMinutes;

            console.log('[LifeFlow] confirmSaveSession called, id:', currentSessionId, 'tag:', selectedTag.name, 'status:', status);

            try {
                // Check if cross day
                if (start.toDateString() !== end.toDateString()) {
                    // Cross-day: Delete the early-saved record and insert split records
                    if (currentSessionId) {
                        await db.execute("DELETE FROM pomodoro_sessions WHERE id = ?", [currentSessionId]);
                    }

                    const midnight = new Date(start);
                    midnight.setHours(24, 0, 0, 0);
                    const dur1 = Math.round((midnight - start) / 60000);
                    const dur2 = actualDuration - dur1;

                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                        [start.toISOString(), midnight.toISOString(), dur1, selectedTag.id, status, title + ' (Part 1)', desc, new Date().toISOString()]
                    );
                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                        [midnight.toISOString(), end.toISOString(), dur2, selectedTag.id, status, title, desc, new Date().toISOString()]
                    );
                } else {
                    if (currentSessionId) {
                        // Update existing record
                        await db.execute(
                            `UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                            [end.toISOString(), actualDuration, selectedTag.id, status, title, desc, currentSessionId]
                        );
                    } else {
                        // Fallback: Triple check if record exists by start_time before inserting
                        const existing = await db.query(
                            "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                            [start.toISOString(), selectedTag.id]
                        );

                        if (existing && existing[0] && existing[0].values.length > 0) {
                            const foundId = existing[0].values[0][0];
                            await db.execute(
                                `UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                                [end.toISOString(), actualDuration, selectedTag.id, status, title, desc, foundId]
                            );
                        } else {
                            await db.execute(
                                `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                                [start.toISOString(), end.toISOString(), actualDuration, selectedTag.id, status, title, desc, new Date().toISOString()]
                            );
                        }
                    }
                }
            } catch (err) {
                console.error('Save Session Failed:', err);
            }

            currentSessionId = null; // Clear tracking
            closeSaveModal();
            resetTimerUI();

            // Auto-flow logic removed as per new design
            /*
            if (status === 'completed' && currentMode === 'work') {
                // Determine if it should be long break or short break
                // For simplicity, alternating or just short break for now
                if (confirm('🎉 Great job! Start a 5-minute short break?')) {
                    setMode('short_break');
                }
            } else if (status === 'completed' && currentMode.includes('break')) {
                if (confirm('☕ Break over. Ready for another 25-minute life log?')) {
                    setMode('work');
                }
            }
            */
        }

        function handleAutoFlow() {
            // Simply reset UI, user manually chooses next action
            activitiesCompleted++;
            resetTimerUI();
        }

        function switchTab(tab) {
            const timerView = document.getElementById('tabContentTimer');
            const logView = document.getElementById('tabContentLog');
            const timerBtn = document.getElementById('tabBtnTimer');
            const logBtn = document.getElementById('tabBtnLog');

            if (tab === 'timer') {
                timerView.classList.remove('hidden');
                logView.classList.add('hidden');
                timerBtn.className = 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-indigo-600 text-white shadow-lg';
                logBtn.className = 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-slate-400 hover:text-white';
            } else {
                timerView.classList.add('hidden');
                logView.classList.remove('hidden');
                timerBtn.className = 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 text-slate-400 hover:text-white';
                logBtn.className = 'px-8 py-2.5 rounded-xl text-sm font-bold transition-all flex items-center gap-2 bg-indigo-600 text-white shadow-lg';
            }
        }

        async function submitQuickLog() {
            const titleInput = document.getElementById('quickLogTitle');
            const durationInput = document.getElementById('quickLogDuration');
            const notesInput = document.getElementById('quickLogNotes');
            const tagValueInput = document.getElementById('quickLogTagValue');
            const startTimeInput = document.getElementById('quickLogStartTime');

            const title = titleInput.value.trim();
            const duration = parseInt(durationInput.value);
            const notes = notesInput ? notesInput.value.trim() : '';

            if (!duration || duration <= 0) {
                alert('Please enter a valid duration.');
                return;
            }

            // Get selected tag or default
            const selectedTagId = parseInt(tagValueInput?.value);
            const tag = tags.find(t => t.id === selectedTagId) || tags.find(t => t.isDefault) || tags[0];

            // Calculate start and end times
            let start, end;
            if (startTimeInput && startTimeInput.value) {
                start = new Date(startTimeInput.value);
                end = new Date(start.getTime() + duration * 60000);
            } else {
                // Default: end is now, start is now - duration
                end = new Date();
                start = new Date(end.getTime() - duration * 60000);
            }

            try {
                await db.execute(
                    `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                    [start.toISOString(), end.toISOString(), duration, tag.id, 'completed', title, notes, new Date().toISOString()]
                );

                // Reset fields
                titleInput.value = '';
                durationInput.value = '25';
                if (notesInput) notesInput.value = '';
                if (startTimeInput) startTimeInput.value = '';

                // Feedback
                console.log('[LifeFlow] Quick log submitted:', title, duration, 'min, tag:', tag.name);
                requestData(); // Refresh UI
                showSuccessToast('Activity Logged!', `${duration} min recorded as ${tag.name}`);
            } catch (err) {
                console.error('[LifeFlow] Quick Log Failed:', err);
                showSuccessToast('Failed to save', err.message, 'error');
            }
        }

        function showSuccessToast(title, message = '', type = 'success') {
            // Remove existing toast
            const existing = document.getElementById('successToast');
            if (existing) existing.remove();

            const isError = type === 'error';
            const bgColor = isError ? 'bg-red-600/90' : 'bg-emerald-600/90';
            const icon = isError ? 'fa-exclamation-circle' : 'fa-check-circle';

            const toast = document.createElement('div');
            toast.id = 'successToast';
            toast.className = `fixed top-6 left-1/2 -translate-x-1/2 ${bgColor} backdrop-blur-md text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 z-[1000] border border-white/10 transition-all duration-300 opacity-0 -translate-y-4`;
            toast.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="fas ${icon} text-xl"></i>
                </div>
                <div>
                    <div class="font-bold text-lg">${title}</div>
                    ${message ? `<div class="text-sm text-white/80">${message}</div>` : ''}
                </div>
            `;
            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0', '-translate-y-4');
                toast.classList.add('opacity-100', 'translate-y-0');
            });

            // Auto remove
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleQuickLogTagMenu() {
            const menu = document.getElementById('quickLogTagMenu');
            if (menu) menu.classList.toggle('hidden');
        }

        function selectQuickLogTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                const nameEl = document.getElementById('quickLogTagName');
                const dotEl = document.getElementById('quickLogTagDot');
                const valueEl = document.getElementById('quickLogTagValue');
                if (nameEl) nameEl.innerText = t.name;
                if (dotEl) dotEl.style.backgroundColor = t.color;
                if (valueEl) valueEl.value = t.id;
            }
            const menu = document.getElementById('quickLogTagMenu');
            if (menu) menu.classList.add('hidden');
        }

        function renderQuickLogTagOptions() {
            const menu = document.getElementById('quickLogTagMenu');
            if (!menu) return;

            menu.innerHTML = tags.map(t => `
                <button type="button" onclick="selectQuickLogTag(${t.id})" class="w-full text-left px-3 py-2 hover:bg-slate-700 transition flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                    <span class="text-sm text-slate-300 hover:text-white">${t.name}</span>
                </button>
            `).join('');

            // Set default selection
            const defaultTag = tags.find(t => t.isDefault) || tags[0];
            if (defaultTag) {
                selectQuickLogTag(defaultTag.id);
            }
        }

        // Immediately export tab functions for onclick handlers
        window.switchTab = switchTab;
        window.submitQuickLog = submitQuickLog;
        window.toggleQuickLogTagMenu = toggleQuickLogTagMenu;
        window.selectQuickLogTag = selectQuickLogTag;


        function closeSaveModal() {
            const modal = els.saveModal;
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-90');
            modal.querySelector('div').classList.remove('scale-100');

            // Clear recovery storage
            localStorage.removeItem('lifeflow_active_session_id');
            localStorage.removeItem('lifeflow_active_target_mins');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // === Audio Logic ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playCompletionSound() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const now = audioCtx.currentTime;

            // Note 1: E5 (659.25 Hz)
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(659.25, now);
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.start(now);
            osc1.stop(now + 0.5);

            // Note 2: G#5 (830.61 Hz)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(830.61, now + 0.1);
            gain2.gain.setValueAtTime(0.1, now + 0.1);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start(now + 0.1);
            osc2.stop(now + 0.6);

            // Note 3: B5 (987.77 Hz) - Major chord finish
            const osc3 = audioCtx.createOscillator();
            const gain3 = audioCtx.createGain();
            osc3.type = 'sine';
            osc3.frequency.setValueAtTime(987.77, now + 0.2);
            gain3.gain.setValueAtTime(0.1, now + 0.2);
            gain3.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
            osc3.connect(gain3);
            gain3.connect(audioCtx.destination);
            osc3.start(now + 0.2);
            osc3.stop(now + 1.2);
        }

        // === Utils ===
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // === UI Rendering ===
        function updateDigitalDisplay() {
            const mins = Math.floor(timeLeftSeconds / 60);
            const secs = timeLeftSeconds % 60;
            const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

            if (els.digital) {
                els.digital.innerText = timeStr;
            }

            const tagName = currentTag?.name || '';
            document.title = tagName ? `${timeStr} - ${tagName} - LifeFlow` : `${timeStr} - LifeFlow`;
        }

        // Smoother, rounder tomato shape
        const TOMATO_MAP = [
            [0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0],
            [0, 0, 1, 1, 2, 2, 2, 2, 2, 1, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0]
        ];

        function renderPixels() {
            els.pixelGrid.innerHTML = '';
            els.pixelGrid.style.display = 'grid';
            els.pixelGrid.style.gridTemplateColumns = `repeat(13, 1fr)`;
            els.pixelGrid.style.gap = '2px';
            els.pixelGrid.style.maxWidth = '300px';
            els.pixelGrid.style.margin = '0 auto';

            TOMATO_MAP.flat().forEach((val, index) => {
                const div = document.createElement('div');
                div.id = `pixel-${index}`;

                if (val === 0) {
                    div.className = 'pixel-block invisible';
                } else {
                    div.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                    div.dataset.type = val; // 1=Body, 2=Stem
                    // Keep aspect ratio roughly square
                    div.style.aspectRatio = '1/1';
                }
                els.pixelGrid.appendChild(div);
            });

            els.progressText.innerText = `0 / ${durationMinutes} min`;
        }

        function updatePixelDisplay() {
            const totalSeconds = durationMinutes * 60;
            const elapsed = totalSeconds - timeLeftSeconds;
            const percentage = elapsed / totalSeconds;
            const elapsedMins = Math.floor(elapsed / 60);

            // Update text
            els.progressText.innerText = `${elapsedMins} / ${durationMinutes} min`;

            // Calculate active pixels
            const allPixels = Array.from(els.pixelGrid.children);
            const fillablePixels = allPixels.filter(el => !el.classList.contains('invisible'));
            const countToFill = Math.floor(fillablePixels.length * percentage);

            fillablePixels.forEach((block, i) => {
                const type = block.dataset.type;
                if (i < countToFill) {
                    if (!block.classList.contains('pixel-filled')) {
                        if (type === '2') {
                            block.style.backgroundColor = '#4ade80'; // Green stem
                        } else {
                            block.style.backgroundColor = '#f43f5e'; // Rose-500
                        }
                        block.classList.add('pixel-filled');
                        block.style.filter = 'brightness(1.2)';
                    }
                } else {
                    if (block.classList.contains('pixel-filled')) {
                        block.style.backgroundColor = '';
                        block.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                        block.style.filter = '';
                        block.style.boxShadow = '';
                        block.classList.remove('pixel-filled');
                    }
                }
            });
        }

        // === Tag Logic ===
        function toggleTagMenu() {
            if (currentState === 'running') return;
            if (els.tagMenu) els.tagMenu.classList.toggle('hidden');
        }

        function selectTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                currentTag = t;
                if (els.currentTagName) els.currentTagName.innerText = t.name;
                if (els.currentTagDot) els.currentTagDot.style.backgroundColor = t.color;
            }
            if (els.tagMenu) els.tagMenu.classList.add('hidden');
        }

        function renderTags(tagList, showActions = true) {
            if (tagList) {
                tags = tagList.map(r => ({
                    id: r.values[0],
                    name: r.values[1],
                    color: r.values[2],
                    isDefault: r.values[3] === 1
                }));

                // Sort: isDefault first, then alphabetically by name
                tags.sort((a, b) => {
                    if (a.isDefault && !b.isDefault) return -1;
                    if (!a.isDefault && b.isDefault) return 1;
                    return a.name.localeCompare(b.name, 'en');
                });
            }

            if (tags.length === 0) {
                // No tags found? Create defaults.
                console.log('[LifeFlow] No tags found, creating defaults...');
                createDefaultTags();
                return;
            }

            // Logic to determine selection
            let selected = null;
            if (currentTag) {
                // Try to keep current selection
                selected = tags.find(t => t.id === currentTag.id);
            }

            // Always prefer Default tag initially, ignore localStorage

            if (!selected) {
                // Fallback: Default tag or First tag
                selected = tags.find(t => t.isDefault) || tags[0];
            }

            // Update currentTag reference
            currentTag = selected;
            // Update UI for current tag
            if (currentTag) {
                try {
                    els.currentTagName.innerText = currentTag.name;
                    els.currentTagDot.style.backgroundColor = currentTag.color;
                    // checkSkipButton(); // This function is not defined in the provided code.
                } catch (e) { }
            }

            if (els.tagList) {
                els.tagList.innerHTML = tags.map(t => `
                <div class="w-full px-3 py-1 hover:bg-slate-700/50 transition flex items-center justify-between group">
                    <button onclick="selectTag(${t.id})" class="flex-1 flex items-center gap-2 py-1.5 text-left">
                        <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                        <span class="text-sm ${currentTag && t.id === currentTag.id ? 'text-white font-bold' : 'text-slate-300 group-hover:text-white'}">${t.name}</span>
                    </button>
                    ${showActions ? `
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="editTag(${t.id})" class="p-1.5 text-slate-500 hover:text-blue-400" title="Edit">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        ${!t.isDefault ? `
                        <button onclick="confirmDeleteTag(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-500 hover:text-rose-400" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                        ` : ''}
                    </div>
                    ` : (currentTag && t.id === currentTag.id ? '<i class="fas fa-check text-xs text-blue-500"></i>' : '')}
                </div>
            `).join('');
            }

            // Also update the list in Tags Management modal
            const manageList = document.getElementById('manageTagList');
            if (manageList) {
                manageList.innerHTML = tags.map(t => `
                    <div class="bg-slate-900/50 border border-slate-700/50 p-3 rounded-xl flex items-center justify-between group">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full shadow-sm" style="background-color: ${t.color}"></div>
                            <div>
                                <div class="text-sm font-medium text-slate-200">${t.name}</div>
                                ${t.isDefault ? '<div class="text-[10px] text-slate-500 uppercase tracking-wider">Default Tag</div>' : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editTag(${t.id})" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-blue-400 hover:bg-blue-400/10 transition">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            ${!t.isDefault ? `
                            <button onclick="confirmDeleteTag(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-rose-400 hover:bg-rose-400/10 transition">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            // Also render Quick Log tag options
            renderQuickLogTagOptions();
        }

        function openTagsManagement() {
            document.getElementById('tagsManagementModal').classList.remove('hidden');
        }

        function closeTagsManagement() {
            document.getElementById('tagsManagementModal').classList.add('hidden');
        }

        async function createDefaultTags() {
            const defaults = [
                { name: 'Default', color: '#818cf8', is_default: 1 }, // Indigo for general activities
                { name: 'Relax', color: '#f472b6', is_default: 0 }    // Pink/Rose for relax
            ];

            for (const d of defaults) {
                try {
                    await db.execute(
                        "INSERT INTO pomodoro_tags (name, color, is_default) SELECT ?, ?, ? WHERE NOT EXISTS (SELECT 1 FROM pomodoro_tags WHERE name = ?)",
                        [d.name, d.color, d.is_default, d.name]
                    );
                } catch (e) { console.error('Create Default Tag Failed:', d.name, e); }
            }
            setTimeout(requestData, 500);
        }

        // Add Tag color picker

        function openAddTagModal() {
            if (els.tagMenu) els.tagMenu.classList.add('hidden');
            currentEditTagId = null;
            document.getElementById('tagModalTitle').innerText = 'New Tag';
            document.getElementById('newTagName').value = '';
            document.getElementById('newTagColor').value = '#3b82f6';
            document.getElementById('newTagDefault').checked = false;
            document.getElementById('addTagModal').classList.remove('hidden');
        }

        function closeAddTagModal() {
            document.getElementById('addTagModal').classList.add('hidden');
        }

        async function editTag(id) {
            const tag = tags.find(t => t.id === id);
            if (!tag) return;

            currentEditTagId = id;
            document.getElementById('tagModalTitle').innerText = 'Edit Tag';
            document.getElementById('newTagName').value = tag.name;
            document.getElementById('newTagColor').value = tag.color;
            document.getElementById('newTagDefault').checked = tag.isDefault;
            document.getElementById('addTagModal').classList.remove('hidden');
        }

        async function confirmDeleteTag(id, name) {
            if (confirm(`Are you sure you want to delete tag "${name}"? All sessions under this tag will be moved to Default.`)) {
                try {
                    await db.execute("DELETE FROM pomodoro_tags WHERE id = ?", [id]);
                } catch (e) { console.error('Delete Tag Failed:', e); }
            }
        }

        async function confirmAddTag() {
            const name = document.getElementById('newTagName').value.trim();
            const color = document.getElementById('newTagColor').value;
            const isDefault = document.getElementById('newTagDefault').checked ? 1 : 0;

            if (!name) return;

            try {
                // If this tag is being set as default, unset others first
                if (isDefault === 1) {
                    await db.execute("UPDATE pomodoro_tags SET is_default = 0");
                }

                if (currentEditTagId) {
                    await db.execute("UPDATE pomodoro_tags SET name = ?, color = ?, is_default = ? WHERE id = ?", [name, color, isDefault, currentEditTagId]);
                } else {
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, ?)", [name, color, isDefault]);
                }

                // If we unset a default but didn't set a new one, we might need a fallback.
                // But normally we'd always want at least one default. 
                // Ensuring at least one default tag exists:
                if (isDefault === 0) {
                    const countRes = await db.query("SELECT COUNT(*) FROM pomodoro_tags WHERE is_default = 1");
                    if (countRes && countRes[0].values[0][0] === 0) {
                        // If no default exists, force this one or keep the first one as default
                        // For now, let's just let it be, but usually it's better to keep one.
                    }
                }
            } catch (e) { console.error('Save Tag Failed:', e); }

            document.getElementById('addTagModal').classList.add('hidden');
            document.getElementById('newTagName').value = '';
        }


        // === Stats Logic ===
        function openStats() {
            els.statsOverlay.classList.remove('translate-y-full');

            const picker = document.getElementById('statsDatePicker');
            if (picker && !picker.value) {
                picker.valueAsDate = new Date();
            }

            setStatsRange(statsMode);
            requestData();
        }

        function closeStats() {
            els.statsOverlay.classList.add('translate-y-full');
        }

        let tablesInitialized = false; // Flag to ensure migration is complete

        async function requestData() {
            if (!db.isOpen) {
                // console.warn('Database not open');
                if (!document.getElementById('db-warning-toast')) {
                    const toast = document.createElement('div');
                    toast.id = 'db-warning-toast';
                    toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg z-50 animate-bounce';
                    toast.innerText = 'Please open database in Dashboard';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                return;
            }

            if (!tablesInitialized) {
                console.log('[LifeFlow] Waiting for tables initialization...');
                return;
            }

            // Load all sessions to support historical stats and comparisons
            // Optimized: We fetch everything since stats are local and records are few.

            try {
                // 1. Get Tags
                console.log('[LifeFlow] Querying tags...');
                const tagsResult = await db.query("SELECT id, name, color, is_default FROM pomodoro_tags");
                console.log('[LifeFlow] Tags result:', tagsResult);
                if (tagsResult && tagsResult.length > 0) {
                    const formattedTags = tagsResult[0].values.map(v => ({ values: v }));
                    console.log('[LifeFlow] Formatted tags:', formattedTags);
                    renderTags(formattedTags);
                } else {
                    console.log('[LifeFlow] No tags found in database');
                }

                // 2. Get Sessions
                console.log('[LifeFlow] Querying all sessions...');
                const sessionsResult = await db.query("SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description FROM pomodoro_sessions ORDER BY start_time DESC");
                console.log('[LifeFlow] Sessions result:', sessionsResult);

                if (sessionsResult && sessionsResult.length > 0) {
                    const raw = sessionsResult[0].values;
                    sessions = raw.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                    console.log('[LifeFlow] Parsed sessions:', sessions.length);
                } else {
                    sessions = [];
                    console.log('[LifeFlow] No sessions found');
                }

                if (!els.statsOverlay.classList.contains('translate-y-full')) {
                    updateStatsUI();
                }

            } catch (err) {
                console.error('[LifeFlow] Data Load Error:', err);
            }
        }

        // Listen for updates (reload data + save to IDB)
        db.on('db_updated', () => {
            console.log('[LifeFlow] DB Updated, reloading...');
            requestData();
            // Note: saveSnapshotToIDB is registered separately below
        });


        function setStatsRange(mode) {
            statsMode = mode;
            const picker = document.getElementById('statsDatePicker');

            if (mode.startsWith('custom') && picker.value) {
                statsBaseDate = new Date(picker.value + 'T00:00:00');
            } else {
                statsBaseDate = new Date();
                statsBaseDate.setHours(0, 0, 0, 0);
            }

            // Update UI Button Styles
            const buttons = {
                'today': 'rangeBtnToday',
                'last7': 'rangeBtnLast7',
                'customDay': 'rangeBtnCustomDay',
                'customWeek': 'rangeBtnCustomWeek'
            };

            const activeClass = 'bg-rose-600 text-white shadow-sm';
            const inactiveClass = 'text-slate-400 hover:text-white';

            Object.entries(buttons).forEach(([m, id]) => {
                const btn = document.getElementById(id);
                if (btn) btn.className = `px-3 py-1.5 text-xs rounded-md transition ${m === statsMode ? activeClass : inactiveClass}`;
            });

            updateStatsUI();
        }
        window.setStatsRange = setStatsRange; // Immediate export for onclick

        function updateStatsUI() {
            const now = new Date();
            let startDate, endDate;

            // 1. Calculate Unified Range
            if (statsMode === 'today') {
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
            } else if (statsMode === 'last7') {
                endDate = new Date(now);
                endDate.setHours(0, 0, 0, 0);
                endDate.setDate(endDate.getDate() + 1);
                startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 7);
            } else if (statsMode === 'customDay') {
                startDate = new Date(statsBaseDate);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
            } else if (statsMode === 'customWeek') {
                endDate = new Date(statsBaseDate);
                endDate.setDate(endDate.getDate() + 1);
                startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 7);
            }

            // Trend baseDate for chart labels (start of the 7-day period)
            const trendStartDate = new Date(endDate);
            trendStartDate.setDate(trendStartDate.getDate() - 7);

            // Helpers
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
            const isRelax = (s) => getTag(s.tagId).name === 'Relax';
            const isDefault = (s) => getTag(s.tagId).name === 'Default';

            // Filter Activity Sessions (exclude Relax if needed, but for Life Log we show all)
            const activitySessions = sessions;

            // Filter for Summary & Distribution
            const rangedSessions = activitySessions.filter(s => {
                const st = new Date(s.startTime);
                return st >= startDate && st < endDate;
            });

            // Calculate metrics for ranged sessions
            const recordCount = rangedSessions.length;
            const totalMins = rangedSessions.reduce((sum, s) => sum + s.duration, 0);
            const activeMins = rangedSessions.filter(s => !isRelax(s)).reduce((sum, s) => sum + s.duration, 0);
            const effectiveSessions = rangedSessions.filter(s => !isDefault(s));
            const effectiveMins = effectiveSessions.reduce((sum, s) => sum + s.duration, 0);

            // Unique tags used in ranged sessions
            const usedTagIds = [...new Set(rangedSessions.map(s => s.tagId))];
            const tagCount = usedTagIds.length;

            // Helper: format minutes as "xx H xx mins"
            function formatDuration(mins) {
                if (mins < 60) return `${mins} mins`;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return m > 0 ? `${h} H ${m} mins` : `${h} H`;
            }

            // Update Summary Cards
            document.getElementById('statsFocusCount').innerText = recordCount;
            document.getElementById('statsTotalTime').innerText = formatDuration(totalMins);
            document.getElementById('statsEffectiveTime').innerText = formatDuration(activeMins);
            document.getElementById('statsTagCount').innerText = tagCount;

            // 2. Charts
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            const ctxDist = document.getElementById('distChart').getContext('2d');

            // Trend: Last 7 Days Timeline (0-24h) - INCLUDE Relax (User request)
            const timelineData = [];
            const timelineColors = [];
            const dayLabels = [];

            // 1. Generate 7 days labels starting from trendStartDate
            for (let i = 0; i < 7; i++) {
                const d = new Date(trendStartDate);
                d.setDate(d.getDate() + i);
                const dayStr = d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
                dayLabels.push(dayStr);
            }

            // 2. Map sessions to timeline bars
            sessions.forEach(s => {
                const sDate = new Date(s.startTime);
                const dayStr = sDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });

                // Only include if this day is in our generated labels
                const dayIndex = dayLabels.indexOf(dayStr);
                if (dayIndex !== -1) {
                    const startDisp = sDate.getHours() + sDate.getMinutes() / 60;
                    const endDisp = startDisp + (s.duration / 60);

                    const tag = getTag(s.tagId);

                    timelineData.push({
                        x: [startDisp, endDisp],
                        y: dayStr, // Matches Y-axis label
                        tag: tag.name, // For tooltip
                        rawStart: sDate // For tooltip formatting
                    });
                    timelineColors.push(tag.color); // Color by tag
                }
            });

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctxTrend, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Activity Minutes',
                        data: timelineData,
                        backgroundColor: timelineColors,
                        borderWidth: 0,
                        barPercentage: 0.6, // Thinner bars for elegance
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    // Move Tag and Duration to Title
                                    const raw = context[0].raw;
                                    const durationHours = raw.x[1] - raw.x[0];
                                    const totalMins = Math.round(durationHours * 60);

                                    let durationStr = '';
                                    if (totalMins < 60) {
                                        durationStr = `${totalMins} minutes`;
                                    } else {
                                        const h = Math.floor(totalMins / 60);
                                        const m = totalMins % 60;
                                        durationStr = m > 0 ? `${h}h ${m}m` : `${h}h`;
                                    }
                                    return `${raw.y} · ${raw.tag} · ${durationStr}`;
                                },
                                label: function (context) {
                                    // Only show Time Range in body
                                    const raw = context.raw;
                                    const st = raw.rawStart;
                                    const itemDuration = raw.x[1] - raw.x[0];
                                    const ed = new Date(st.getTime() + itemDuration * 3600000);

                                    const formatTime = (d) => d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                                    return `${formatTime(st)} - ${formatTime(ed)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 24, // WILL BE OVERRIDDEN by slider logic immediately after
                            grid: { color: '#334155' },
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return value + ':00';
                                },
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#cbd5e1' }
                        }
                    }
                }
            });



            // 3. Distribution Chart
            renderDistChart(rangedSessions);

            // 4. History List
            loadHistorySessions(startDate, endDate);

            // 4. Set Initial Slider Position (Center on Now)
            const currentHour = new Date().getHours();
            let safeStart = currentHour - 2;
            if (safeStart < 0) safeStart = 0;
            if (safeStart > 20) safeStart = 20;

            document.getElementById('chartSlider').value = safeStart;
            onSliderChange(safeStart);
        }

        let isFullView = false;
        let lastSliderVal = 0;

        function toggleFullView() {
            if (!trendChart) return;
            const btn = document.getElementById('fullViewBtn');
            const slider = document.getElementById('chartSlider');
            const sliderContainer = document.getElementById('sliderContainer');

            isFullView = !isFullView;

            if (isFullView) {
                // Switch to Full View
                lastSliderVal = slider.value;
                trendChart.options.scales.x.min = 0;
                trendChart.options.scales.x.max = 24;
                trendChart.options.scales.x.ticks.stepSize = 4; // Less dense ticks
                trendChart.update();

                btn.classList.add('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.remove('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-compress"></i> Exit';

                sliderContainer.classList.add('opacity-50', 'pointer-events-none');
                slider.disabled = true;
            } else {
                // Restore Focus View
                trendChart.options.scales.x.min = parseInt(lastSliderVal);
                trendChart.options.scales.x.max = parseInt(lastSliderVal) + 4;
                trendChart.options.scales.x.ticks.stepSize = 1; // Detailed ticks
                trendChart.update();

                btn.classList.remove('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.add('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-expand"></i> Full View';

                sliderContainer.classList.remove('opacity-50', 'pointer-events-none');
                slider.disabled = false;
            }
        }

        function moveSlider(delta) {
            const slider = document.getElementById('chartSlider');
            let val = parseInt(slider.value) + delta;
            // Clamp
            if (val < 0) val = 0;
            if (val > 20) val = 20;

            slider.value = val;
            onSliderChange(val);
        }

        function onSliderChange(val) {
            if (isFullView) return; // Ignore if in full view
            const start = parseInt(val);
            if (trendChart) {
                trendChart.options.scales.x.min = start;
                trendChart.options.scales.x.max = start + 4; // Fixed 4h window
                trendChart.update('none'); // Efficient update works better
            }
        }

        function renderDistChart(rangedSessions) {
            const ctxDist = document.getElementById('distChart').getContext('2d');
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            const tagStats = {};
            rangedSessions.forEach(s => {
                const t = getTag(s.tagId);
                tagStats[t.name] = (tagStats[t.name] || 0) + s.duration;
            });

            const distLabels = Object.keys(tagStats);
            const distData = Object.values(tagStats);
            const distColors = distLabels.map(name => tags.find(t => t.name === name)?.color || '#ccc');

            if (distChart) distChart.destroy();

            // Handle Empty Data
            if (distData.length === 0) {
                // Maybe show a "No Data" text or empty chart? 
                // Chart.js handles empty data okay, but let's just render it.
            }

            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: distLabels,
                    datasets: [{
                        data: distData,
                        backgroundColor: distColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: ${value} minutes (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // History Filter logic is now merged into loadHistorySessions
        let currentHistorySessions = []; // Currently displayed sessions (for export)

        async function loadHistorySessions(startDate, endDate) {
            const list = document.getElementById('historyList');
            const statusEl = document.getElementById('historyStatus');

            if (!startDate || !endDate) {
                // Default fallback if called without direct range (shouldn't happen with unified logic)
                currentHistorySessions = [...sessions];
                renderHistoryItems();
                return;
            }

            // Query from database
            statusEl.textContent = 'Loading...';
            statusEl.className = 'text-xs text-amber-400';

            try {
                const result = await db.query(
                    `SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description 
                     FROM pomodoro_sessions 
                     WHERE start_time >= ? AND start_time < ? 
                     ORDER BY start_time DESC`,
                    [startDate.toISOString(), endDate.toISOString()]
                );

                if (result && result.length > 0 && result[0].values) {
                    currentHistorySessions = result[0].values.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                } else {
                    currentHistorySessions = [];
                }
            } catch (err) {
                console.error('[Pomodoro] Load History Failed:', err);
                statusEl.textContent = 'Load Failed';
                statusEl.className = 'text-xs text-rose-400';
                return;
            }

            renderHistoryItems();
        }

        function renderHistoryItems() {
            const list = document.getElementById('historyList');
            const statusEl = document.getElementById('historyStatus');

            // Calculate stats
            const totalMins = currentHistorySessions.reduce((sum, s) => sum + s.duration, 0);
            const hrs = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            const timeStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;

            statusEl.textContent = `${currentHistorySessions.length} records, total ${timeStr}`;
            statusEl.className = 'text-xs text-emerald-400';

            if (currentHistorySessions.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-slate-500">No records found</div>';
                return;
            }

            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            list.innerHTML = currentHistorySessions.map(s => {
                const tag = getTag(s.tagId);
                const date = new Date(s.startTime);
                const dateStr = date.toLocaleDateString('en-US') + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                // Status badge
                let statusBadge = '';
                let statusBorder = '';
                if (s.status === 'completed') {
                    statusBadge = '<span class="text-emerald-400 text-xs ml-1" title="Completed"><i class="fas fa-check-circle"></i></span>';
                    statusBorder = 'border-l-2 border-emerald-500';
                } else if (s.status === 'in_progress' || s.status === 'running') {
                    statusBadge = '<span class="text-yellow-400 text-[10px] ml-1 flex items-center justify-center animate-pulse-yellow" title="In Progress"><i class="fas fa-circle"></i></span>';
                    statusBorder = 'border-l-2 border-yellow-500';
                } else if (s.status === 'aborted') {
                    statusBadge = '<span class="text-rose-400 text-xs ml-1" title="Aborted"><i class="fas fa-times-circle"></i></span>';
                    statusBorder = 'border-l-2 border-rose-500';
                }

                return `
                    <div class="p-4 hover:bg-slate-700/50 transition flex items-center justify-between group ${statusBorder}">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-slate-400 font-bold shrink-0">
                                ${s.duration}
                            </div>
                            <div class="min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="w-2 h-2 rounded-full" style="background-color: ${tag.color}"></span>
                                    <span class="font-medium text-slate-200">${escapeHtml(tag.name)}</span>
                                    ${statusBadge}
                                </div>
                                ${s.title ? `<div class="text-sm text-white mb-1 break-words">${escapeHtml(s.title)}</div>` : ''}
                                ${s.description ? `<div class="text-xs text-slate-400 mb-1 break-words">${escapeHtml(s.description)}</div>` : ''}
                                <div class="text-xs text-slate-500">${dateStr}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                            <button onclick="editSession(${s.id})" class="text-slate-500 hover:text-blue-500 p-2" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSession(${s.id})" class="text-slate-500 hover:text-rose-500 p-2" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Keep old function for compatibility
        function renderHistoryList() {
            loadHistorySessions();
        }

        // Export current list to clipboard as markdown
        function exportCurrentList() {
            const excludeRelax = document.getElementById('exportExcludeRelax').checked;
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            let sessionsToExport = [...currentHistorySessions];

            // Filter out Relax if checked
            if (excludeRelax) {
                sessionsToExport = sessionsToExport.filter(s => {
                    const tagName = getTag(s.tagId).name;
                    return tagName !== 'Relax' && tagName !== 'Break' && tagName !== 'Rest';
                });
            }

            // Sort by start time ascending (chronological order for export)
            sessionsToExport.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            if (sessionsToExport.length === 0) {
                alert('No records to export');
                return;
            }

            // Generate markdown
            const lines = sessionsToExport.map(s => {
                const start = new Date(s.startTime);
                const end = new Date(s.endTime);
                const formatTime = (d) => {
                    const h = String(d.getHours()).padStart(2, '0');
                    const m = String(d.getMinutes()).padStart(2, '0');
                    return `${h}:${m}`;
                };

                const tag = getTag(s.tagId);
                const tagName = tag ? tag.name : '';
                const title = s.title || '';

                let label = '';
                if (title && tagName && title !== tagName) {
                    label = `${title} | ${tagName}`;
                } else if (title) {
                    label = title;
                } else if (tagName) {
                    label = tagName;
                }

                return ` - ${formatTime(start)} - ${formatTime(end)} ${label} (${s.duration}min)`;
            });

            const markdown = lines.join('\n');

            // Copy to clipboard
            navigator.clipboard.writeText(markdown).then(() => {
                const btn = document.querySelector('button[onclick="exportCurrentList()"]');
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                btn.classList.add('bg-emerald-600');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                }, 1500);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        async function deleteSession(id) {
            // Store session data for potential undo
            const session = sessions.find(s => s.id === id);
            if (!session) return;

            try {
                await db.execute('DELETE FROM pomodoro_sessions WHERE id = ?', [id]);

                // Show undo toast
                showUndoToast(session);
            } catch (e) {
                console.error('Delete Failed:', e);
            }
        }

        let undoTimeout = null;
        function showUndoToast(session) {
            // Remove existing toast
            const existing = document.getElementById('undoToast');
            if (existing) existing.remove();
            if (undoTimeout) clearTimeout(undoTimeout);

            const toast = document.createElement('div');
            toast.id = 'undoToast';
            toast.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-[1000] border border-slate-700/50 animate-fade-in';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </div>
                    <span class="text-sm font-medium">Activity log deleted</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="undoDelete()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold transition-all active:scale-95">Undo</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="p-2 text-slate-500 hover:text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);

            // Store session for undo
            window._deletedSession = session;

            // Auto-remove after 5 seconds
            undoTimeout = setTimeout(() => {
                toast.remove();
                window._deletedSession = null;
            }, 5000);
        }

        async function undoDelete() {
            const session = window._deletedSession;
            if (!session) return;

            try {
                await db.execute(
                    `INSERT INTO pomodoro_sessions (id, start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                    [session.id, session.startTime, session.endTime, session.duration, session.tagId, session.status, session.title || '', session.description || '', new Date().toISOString()]
                );
                window._deletedSession = null;

                const toast = document.getElementById('undoToast');
                if (toast) toast.remove();
            } catch (e) {
                console.error('Undo failed:', e);
            }
        }


        function exportData() {
            // Legacy - no longer used, keep for compatibility
        }

        // === Daily Records Export (Markdown) ===
        async function onExportDateChange() {
            const datePicker = document.getElementById('exportDatePicker');
            const statusEl = document.getElementById('exportPreviewStatus');
            const previewArea = document.getElementById('exportPreviewArea');

            if (!datePicker.value) {
                statusEl.textContent = 'Please select a date to load data';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            statusEl.textContent = 'Loading...';
            statusEl.className = 'text-xs text-amber-400 mb-2';

            await generateDailyMarkdown();
        }

        // Keep for backward compatibility
        async function openExportRecordsModal() {
            console.log('[Pomodoro] openExportRecordsModal called');
            const modal = document.getElementById('exportRecordsModal');
            const datePicker = document.getElementById('exportDatePicker');
            const statsPicker = document.getElementById('statsDatePicker');

            if (!modal || !datePicker) {
                console.error('[Pomodoro] Export modal elements not found');
                return;
            }

            // Sync with current stats view date if available
            if (statsPicker && statsPicker.value) {
                datePicker.value = statsPicker.value;
            } else if (!datePicker.value) {
                datePicker.valueAsDate = new Date();
            }

            modal.classList.remove('hidden');
            console.log('[Pomodoro] Export records modal visible');
            await onExportDateChange();
        }

        function closeExportRecordsModal() {
            document.getElementById('exportRecordsModal').classList.add('hidden');
        }

        async function generateDailyMarkdown() {
            const datePicker = document.getElementById('exportDatePicker');
            const includeRelax = document.getElementById('exportIncludeRelax').checked;
            const output = document.getElementById('exportRecordsOutput');
            const statusEl = document.getElementById('exportPreviewStatus');
            const previewArea = document.getElementById('exportPreviewArea');

            if (!datePicker.value) {
                statusEl.textContent = 'Please select a date first';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            const selectedDate = new Date(datePicker.value + 'T00:00:00');
            const nextDate = new Date(selectedDate);
            nextDate.setDate(nextDate.getDate() + 1);

            // Query database for the selected date
            let daySessions = [];
            try {
                const result = await db.query(
                    `SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description 
                     FROM pomodoro_sessions 
                     WHERE start_time >= ? AND start_time < ? 
                     ORDER BY start_time ASC`,
                    [selectedDate.toISOString(), nextDate.toISOString()]
                );

                if (result && result.length > 0 && result[0].values) {
                    daySessions = result[0].values.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                }
            } catch (err) {
                console.error('[Pomodoro] Query failed:', err);
                statusEl.textContent = 'Query failed: ' + err.message;
                statusEl.className = 'text-xs text-rose-400 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            // Filter out Relax if not included
            if (!includeRelax) {
                const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
                daySessions = daySessions.filter(s => {
                    const tagName = getTag(s.tagId).name;
                    return tagName !== 'Relax' && tagName !== 'Break' && tagName !== 'Rest';
                });
            }

            if (daySessions.length === 0) {
                statusEl.textContent = 'No records for this date';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            // Calculate total duration
            const totalMins = daySessions.reduce((sum, s) => sum + s.duration, 0);

            // Generate markdown
            const lines = daySessions.map(s => {
                const start = new Date(s.startTime);
                const end = new Date(s.endTime);
                const formatTime = (d) => {
                    const h = String(d.getHours()).padStart(2, '0');
                    const m = String(d.getMinutes()).padStart(2, '0');
                    return `${h}:${m}`;
                };

                const tag = tags.find(t => t.id === s.tagId);
                const tagName = tag ? tag.name : '';
                const title = escapeHtml(s.title || '');

                let label = '';
                if (title && tagName && title !== tagName) {
                    label = `${title} | ${tagName}`;
                } else if (title) {
                    label = title;
                } else if (tagName) {
                    label = tagName;
                }

                return ` - ${formatTime(start)} - ${formatTime(end)} ${label} (${s.duration}min)`;
            });

            output.value = lines.join('\n');

            // Update status and show preview
            statusEl.textContent = `Loaded ${daySessions.length} records, total ${totalMins} minutes`;
            statusEl.className = 'text-xs text-emerald-400 mb-2';
            previewArea.classList.remove('hidden');
        }

        function copyExportRecords() {
            const output = document.getElementById('exportRecordsOutput');
            navigator.clipboard.writeText(output.value).then(() => {
                // Show feedback
                const btn = document.querySelector('#exportRecordsModal button[onclick="copyExportRecords()"]');
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                btn.classList.add('bg-emerald-600');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                }, 1500);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function openExportPanoramaModal() {
            const modal = document.getElementById('exportPanoramaModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            generatePanoramaPreview();
        }

        function closeExportPanoramaModal() {
            document.getElementById('exportPanoramaModal').classList.add('hidden');
        }

        function generatePanoramaPreview() {
            const preview = document.getElementById('panoramaPreview');
            const headerInfo = document.getElementById('exportPanoramaHeader');

            if (!preview) return;

            // Panorama is always a 7-day view. 
            // Calculated as the week ending at statsBaseDate (inclusive)
            const endDate = new Date(statsBaseDate);
            endDate.setHours(23, 59, 59, 999);

            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            startDate.setHours(0, 0, 0, 0);

            if (headerInfo) {
                headerInfo.textContent = `Current export range: ${startDate.toLocaleDateString('en-US')} - ${endDate.toLocaleDateString('en-US')}`;
            }

            console.log('[Pomodoro] Generating panorama for range:', startDate, 'to', endDate);

            // Get all sessions in this week
            const weekSessions = sessions.filter(s => {
                const sDate = new Date(s.startTime);
                return sDate >= startDate && sDate < endDate;
            });

            if (weekSessions.length === 0) {
                preview.innerHTML = '<div class="text-center text-slate-500 py-12 bg-slate-900 border border-dashed border-slate-700 rounded-lg">No activity logs for this week</div>';
                return;
            }

            // Calculate stats
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#94a3b8' };
            const stats = {};
            let totalMins = 0;
            let dayFocusCounts = [0, 0, 0, 0, 0, 0, 0];

            weekSessions.forEach(s => {
                const tag = getTag(s.tagId);
                // Exclude Relax from main category stats for focus panorama
                if (tag.name === 'Relax' || tag.name === 'Break') return;

                if (!stats[tag.name]) {
                    stats[tag.name] = { mins: 0, color: tag.color };
                }
                stats[tag.name].mins += s.duration;
                totalMins += s.duration;

                const dayIdx = Math.floor((new Date(s.startTime) - startDate) / (86400000));
                if (dayIdx >= 0 && dayIdx < 7) dayFocusCounts[dayIdx]++;
            });

            // Build Preview HTML with refined styling
            let html = `
            <div id="panorama-container" style="background: #0f172a; padding: 48px; border-radius: 16px; font-family: 'Inter', system-ui, -apple-system, sans-serif; min-width: 1200px; color: #f8fafc; border: 1px solid #1e293b; line-height: 1.5;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 32px;">
                    <div>
                        <h2 style="margin: 0; font-size: 32px; font-weight: 800; color: #818cf8;">7-Day Activity Flow</h2>
                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 16px;">${startDate.toLocaleDateString('en-US')} - ${new Date(endDate.getTime() - 86400000).toLocaleDateString('en-US')}</p>
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                        <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; color: #475569; display: block; margin-bottom: 4px;">Weekly Continuity</span>
                        <div style="font-size: 24px; font-weight: 800; color: #f8fafc;">${((totalMins / (7 * 24 * 60)) * 100).toFixed(1)}%</div>
                    </div>
                </div>

                <!-- 7-Day Matrix / Heatmap styled Timeline -->
                <div style="background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 24px; position: relative; border: 1px solid #334155;">
                    <div style="display: flex; flex-direction: column; gap: 12px;">
            `;

            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(currentDay.getDate() + i);
                const dayLabel = currentDay.toLocaleDateString('en-US', { weekday: 'short' });
                const dateLabel = currentDay.getDate();
                const dayStr = currentDay.toDateString();

                const daySessions = weekSessions.filter(s => new Date(s.startTime).toDateString() === dayStr);
                const isToday = new Date().toDateString() === dayStr;

                html += `
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 45px; flex-shrink: 0; text-align: center;">
                        <div style="font-size: 10px; color: ${isToday ? '#f43f5e' : '#64748b'}; text-transform: uppercase; font-weight: ${isToday ? 'bold' : 'normal'}">${dayLabel}</div>
                        <div style="font-size: 14px; font-weight: bold; color: ${isToday ? '#f8fafc' : '#94a3b8'}">${dateLabel}</div>
                    </div>
                    <div style="flex: 1; height: 32px; background: #0f172a; border-radius: 6px; position: relative; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                `;

                // Sub-grid for hours
                for (let h = 1; h < 24; h++) {
                    const left = (h / 24) * 100;
                    html += `<div style="position: absolute; left: ${left}%; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.03);"></div>`;
                }

                daySessions.forEach(s => {
                    const sDate = new Date(s.startTime);
                    const startPos = (sDate.getHours() + sDate.getMinutes() / 60) / 24 * 100;
                    const widthPos = (s.duration / 60) / 24 * 100;
                    const tag = getTag(s.tagId);
                    const isRelax = tag.name === 'Relax' || tag.name === 'Break';
                    const color = isRelax ? 'rgba(71, 85, 105, 0.3)' : tag.color;

                    html += `
                    <div style="position: absolute; left: ${startPos}%; width: ${Math.max(widthPos, 0.4)}%; height: 100%; background: ${color}; border-radius: 1px; opacity: 1; ${isRelax ? '' : 'box-shadow: 0 0 8px ' + color + '44;'}"></div>
                    `;
                });

                html += `</div></div>`;
            }

            html += `
                    </div>
                    <!-- Time Markers -->
                    <div style="display: flex; justify-content: space-between; margin-top: 12px; padding-left: 61px; color: #475569; font-size: 10px; font-weight: 500;">
                        <span>0:00</span>
                        <span>4:00</span>
                        <span>8:00</span>
                        <span>12:00</span>
                        <span>16:00</span>
                        <span>20:00</span>
                        <span>24:00</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 24px;">
                    <!-- Distribution -->
                    <div style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 20px; border: 1px solid #334155;">
                        <h3 style="margin: 0 0 16px 0; font-size: 13px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em;">Project Distribution</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
            `;

            // Calculate Conic Gradient for Pie Chart (INCLUDE ALL CATEGORIES)
            const sortedStats = Object.entries(stats).sort((a, b) => b[1].mins - a[1].mins);
            let cumulativePct = 0;
            const gradientParts = [];

            sortedStats.forEach(([name, data]) => {
                const pct = totalMins > 0 ? (data.mins / totalMins * 100) : 0;
                if (pct > 0) {
                    gradientParts.push(`${data.color} ${cumulativePct}% ${cumulativePct + pct}%`);
                    cumulativePct += pct;
                }
            });

            // Re-render Distribution Section as a Pie Chart + Legend
            html += `
                <div style="display: grid; grid-template-columns: 240px 1fr; gap: 48px; align-items: center; background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 40px; border: 1px solid #334155;">
                    <!-- Pie Chart -->
                    <div style="width: 240px; height: 240px; border-radius: 50%; background: conic-gradient(${gradientParts.join(', ')}); position: relative; box-shadow: 0 0 32px rgba(0,0,0,0.4);">
                        <!-- Inner Doughnut Hole -->
                    <div style="position: absolute; inset: 50px; background: #0f172a; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; border: 1px solid #1e293b;">
                        <div style="font-size: 11px; color: #475569; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 2px;">Logged Life</div>
                        <div style="font-size: 24px; font-weight: 800; color: #f8fafc;">${(totalMins / 60).toFixed(1)}h</div>
                    </div>
                    </div>

                    <!-- Legend -->
                    <div style="display: flex; flex-direction: column; gap: 14px; max-height: 400px; overflow-y: visible;">
                        <h3 style="margin: 0 0 4px 0; font-size: 14px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em;">Activity Distribution Stats</h3>
            `;

            sortedStats.forEach(([name, data]) => {
                const pct = totalMins > 0 ? (data.mins / totalMins * 100).toFixed(0) : 0;
                const hours = (data.mins / 60).toFixed(1);
                html += `
                <div style="display: flex; align-items: center; gap: 16px; overflow: visible;">
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: ${data.color}; flex-shrink: 0; box-shadow: 0 0 8px ${data.color}44;"></div>
                    <div style="flex: 1; font-size: 15px; color: #cbd5e1; white-space: nowrap; line-height: 1; display: flex; align-items: center; overflow: visible;">
                         <span style="display: inline-flex; align-items: center;">${name}</span>
                    </div>
                    <div style="font-size: 14px; color: #64748b; font-weight: 600; min-width: 45px; text-align: right; line-height: 1;">${hours}h</div>
                    <div style="font-size: 14px; color: #475569; font-weight: 500; width: 45px; text-align: right; line-height: 1;">${pct}%</div>
                    <div style="width: 140px; height: 6px; background: #0f172a; border-radius: 3px; overflow: hidden; flex-shrink: 0;">
                        <div style="width: ${pct}%; height: 100%; background: ${data.color};"></div>
                    </div>
                </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <!-- Summary -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #334155; padding-bottom: 12px; margin-bottom: 12px;">Logged Events</div>
                        <div style="font-size: 28px; font-weight: 800; color: #818cf8;">${weekSessions.length}</div>
                    </div>
                        <div style="background: #1e293b; border-radius: 12px; padding: 24px; border: 1px solid #334155; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #334155; padding-bottom: 12px; margin-bottom: 12px;">Avg. Daily Duration</div>
                            <div style="font-size: 28px; font-weight: 800; color: #3b82f6;">${(totalMins / 7 / 60).toFixed(1)}<span style="font-size: 14px; margin-left:4px; font-weight: normal; color: #64748b;">h</span></div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            preview.innerHTML = html;
        }

        async function downloadPanoramaPNG() {
            const btn = document.querySelector('button[onclick="downloadPanoramaPNG()"]');
            const preview = document.getElementById('panorama-container'); // Capture the rendered container specifically

            if (!preview) {
                alert('Please wait for preview to generate');
                return;
            }

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            btn.disabled = true;

            try {
                const canvas = await html2canvas(preview, {
                    backgroundColor: '#0f172a',
                    scale: 2,
                    useCORS: true, // In case of external fonts/images
                    logging: false
                });

                const link = document.createElement('a');
                // Use formatted date for filename
                const pad = (n) => String(n).padStart(2, '0');
                const d = statsBaseDate || new Date();
                const dateStr = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                link.download = `lifeflow_panorama_${dateStr}_${statsMode}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link); // Ensure link is in DOM for some browsers
                link.click();
                document.body.removeChild(link);

                btn.innerHTML = '<i class="fas fa-check"></i> 已下载';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            } catch (err) {
                console.error('Panorama export error:', err);
                alert('导出失败：' + err.message);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }



        let currentEditSessionId = null;

        function editSession(id) {
            const targetId = parseInt(id);
            const session = currentHistorySessions.find(s => s.id === targetId) || sessions.find(s => s.id === targetId);

            if (!session) return;

            currentEditSessionId = targetId;

            // Format times for datetimelocal (YYYY-MM-DDTHH:mm)
            const formatForInput = (isoStr) => {
                const d = new Date(isoStr);
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            document.getElementById('editStartTime').value = formatForInput(session.startTime);
            document.getElementById('editEndTime').value = formatForInput(session.endTime);
            document.getElementById('editTitle').value = session.title || '';
            document.getElementById('editDescription').value = session.description || '';

            // Set status
            const statusSelect = document.getElementById('editStatusSelect');
            statusSelect.value = session.status || 'completed';

            // Populate tags
            const select = document.getElementById('editTagSelect');
            select.innerHTML = tags.map(t => `<option value="${t.id}" ${t.id === session.tagId ? 'selected' : ''}>${t.name}</option>`).join('');

            document.getElementById('editSessionModal').classList.remove('hidden');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').classList.add('hidden');
            currentEditSessionId = null;
        }

        async function confirmEditSession() {
            if (!currentEditSessionId) return;

            const stVal = document.getElementById('editStartTime').value;
            const etVal = document.getElementById('editEndTime').value;
            const tagId = parseInt(document.getElementById('editTagSelect').value);
            const status = document.getElementById('editStatusSelect').value;
            const title = document.getElementById('editTitle').value.trim();
            const desc = document.getElementById('editDescription').value.trim();

            if (!stVal || !etVal) {
                alert('请填写完整的时间');
                return;
            }

            const start = new Date(stVal);
            const end = new Date(etVal);

            if (end <= start) {
                alert('结束时间必须晚于开始时间');
                return;
            }

            const durationMins = Math.round((end - start) / 60000);

            try {
                await db.execute(
                    `UPDATE pomodoro_sessions SET start_time = ?, end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                    [start.toISOString(), end.toISOString(), durationMins, tagId, status, title, desc, currentEditSessionId]
                );
            } catch (e) { console.error('Update Failed:', e); }

            closeEditSessionModal();
        }

        async function initTables() {
            console.log('[Pomodoro] initTables() called');
            try {
                console.log('[Pomodoro] Creating pomodoro_tags table...');
                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_tags (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        color TEXT NOT NULL,
                        is_default INTEGER DEFAULT 0
                    )
                `);

                // Tags Check
                console.log('[Pomodoro] Checking if tags exist...');
                const countRes = await db.query("SELECT COUNT(*) FROM pomodoro_tags");
                console.log('[Pomodoro] Tag count result:', countRes);
                if (countRes && countRes[0].values[0][0] === 0) {
                    console.log('[Pomodoro] No tags found, inserting defaults...');
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Work', '#3b82f6', 1)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Study', '#a855f7', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Workout', '#e11d48', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Relax', '#10b981', 0)");
                    console.log('[Pomodoro] Default tags inserted');
                } else {
                    console.log('[Pomodoro] Tags already exist, count:', countRes[0].values[0][0]);
                }

                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_sessions (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        start_time TEXT NOT NULL,
                        end_time TEXT NOT NULL,
                        duration_minutes INTEGER NOT NULL,
                        tag_id INTEGER,
                        status TEXT,
                        title TEXT,
                        description TEXT,
                        created_at TEXT NOT NULL
                    )
                `);

                tablesInitialized = true;
                console.log('[LifeFlow] Tables initialized');

                // Ensure default tags exist
                await createDefaultTags();

            } catch (err) {
                console.error('Init Tables Failed:', err);
            }
        }

        // === File Permission & Sync Functions ===
        let lastSyncFailed = false;
        let syncFailAlertShown = false;

        function updateSyncStatus(success, message = '') {
            if (success) {
                lastSyncFailed = false;
                syncFailAlertShown = false;
            } else {
                lastSyncFailed = true;
                // Show alert only once per failure sequence
                if (message && !syncFailAlertShown) {
                    syncFailAlertShown = true;
                    console.warn('[Pomodoro] Sync failed:', message);
                    // Show a non-blocking toast warning
                    showSyncWarningToast(message);
                }
            }
        }

        function showSyncWarningToast(message) {
            // Remove existing toast if any
            const existingToast = document.getElementById('sync-warning-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'sync-warning-toast';
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-amber-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:text-amber-200">&times;</button>
            `;
            document.body.appendChild(toast);
            // Auto-remove after 8 seconds
            setTimeout(() => toast.remove(), 8000);
        }

        // Handle database updates - ALL pages save to IDB immediately
        db.on('db_updated', async () => {
            console.log('[Pomodoro] DB Updated, saving to IDB...');
            try {
                const data = await db.export();
                await db.saveSnapshotToIDB(data);
                console.log('[Pomodoro] Saved to IDB');
            } catch (err) {
                console.error('[Pomodoro] IDB Save Error:', err);
            }
        });

        // Handle periodic file sync (only when this page is the writer)
        db.on('sync_to_file', async () => {
            console.log('[Pomodoro] Syncing to file...');
            try {
                const snapshot = await db.loadSnapshotFromIDB();
                if (snapshot?.handle) {
                    const data = await db.export();
                    if (await db.ensureFilePermission(snapshot.handle)) {
                        const writable = await snapshot.handle.createWritable();
                        await writable.write(data);
                        await writable.close();
                        console.log('[Pomodoro] ✅ Synced to file:', snapshot.handle.name);
                        updateSyncStatus(true);
                    } else {
                        // Permission requires user gesture - this is expected during auto-sync
                        // Data is still saved to IndexedDB, just not synced to file
                        if (!window._filePermWarnShown) {
                            console.log('[Pomodoro] File sync paused (requires user interaction to grant permission)');
                            window._filePermWarnShown = true;
                        }
                    }
                }
            } catch (err) {
                console.error('[Pomodoro] File sync error:', err);
                updateSyncStatus(false, '文件同步失败');
            }
        });

        // Listen for writer status changes
        db.on('writer_changed', async (data) => {
            console.log('[Pomodoro] Writer status changed:', data?.isWriter ? 'I am now the writer' : 'No longer writer');
            if (data?.isWriter) {
                const snapshot = await db.loadSnapshotFromIDB();
                if (snapshot?.handle) {
                    const hasPerm = await db.ensureFilePermission(snapshot.handle);
                    updateSyncStatus(hasPerm, hasPerm ? null : '需授权');
                }
                // Start periodic file sync (every 10 seconds)
                db.startPeriodicSync(10000);
            }
        });

        // Startup: Load from IDB or wait for db_opened
        console.log('[Pomodoro] Setting up startup, db.isOpen =', db.isOpen);

        let initCalled = false;

        db.on('db_opened', () => {
            if (initCalled) return;
            initCalled = true;
            console.log('[Pomodoro] db_opened event received, calling init()...');
            init();
            db.claimWriter();
        });

        if (db.isOpen) {
            initCalled = true;
            console.log('[Pomodoro] DB already open, calling init() immediately...');
            init();
            db.claimWriter();
        } else {
            console.log('[Pomodoro] DB not open, waiting for worker ready...');

            // Wait for worker ready, then load from IDB
            const tryLoadFromIDB = async () => {
                if (initCalled) return;
                console.log('[Pomodoro] Worker ready, trying to load from IDB...');
                try {
                    const snapshot = await db.loadSnapshotFromIDB();
                    if (initCalled) return;
                    if (snapshot && snapshot.data) {
                        console.log('[Pomodoro] Found IDB snapshot, initializing DB...');
                        await db.init(snapshot.data);
                        // db_opened event will be fired by the worker
                    } else {
                        console.error('[Pomodoro] No database found in IDB!');
                        alert('数据库未找到！请先在主页 Settings 中打开数据库文件。\n\nNo database found! Please open a database file in Settings first.');
                    }
                } catch (err) {
                    console.error('[Pomodoro] Failed to load from IDB:', err);
                    alert('数据库加载失败！\n\nFailed to load database!');
                }
            };

            if (db.isReady) {
                console.log('[Pomodoro] Worker already ready, trying IDB...');
                tryLoadFromIDB();
            } else {
                db.on('ready', () => {
                    console.log('[Pomodoro] Got ready event, trying IDB...');
                    tryLoadFromIDB();
                });
                // Double check in case ready event was already fired
                setTimeout(() => {
                    if (db.isReady && !initCalled) {
                        console.log('[Pomodoro] Late ready check, trying IDB...');
                        tryLoadFromIDB();
                    }
                }, 100);
            }
        }


        // Expose to window for HTML events
        window.toggleTagMenu = toggleTagMenu;
        window.toggleSaveTagMenu = toggleSaveTagMenu;
        window.selectSaveTag = selectSaveTag;
        window.openAddTagModal = openAddTagModal;
        window.closeAddTagModal = closeAddTagModal;
        window.selectTag = selectTag;
        window.confirmAddTag = confirmAddTag;
        window.openStats = openStats;
        window.closeStats = closeStats;
        window.toggleFullView = toggleFullView;
        window.onSliderChange = onSliderChange;
        window.exportData = exportData;
        window.editSession = editSession;
        window.closeEditSessionModal = closeEditSessionModal;
        window.confirmEditSession = confirmEditSession;
        window.deleteSession = deleteSession;
        window.undoDelete = undoDelete;
        window.askCustomDuration = askCustomDuration;
        window.closeCustomDuration = closeCustomDuration;
        window.adjustCustomInput = adjustCustomInput;
        window.confirmCustomDuration = confirmCustomDuration;
        window.confirmSaveSession = confirmSaveSession;
        window.openTagsManagement = openTagsManagement;
        window.closeTagsManagement = closeTagsManagement;
        window.editTag = editTag;
        window.confirmDeleteTag = confirmDeleteTag;
        window.setDuration = setDuration;
        window.setStatsRange = setStatsRange;
        window.exportCurrentList = exportCurrentList;
        window.moveSlider = moveSlider;
        window.openExportRecordsModal = openExportRecordsModal;
        window.onExportDateChange = onExportDateChange;
        window.closeExportRecordsModal = closeExportRecordsModal;
        window.copyExportRecords = copyExportRecords;
        window.openExportPanoramaModal = openExportPanoramaModal;
        window.closeExportPanoramaModal = closeExportPanoramaModal;
        window.downloadPanoramaPNG = downloadPanoramaPNG;
        window.switchTab = switchTab;
        window.submitQuickLog = submitQuickLog;

        // === Immediate UI Init ===
        console.log('[Pomodoro] Executing immediate UI init...');
        setDuration(25);
        // History filter is now button-based, default is 'today' (set in setHistoryFilter)

    </script>
</body>

</html>