<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HIIT Jump Rope Timer</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- sql.js for SQLite in browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Custom Components -->
    <script type="module" src="js/components.js"></script>
    <!-- Global Styles -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 自定义过渡动画 */
        body {
            transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear, stroke 0.8s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* 脉冲动画 - 用于准备阶段 */
        @keyframes pulse-text {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(0.95);
            }
        }

        .animate-pulse-custom {
            animation: pulse-text 1.5s infinite;
        }

        /* 当前活动段 - 绿色发光 */
        .active-segment-glow {
            box-shadow: 0 0 30px rgba(34, 197, 94, 1), 0 0 60px rgba(34, 197, 94, 0.4), inset 0 0 12px rgba(255, 255, 255, 0.25);
            z-index: 20;
            transform: scaleY(1.25);
            border-color: rgba(34, 197, 94, 1) !important;
            background-color: rgba(34, 197, 94, 0.15) !important;
        }

        /* 已完成段 - 纯绿色填充 */
        .segment-completed {
            opacity: 1 !important;
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.7) 0%, rgba(22, 163, 74, 0.6) 100%) !important;
            border-color: rgba(34, 197, 94, 0.8) !important;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 8px rgba(34, 197, 94, 0.3);
        }

        /* 未开始的段 - 深灰低调 */
        .segment-pending {
            opacity: 0.3;
            background-color: rgba(255, 255, 255, 0.02) !important;
            border-color: rgba(255, 255, 255, 0.06) !important;
        }

        @keyframes segment-pulse {

            0%,
            100% {
                filter: brightness(1) drop-shadow(0 0 12px rgba(34, 197, 94, 0.8));
            }

            50% {
                filter: brightness(1.25) drop-shadow(0 0 20px rgba(34, 197, 94, 1));
            }
        }

        .segment-pulsing {
            animation: segment-pulse 0.6s ease-in-out infinite;
        }

        /* 段内倒计时数字 - 当前段 */
        .segment-countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow:
                -1px -1px 0 #0f172a,
                1px -1px 0 #0f172a,
                -1px 1px 0 #0f172a,
                1px 1px 0 #0f172a,
                0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .active-segment-glow .segment-countdown {
            opacity: 1;
        }

        /* 已完成段的勾号 */
        .segment-completed .segment-countdown {
            font-size: 0.85rem;
            color: rgba(52, 211, 153, 1);
            text-shadow: 0 0 8px rgba(52, 211, 153, 0.6);
            opacity: 1;
        }

        /* Theme-aware Phase Backgrounds */
        /* Default (Light Mode) - Soft Pastels */
        .bg-phase-setup {
            background-color: #f8fafc;
        }

        /* Slate 50 */
        .bg-phase-work {
            background-color: #e0e7ff;
        }

        /* Indigo 100 */
        .bg-phase-rest {
            background-color: #dcfce7;
        }

        /* Emerald 100 */
        .bg-phase-ready {
            background-color: #ffedd5;
        }

        /* Orange 100 */

        /* Dark Mode - Immersive Deep tones */
        :root.dark .bg-phase-setup {
            background-color: #0f172a;
        }

        /* Slate 900 */
        :root.dark .bg-phase-work {
            background-color: #1e1b4b;
        }

        /* Indigo 950 */
        :root.dark .bg-phase-rest {
            background-color: #064e3b;
        }

        /* Emerald 950 */
        :root.dark .bg-phase-ready {
            background-color: #431407;
        }

        /* Orange 950 */
    </style>
</head>

<body
    class="bg-phase-setup dark:bg-slate-900 text-slate-800 dark:text-white font-sans h-screen overflow-hidden flex select-none transition-colors duration-300">

    <local-sidebar></local-sidebar>

    <div class="flex-1 flex flex-col min-w-0 relative">
        <!-- 顶部导航/标题 -->
        <local-header title="HIIT Jump Rope">
            <i slot="icon" class="fas fa-stopwatch text-indigo-500 dark:text-white"></i>
            <div slot="actions" class="flex items-center gap-2">
                <button id="resetBtn"
                    class="hidden text-sm bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition border border-white/10">
                    <i class="fas fa-redo-alt mr-1"></i> Reset
                </button>
                <button id="statsBtn"
                    class="text-base bg-slate-100 hover:bg-slate-200 dark:bg-white/10 dark:hover:bg-white/20 text-slate-700 dark:text-white px-4 py-2 rounded-full transition ml-2 border border-slate-200 dark:border-white/10">
                    <i class="fas fa-chart-line mr-1"></i> Stats
                </button>
            </div>
        </local-header>

        <div class="flex-1 overflow-y-auto">
            <!-- Main Content -->
            <main class="flex-grow flex flex-col relative w-full max-w-2xl mx-auto px-6 pb-8">

                <!-- 1. Setup Screen -->
                <div id="setupScreen" class="w-full space-y-6 animate-fade-in py-6 max-w-md mx-auto">
                    <div class="text-center space-y-2">
                        <h2 class="text-3xl font-bold tracking-tight text-slate-900 dark:text-white">Jump Master</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Optimize your HIIT performance</p>
                    </div>

                    <div class="space-y-4">
                        <!-- 运动时间 -->
                        <div
                            class="bg-white dark:bg-slate-800/50 backdrop-blur-md p-5 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm dark:shadow-none">
                            <label
                                class="flex justify-between text-indigo-600 dark:text-indigo-300 font-bold mb-3 uppercase text-xs tracking-wider">
                                <span><i class="fas fa-fire-alt mr-2"></i>Jump Interval</span>
                                <span id="workDisplay"
                                    class="bg-indigo-100 dark:bg-indigo-500/20 px-2 py-0.5 rounded text-indigo-600 dark:text-indigo-400">60s</span>
                            </label>
                            <div class="flex items-center gap-4">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="workInput" data-delta="-5">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="range" id="workInput" min="30" max="90" step="5" value="60"
                                    class="flex-1 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="workInput" data-delta="5">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 休息时间 -->
                        <div
                            class="bg-white dark:bg-slate-800/50 backdrop-blur-md p-5 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm dark:shadow-none">
                            <label
                                class="flex justify-between text-emerald-600 dark:text-emerald-300 font-bold mb-3 uppercase text-xs tracking-wider">
                                <span><i class="fas fa-coffee mr-2"></i>Rest Interval</span>
                                <span id="restDisplay"
                                    class="bg-emerald-100 dark:bg-emerald-500/20 px-2 py-0.5 rounded text-emerald-600 dark:text-emerald-400">45s</span>
                            </label>
                            <div class="flex items-center gap-4">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="restInput" data-delta="-5">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="range" id="restInput" min="30" max="90" step="5" value="45"
                                    class="flex-1 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="restInput" data-delta="5">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- 轮数 -->
                            <div
                                class="bg-white dark:bg-slate-800/50 backdrop-blur-md p-5 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm dark:shadow-none">
                                <label
                                    class="block text-blue-600 dark:text-blue-300 font-bold mb-3 uppercase text-xs tracking-wider">Rounds</label>
                                <div class="flex items-center justify-between">
                                    <button type="button"
                                        class="adjust-btn w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                        data-target="roundsInput" data-delta="-1">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <span id="roundsDisplay"
                                        class="text-xl font-black text-slate-900 dark:text-white">7</span>
                                    <button type="button"
                                        class="adjust-btn w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                        data-target="roundsInput" data-delta="1">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <input type="range" id="roundsInput" min="1" max="15" step="1" value="7" class="hidden">
                            </div>
                            <!-- 体重 -->
                            <div
                                class="bg-white dark:bg-slate-800/50 backdrop-blur-md p-5 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm dark:shadow-none">
                                <label
                                    class="block text-purple-600 dark:text-purple-300 font-bold mb-3 uppercase text-xs tracking-wider">Weight</label>
                                <div class="flex items-center justify-between">
                                    <button type="button"
                                        class="adjust-btn w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                        data-target="weightInput" data-delta="-1">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <span id="weightDisplay"
                                        class="text-lg font-black text-slate-900 dark:text-white">70<span
                                            class="text-xs ml-0.5">kg</span></span>
                                    <button type="button"
                                        class="adjust-btn w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                        data-target="weightInput" data-delta="1">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <input type="range" id="weightInput" min="40" max="120" step="1" value="70"
                                    class="hidden">
                            </div>
                        </div>

                        <!-- 目标配速 (Pace) -->
                        <div
                            class="bg-white dark:bg-slate-800/50 backdrop-blur-md p-5 rounded-3xl border border-slate-200 dark:border-slate-700/50 shadow-sm dark:shadow-none">
                            <label
                                class="flex justify-between text-lime-600 dark:text-lime-400 font-bold mb-3 uppercase text-xs tracking-wider">
                                <span><i class="fas fa-tachometer-alt mr-2"></i>Target Pace (Jumps/Min)</span>
                                <span id="paceDisplay"
                                    class="bg-lime-100 dark:bg-lime-500/20 px-2 py-0.5 rounded text-lime-600 dark:text-lime-400">140
                                    JPM</span>
                            </label>
                            <div class="flex items-center gap-4">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="paceInput" data-delta="-10">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="range" id="paceInput" min="100" max="180" step="10" value="140"
                                    class="flex-1 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-lime-500">
                                <button type="button"
                                    class="adjust-btn w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 flex items-center justify-center transition text-slate-600 dark:text-white"
                                    data-target="paceInput" data-delta="10">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button id="startBtn"
                            class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-2xl transform transition active:scale-[0.98] text-xl uppercase tracking-widest">
                            Start Session
                        </button>
                        <p
                            class="text-center text-[10px] text-slate-600 dark:text-slate-500 mt-4 uppercase tracking-[0.2em]">
                            Est. Duration:
                            <span id="totalTimeDisplay">08:00</span>
                        </p>
                    </div>
                </div>

                <!-- 2. Timer Screen -->
                <div id="timerScreen"
                    class="hidden flex-col items-center justify-center w-full min-h-[calc(100vh-120px)] relative overflow-hidden">

                    <!-- 状态标签 -->
                    <div class="absolute top-4 text-center z-10">
                        <div id="phaseText"
                            class="text-5xl font-black uppercase tracking-[0.3em] drop-shadow-2xl text-slate-800 dark:text-white">
                            GET
                            READY</div>
                        <div
                            class="text-sm font-bold mt-2 uppercase tracking-widest text-slate-800 dark:text-slate-300">
                            Round <span id="currentRoundDisplay" class="text-slate-900 dark:text-white">1</span> of
                            <span id="totalRoundsDisplay">8</span>
                        </div>
                    </div>

                    <!-- 闪烁背景层 -->
                    <div id="flashOverlay"
                        class="fixed inset-0 bg-white/20 opacity-0 pointer-events-none z-[5] transition-opacity duration-75">
                    </div>

                    <!-- 圆形进度条容器 -->
                    <div class="relative w-80 h-80 flex items-center justify-center z-10 -mt-16">
                        <svg class="progress-ring w-full h-full" viewBox="0 0 120 120">
                            <circle class="text-slate-200 dark:text-white/5" stroke-width="6" stroke="currentColor"
                                fill="transparent" r="54" cx="60" cy="60" />
                            <circle id="progressCircle" class="progress-ring__circle text-slate-800 dark:text-white"
                                stroke-width="6" stroke-linecap="round" stroke="currentColor" fill="transparent" r="54"
                                cx="60" cy="60" />
                        </svg>

                        <!-- 中间的大数字 -->
                        <div class="absolute inset-0 flex flex-col items-center justify-center pt-4">
                            <span id="timerDisplay"
                                class="text-6xl font-black font-mono tabular-nums tracking-tighter drop-shadow-2xl text-slate-900 dark:text-white leading-none">00:00</span>
                            <button id="toggleBtn"
                                class="mt-4 bg-slate-900/5 hover:bg-slate-900/10 dark:bg-white/10 dark:hover:bg-white/20 backdrop-blur-xl border border-slate-900/10 dark:border-white/20 rounded-full w-14 h-14 flex items-center justify-center transition active:scale-90 text-slate-900 dark:text-white">
                                <i id="toggleIcon" class="fas fa-pause text-xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 下一阶段提示 -->
                    <div class="absolute bottom-32 text-center z-10 text-slate-700 dark:text-white">
                        <p class="text-[10px] uppercase tracking-[0.3em] mb-1 font-bold">Coming Up</p>
                        <p id="nextPhaseText"
                            class="font-black text-xl uppercase tracking-widest text-slate-800 dark:text-white">JUMP</p>
                    </div>
                </div>

                <!-- 3. Summary Screen -->
                <div id="summaryScreen" class="hidden w-full max-w-md mx-auto animate-fade-in py-6"> </div>

                <!-- 3. Complete Screen -->
                <div id="completeScreen"
                    class="hidden flex-col items-center justify-center text-center space-y-6 min-h-[calc(100vh-120px)] py-8">
                    <div class="text-6xl text-yellow-400 animate-bounce">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h2 class="text-4xl font-bold text-slate-800 dark:text-white">Workout Complete!</h2>
                    <p class="text-lg text-slate-600 dark:text-slate-200">Great job!</p>

                    <!-- 训练统计 -->
                    <div class="w-full max-w-xs space-y-3 mt-4">
                        <div
                            class="bg-white dark:bg-white/10 backdrop-blur-sm rounded-xl p-4 flex justify-between items-center shadow-sm dark:shadow-none border border-slate-200 dark:border-transparent">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-indigo-500/10 dark:bg-indigo-500/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-indigo-600 dark:text-indigo-400"></i>
                                </div>
                                <span class="text-slate-600 dark:text-slate-300">Jump Time</span>
                            </div>
                            <span id="finalWorkTime"
                                class="text-xl font-bold text-indigo-600 dark:text-indigo-400">00:00</span>
                        </div>
                        <div
                            class="bg-white dark:bg-white/10 backdrop-blur-sm rounded-xl p-4 flex justify-between items-center shadow-sm dark:shadow-none border border-slate-200 dark:border-transparent">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 bg-orange-500/10 dark:bg-orange-500/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-fire text-orange-600 dark:text-orange-400"></i>
                                </div>
                                <span class="text-slate-600 dark:text-slate-300">Calories Burned</span>
                            </div>
                            <span id="finalCalories" class="text-xl font-bold text-orange-600 dark:text-orange-400">0
                                kcal</span>
                        </div>
                    </div>

                    <button id="homeBtn"
                        class="mt-6 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold py-3 px-8 rounded-full shadow hover:bg-slate-800 dark:hover:bg-slate-100 transition"
                        onclick="openStats()">
                        Close
                    </button>
                </div>

            </main>
        </div>

        <!-- 配速进度条 (Pace Progress) - Move to main wrapper, absolute positioning -->
        <div id="paceContainer"
            class="absolute bottom-0 left-0 right-0 bg-black/60 backdrop-blur-2xl border-t border-white/10 p-4 pb-8 hidden z-50 animate-slide-up">
            <div class="w-full">
                <div class="flex justify-between items-end mb-3 px-2">
                    <div class="space-y-0.5">
                        <span class="text-[10px] font-black uppercase tracking-[0.2em] text-lime-400">Rhythm
                            Pacer</span>
                        <p class="text-xs text-white/50">Maintain <span id="segmentSeconds"
                                class="text-lime-400 font-bold">0.0</span>s per 10 jumps</p>
                    </div>
                    <div class="text-right">
                        <span id="paceJumpCount" class="text-4xl font-black text-white leading-none">0</span>
                        <span class="text-[10px] font-black text-lime-400 uppercase ml-1">Jumps</span>
                    </div>
                </div>
                <div id="paceSegments" class="flex gap-1 h-12">
                    <!-- Segments -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div id="statsOverlay"
        class="fixed inset-0 bg-slate-50 dark:bg-slate-900 z-[60] hidden overflow-y-auto transition-colors duration-300">
        <div class="max-w-4xl mx-auto px-4 py-8 text-slate-900 dark:text-white">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Training Stats</h2>
                <button onclick="closeStats()"
                    class="px-4 py-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 rounded-lg transition text-sm font-medium">
                    Close
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 text-center border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                    <div class="text-3xl font-bold text-rose-500 dark:text-rose-400" id="statTotalWorkouts">0</div>
                    <div class="text-slate-500 dark:text-slate-400 text-sm mt-1">Total Workouts</div>
                </div>
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 text-center border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                    <div class="text-3xl font-bold text-orange-500 dark:text-orange-400" id="statTotalCalories">0</div>
                    <div class="text-slate-500 dark:text-slate-400 text-sm mt-1">Total Calories</div>
                </div>
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 text-center border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                    <div class="text-3xl font-bold text-emerald-500 dark:text-emerald-400" id="statTotalTime">0</div>
                    <div class="text-slate-500 dark:text-slate-400 text-sm mt-1">Total Time (min)</div>
                </div>
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 text-center border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                    <div class="text-3xl font-bold text-blue-500 dark:text-blue-400" id="statAvgCalories">0</div>
                    <div class="text-slate-500 dark:text-slate-400 text-sm mt-1">Avg Calories</div>
                </div>
            </div>

            <!-- Chart -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl p-6 mb-8 border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Trend (Last 30 Days)</h2>
                    <div class="bg-slate-100 dark:bg-slate-700/50 p-1 rounded-lg flex text-xs">
                        <button onclick="renderChart('calories')" id="chartMetricCal"
                            class="px-3 py-1 rounded-md bg-white dark:bg-slate-600 text-slate-800 dark:text-white shadow transition">Calories</button>
                        <button onclick="renderChart('duration')" id="chartMetricTime"
                            class="px-3 py-1 rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition">Duration</button>
                    </div>
                </div>
                <div class="overflow-x-auto pb-4">
                    <div class="h-64 min-w-[600px]" id="chartContainer">
                        <canvas id="caloriesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats List -->
            <div
                class="bg-white dark:bg-slate-800 rounded-xl p-6 border border-slate-200 dark:border-transparent shadow-sm dark:shadow-none">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Stats</h2>
                    <button onclick="exportDatabase()"
                        class="text-xs text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white">
                        <i class="fas fa-download mr-1"></i> Export Data
                    </button>
                </div>
                <div id="statsList" class="space-y-3">
                    <div class="text-center text-slate-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl"></i>
                        <p class="mt-2">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[70] hidden flex items-center justify-center">
        <div
            class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl m-4 text-slate-900 dark:text-white">
            <h3 class="text-xl font-bold mb-4">Edit Workout</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Date & Time</label>
                    <input type="datetime-local" id="edit-date"
                        class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Rounds</label>
                        <input type="number" id="edit-rounds"
                            class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Calories</label>
                        <input type="number" id="edit-cals"
                            class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Work (s)</label>
                        <input type="number" id="edit-work"
                            class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Rest (s)</label>
                        <input type="number" id="edit-rest"
                            class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-slate-500 dark:text-slate-400 mb-1">Weight (kg)</label>
                    <input type="number" id="edit-weight" step="0.1"
                        class="w-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 text-slate-900 dark:text-white">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEditModal()"
                    class="px-4 py-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">Cancel</button>
                <button onclick="saveEdit()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/db-client.js';

        // === 状态管理 ===
        const state = {
            phase: 'setup', // setup, getReady, work, rest, paused, finished

            workTime: 60,
            restTime: 45,
            totalRounds: 7,
            currentRound: 1,
            timeLeft: 0,
            intervalId: null,
            isPaused: false,
            audioContext: null,
            weight: 70,
            pace: 140,
            totalWorkTime: 0, // 累计运动时间（秒）
            startTime: null,  // 实际开始时间
            endTime: null,    // 实际结束时间
            paceTimeElapsed: 0, // 当前10次跳绳周期已过时间
            currentPaceSegment: 0 // 当前是第几个10次
        };

        // === IDB Constants (moved to db-client.js) ===


        // === DOM 元素 ===
        const els = {
            body: document.body,
            setupScreen: document.getElementById('setupScreen'),
            timerScreen: document.getElementById('timerScreen'),
            completeScreen: document.getElementById('completeScreen'),

            // Inputs
            workInput: document.getElementById('workInput'),
            restInput: document.getElementById('restInput'),
            roundsInput: document.getElementById('roundsInput'),
            weightInput: document.getElementById('weightInput'),
            paceInput: document.getElementById('paceInput'),

            // Displays
            workDisplay: document.getElementById('workDisplay'),
            restDisplay: document.getElementById('restDisplay'),
            roundsDisplay: document.getElementById('roundsDisplay'),
            weightDisplay: document.getElementById('weightDisplay'),
            paceDisplay: document.getElementById('paceDisplay'),
            totalTimeDisplay: document.getElementById('totalTimeDisplay'),

            // Complete Screen Stats
            finalWorkTime: document.getElementById('finalWorkTime'),
            finalCalories: document.getElementById('finalCalories'),

            // Timer UI
            timerDisplay: document.getElementById('timerDisplay'),
            phaseText: document.getElementById('phaseText'),
            currentRoundDisplay: document.getElementById('currentRoundDisplay'),
            totalRoundsDisplay: document.getElementById('totalRoundsDisplay'),
            progressCircle: document.getElementById('progressCircle'),
            nextPhaseText: document.getElementById('nextPhaseText'),
            toggleIcon: document.getElementById('toggleIcon'),
            flashOverlay: document.getElementById('flashOverlay'),
            paceContainer: document.getElementById('paceContainer'),
            paceSegments: document.getElementById('paceSegments'),
            paceJumpCount: document.getElementById('paceJumpCount'),
            segmentSeconds: document.getElementById('segmentSeconds'),

            // Buttons
            startBtn: document.getElementById('startBtn'),
            toggleBtn: document.getElementById('toggleBtn'),
            resetBtn: document.getElementById('resetBtn'),
            homeBtn: document.getElementById('homeBtn'),
            statsBtn: document.getElementById('statsBtn'),
            statsOverlay: document.getElementById('statsOverlay')
        };

        // === 圆环设置 ===
        const radius = 52;
        const circumference = 2 * Math.PI * radius;
        els.progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        els.progressCircle.style.strokeDashoffset = circumference;

        // === 声音控制 (简单的振荡器) ===
        const playBeep = (type = 'normal') => {
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }

            const oscillator = state.audioContext.createOscillator();
            const gainNode = state.audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(state.audioContext.destination);

            if (type === 'high') { // 结束/开始的长音
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, state.audioContext.currentTime); // A5
                gainNode.gain.setValueAtTime(0.1, state.audioContext.currentTime);
                oscillator.start();
                oscillator.stop(state.audioContext.currentTime + 0.6);
            } else { // 倒计时的短音
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(660, state.audioContext.currentTime); // E5
                gainNode.gain.setValueAtTime(0.1, state.audioContext.currentTime);
                oscillator.start();
                oscillator.stop(state.audioContext.currentTime + 0.1);
            }
        };

        // === 辅助函数 ===
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        };

        const calculateTotalTime = () => {
            const w = parseInt(els.workInput.value);
            const r = parseInt(els.restInput.value);
            const rounds = parseInt(els.roundsInput.value);
            // 总时间 = (工作+休息) * 轮数 - 最后一轮不需要休息
            const totalSecs = (w + r) * rounds - r;
            els.totalTimeDisplay.innerText = formatTime(totalSecs > 0 ? totalSecs : 0);
        };

        const setProgress = (percent) => {
            const offset = circumference - (percent / 100) * circumference;
            els.progressCircle.style.strokeDashoffset = offset;
        };

        const updateColors = (phase) => {
            // Remove all phase classes first
            els.body.classList.remove('bg-phase-setup', 'bg-phase-work', 'bg-phase-rest', 'bg-phase-ready');

            // Re-apply global theme setup class if phase is setup or finished
            if (phase === 'setup' || phase === 'finished') {
                els.body.classList.add('bg-phase-setup');
            } else if (phase === 'work') {
                els.body.classList.add('bg-phase-work');
            } else if (phase === 'rest') {
                els.body.classList.add('bg-phase-rest');
            } else if (phase === 'getReady') {
                els.body.classList.add('bg-phase-ready');
            }
        };

        // === 核心逻辑 ===

        const startTimer = () => {
            if (state.intervalId) clearInterval(state.intervalId);
            state.isPaused = false;
            els.toggleIcon.className = 'fas fa-pause';

            let lastTime = Date.now();

            state.intervalId = setInterval(() => {
                if (state.isPaused) {
                    lastTime = Date.now(); // 防止暂停时时间跳跃
                    return;
                }

                const now = Date.now();
                const delta = (now - lastTime) / 1000;
                lastTime = now;

                if (state.timeLeft > 0) {
                    state.timeLeft -= delta;

                    // 累计运动时间（只在运动阶段累计）
                    if (state.phase === 'work') {
                        state.totalWorkTime += delta;
                        updatePaceProgress(delta);
                    }

                    // 音效逻辑：最后3秒，且是整数秒附近
                    const ceilTime = Math.ceil(state.timeLeft);
                    if (state.timeLeft <= 3.1 && state.timeLeft > 0) {
                        // 简单的去抖动检查，防止一秒响多次
                        const prevCeil = Math.ceil(state.timeLeft + delta);
                        if (ceilTime !== prevCeil) {
                            playBeep('normal');
                        }
                    }

                } else {
                    // 时间到，切换阶段
                    playBeep('high');
                    switchPhase();
                }

                updateTimerUI();
            }, 100); // 100ms 更新一次UI，保证圆环流畅
        };

        const initPaceSegments = () => {
            if (state.pace <= 0) {
                els.paceContainer.classList.add('hidden');
                return;
            }
            els.paceContainer.classList.remove('hidden');
            els.paceSegments.innerHTML = '';

            const segmentDuration = 600 / state.pace;
            els.segmentSeconds.innerText = segmentDuration.toFixed(1);

            // 计算总共需要跳多少个10次
            const totalSegments = Math.floor(state.workTime * (state.pace / 60) / 10);

            for (let i = 0; i < totalSegments; i++) {
                const segment = document.createElement('div');
                segment.className = 'flex-1 bg-white/10 rounded-lg overflow-hidden relative border border-white/15 transition-all duration-300 segment-pending';
                segment.id = `pace-segment-${i}`;

                const progress = document.createElement('div');
                progress.className = 'absolute inset-0 bg-gradient-to-r from-emerald-400 via-green-400 to-emerald-500 w-0 transition-all duration-100 shadow-[0_0_20px_rgba(34,197,94,0.5)]';
                progress.id = `pace-seg-progress-${i}`;
                segment.appendChild(progress);

                // 添加倒计时数字显示
                const countdown = document.createElement('span');
                countdown.className = 'segment-countdown';
                countdown.id = `pace-seg-countdown-${i}`;
                countdown.innerText = '';
                segment.appendChild(countdown);

                els.paceSegments.appendChild(segment);
            }

            state.paceTimeElapsed = 0;
            state.currentPaceSegment = 0;
            state.segmentDuration = segmentDuration; // 保存以便在updatePaceProgress中使用
            els.paceJumpCount.innerText = '0';
        };

        const updatePaceProgress = (delta) => {
            if (state.pace <= 0) return;

            const segmentDuration = state.segmentDuration || (600 / state.pace); // 每10次的秒数
            state.paceTimeElapsed += delta;

            const currentSegment = Math.floor(state.paceTimeElapsed / segmentDuration);
            const segmentTimeElapsed = state.paceTimeElapsed % segmentDuration;
            const segmentProgress = segmentTimeElapsed / segmentDuration;
            const segmentTimeRemaining = segmentDuration - segmentTimeElapsed;

            // 更新当前段的进度和效果
            const segmentEl = document.getElementById(`pace-segment-${currentSegment}`);
            const progressEl = document.getElementById(`pace-seg-progress-${currentSegment}`);
            const countdownEl = document.getElementById(`pace-seg-countdown-${currentSegment}`);

            if (progressEl) {
                progressEl.style.width = `${segmentProgress * 100}%`;
            }
            if (segmentEl) {
                segmentEl.classList.add('active-segment-glow', 'segment-pulsing');
                segmentEl.classList.remove('segment-completed', 'segment-pending');
            }
            // 显示倒计时数字: 10-8-6-4-2 (双数变化，基于进度百分比)
            if (countdownEl) {
                // 计算剩余跳绳数: 10 → 0，只显示双数 10,8,6,4,2
                const remainingJumps = Math.ceil((1 - segmentProgress) * 10);
                // 向上取到最近的双数
                const displayNumber = remainingJumps % 2 === 0 ? remainingJumps : remainingJumps + 1;
                countdownEl.innerText = Math.min(10, Math.max(0, displayNumber));
            }

            // 将之前的所有段填满并标记为已完成（变暗）
            for (let i = 0; i < currentSegment; i++) {
                const prevSegment = document.getElementById(`pace-segment-${i}`);
                const prevProgressEl = document.getElementById(`pace-seg-progress-${i}`);
                const prevCountdown = document.getElementById(`pace-seg-countdown-${i}`);

                if (prevProgressEl && prevProgressEl.style.width !== '100%') {
                    prevProgressEl.style.width = '100%';
                }
                if (prevSegment) {
                    prevSegment.classList.remove('active-segment-glow', 'segment-pulsing');
                    prevSegment.classList.add('segment-completed');
                }
                if (prevCountdown) {
                    prevCountdown.innerText = '✓'; // 已完成标记
                }
            }

            // 检查是否进入了新的一段（提醒）
            if (currentSegment > state.currentPaceSegment) {
                state.currentPaceSegment = currentSegment;
                triggerFlash();
                els.paceJumpCount.innerText = currentSegment * 10;
            }
        };

        const triggerFlash = () => {
            els.flashOverlay.style.opacity = '1';
            setTimeout(() => {
                els.flashOverlay.style.opacity = '0';
            }, 100);
        };

        const switchPhase = () => {
            if (state.phase === 'getReady') {
                // 准备结束，进入第一轮运动
                state.phase = 'work';
                state.timeLeft = state.workTime;
                initPaceSegments();
            } else if (state.phase === 'work') {
                // 运动结束，检查是否所有轮次都完成了
                els.paceContainer.classList.add('hidden');
                if (state.currentRound >= state.totalRounds) {
                    finishWorkout();
                    return;
                }
                // 还没结束，进入休息
                state.phase = 'rest';
                state.timeLeft = state.restTime;
                // 注意：这里删除了 state.currentRound++，防止在休息时显示下一轮
            } else if (state.phase === 'rest') {
                // 休息结束，进入下一轮运动
                state.currentRound++; // 在这里增加轮数
                state.phase = 'work';
                state.timeLeft = state.workTime;
                initPaceSegments();
            }
            updateTimerUI(true); // 强制刷新文本
        };

        const updateTimerUI = (forceTextUpdate = false) => {
            if (state.phase === 'finished') return;

            // 防止显示负数
            const displayTime = Math.max(0, Math.ceil(state.timeLeft));
            els.timerDisplay.innerText = formatTime(displayTime);

            // 更新圆环
            let totalPhaseTime;
            if (state.phase === 'getReady') totalPhaseTime = 5; // 准备时间固定5秒
            else if (state.phase === 'work') totalPhaseTime = state.workTime;
            else totalPhaseTime = state.restTime;

            const percent = (state.timeLeft / totalPhaseTime) * 100;
            setProgress(percent);

            // Update text and colors
            if (state.phase === 'getReady') {
                els.phaseText.innerText = 'GET READY';
                els.nextPhaseText.innerText = 'JUMP';
                els.currentRoundDisplay.innerText = state.currentRound;
            } else if (state.phase === 'work') {
                els.phaseText.innerText = 'JUMP';
                els.nextPhaseText.innerText = (state.currentRound === state.totalRounds) ? 'FINISH' : 'REST';
                els.currentRoundDisplay.innerText = state.currentRound;
            } else if (state.phase === 'rest') {
                els.phaseText.innerText = 'REST';
                els.nextPhaseText.innerText = 'JUMP';
                els.currentRoundDisplay.innerText = state.currentRound;
            }

            updateColors(state.phase);
        };

        // === File Permission Helper ===
        async function ensureFilePermission() {
            try {
                const snapshot = await db.loadSnapshotFromIDB();
                if (!snapshot?.handle) {
                    console.log('[HIIT] No file handle found');
                    return false;
                }

                if (await db.ensureFilePermission(snapshot.handle)) {
                    console.log('[HIIT] ✅ File permission granted');
                    return true;
                } else {
                    console.warn('[HIIT] File permission denied');
                    return false;
                }
            } catch (err) {
                console.error('[HIIT] Permission check failed:', err);
                return false;
            }
        }

        const initWorkout = async () => {
            // Check file permission before starting
            await ensureFilePermission();
            // 获取输入值
            state.workTime = parseInt(els.workInput.value);
            state.restTime = parseInt(els.restInput.value);
            state.totalRounds = parseInt(els.roundsInput.value);
            state.weight = parseInt(els.weightInput.value);
            state.pace = parseInt(els.paceInput.value);
            state.currentRound = 1;
            state.totalWorkTime = 0; // 重置累计运动时间
            state.startTime = new Date().toISOString(); // 记录开始时间
            state.endTime = null; // 重置结束时间

            // Save configuration when workout starts
            saveConfig('workTime', state.workTime);
            saveConfig('restTime', state.restTime);
            saveConfig('rounds', state.totalRounds);
            saveConfig('weight', state.weight);
            saveConfig('pace', state.pace);

            // UI 切换
            els.setupScreen.classList.add('hidden');
            els.timerScreen.classList.remove('hidden');
            els.timerScreen.classList.add('flex');
            els.resetBtn.classList.remove('hidden');
            els.completeScreen.classList.add('hidden');
            els.completeScreen.classList.remove('flex');

            // 进入准备阶段
            state.phase = 'getReady';
            state.timeLeft = 5; // 5秒准备时间
            els.totalRoundsDisplay.innerText = state.totalRounds;

            // 初始化声音上下文（需要用户交互）
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            updateTimerUI(true);
            startTimer();
        };

        const finishWorkout = async () => {
            clearInterval(state.intervalId);
            state.phase = 'finished';
            state.endTime = new Date().toISOString(); // 记录结束时间
            updateColors('finished');

            // 计算统计数据
            const workMinutes = state.totalWorkTime / 60;
            // 高强度HIIT跳绳: 约 0.2 卡路里/公斤/分钟
            const caloriesBurned = Math.round(0.2 * state.weight * workMinutes);

            // 计算总耗时 (秒)
            const durationMs = new Date(state.endTime) - new Date(state.startTime);
            const totalDuration = Math.round(durationMs / 1000);

            // 保存到数据库
            await saveWorkout({
                date: state.startTime, // 使用开始时间作为日期
                rounds: state.totalRounds,
                workTime: state.workTime,
                restTime: state.restTime,
                totalWorkTime: Math.round(state.totalWorkTime),
                totalTime: totalDuration, // 总耗时
                startTime: state.startTime,
                endTime: state.endTime,
                calories: caloriesBurned,
                weight: state.weight
            });

            // 更新完成页面显示
            els.finalWorkTime.innerText = formatTime(Math.round(state.totalWorkTime));
            els.finalCalories.innerText = `${caloriesBurned} kcal`;

            els.timerScreen.classList.add('hidden');
            els.timerScreen.classList.remove('flex');
            els.completeScreen.classList.remove('hidden');
            els.completeScreen.classList.add('flex');
            els.resetBtn.classList.add('hidden');
        };

        const resetWorkout = () => {
            clearInterval(state.intervalId);
            state.phase = 'setup';
            updateColors('setup');

            els.setupScreen.classList.remove('hidden');
            els.timerScreen.classList.add('hidden');
            els.timerScreen.classList.remove('flex');
            els.completeScreen.classList.add('hidden');
            els.completeScreen.classList.remove('flex');
            els.resetBtn.classList.add('hidden');
            els.paceContainer.classList.add('hidden'); // 隐藏配速进度条
        };

        const togglePause = () => {
            state.isPaused = !state.isPaused;
            els.toggleIcon.className = state.isPaused ? 'fas fa-play' : 'fas fa-pause';
            // 可以在这里添加透明度变化表示暂停
            els.timerDisplay.style.opacity = state.isPaused ? '0.5' : '1';
        };

        // === 事件监听 ===

        // 输入变化实时更新 (不保存配置，只有开始训练时才保存)
        els.workInput.addEventListener('input', (e) => {
            els.workDisplay.innerText = `${e.target.value}s`;
            calculateTotalTime();
        });
        els.restInput.addEventListener('input', (e) => {
            els.restDisplay.innerText = `${e.target.value}s`;
            calculateTotalTime();
        });
        els.roundsInput.addEventListener('input', (e) => {
            els.roundsDisplay.innerText = `${e.target.value}`;
            calculateTotalTime();
        });
        els.weightInput.addEventListener('input', (e) => {
            els.weightDisplay.innerText = `${e.target.value} kg`;
        });
        els.paceInput.addEventListener('input', (e) => {
            els.paceDisplay.innerText = `${e.target.value} JPM`;
        });

        // +/- 按钮事件监听
        document.querySelectorAll('.adjust-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // 确保获取按钮元素（即使点击的是内部图标）
                const button = e.currentTarget;
                const targetId = button.dataset.target;
                const delta = parseInt(button.dataset.delta);
                const input = document.getElementById(targetId);

                if (!input) {
                    console.error('[HIIT] Input not found:', targetId);
                    return;
                }

                const min = parseInt(input.min);
                const max = parseInt(input.max);
                let newValue = parseInt(input.value) + delta;

                // 限制在范围内
                newValue = Math.max(min, Math.min(max, newValue));
                input.value = newValue;

                // 触发 input 事件以更新显示
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
        });

        els.startBtn.addEventListener('click', initWorkout);
        els.resetBtn.addEventListener('click', resetWorkout);
        els.homeBtn.addEventListener('click', resetWorkout);
        els.toggleBtn.addEventListener('click', togglePause);
        els.statsBtn.addEventListener('click', openStats);

        // === STATS LOGIC ===
        let chart = null;
        let currentChartMetric = 'calories';

        function openStats() {
            // Hide completion screen if visible
            if (els.completionScreen) els.completionScreen.classList.add('hidden');
            els.statsOverlay.classList.remove('hidden');
            renderAllStatsUI();
        }

        function closeStats() {
            els.statsOverlay.classList.add('hidden');
        }

        async function renderAllStatsUI() {
            if (!db.isOpen) {
                // console.warn('Database not open');
                // Optional: Show prompt to user
                if (!document.getElementById('db-warning-toast')) {
                    const toast = document.createElement('div');
                    toast.id = 'db-warning-toast';
                    toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg z-50 animate-bounce';
                    toast.innerText = 'Please open database in Dashboard first';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                return;
            }

            // Ensure tables are init (idempotent)
            // But we should rely on initDatabase being called on 'db_opened'. 
            // If we are here, db is open.

            await renderSummary();
            await renderChart(currentChartMetric);
            await renderStatsList();
        }

        async function executeQueryResult(sql, params = []) {
            if (!db.isOpen) return [];
            try {
                const res = await db.query(sql, params);
                return res || [];
            } catch (err) {
                console.error('Query Failed:', err);
                return [];
            }
        }


        async function renderSummary() {
            const result = await executeQueryResult(`
                SELECT 
                    COUNT(*) as count,
                    COALESCE(SUM(calories), 0) as totalCal,
                    COALESCE(SUM(total_work_time), 0) as totalTime,
                    COALESCE(AVG(calories), 0) as avgCal
                FROM workouts
            `);

            if (result && result.length > 0) {
                const [count, totalCal, totalTime, avgCal] = result[0].values[0];
                document.getElementById('statTotalWorkouts').textContent = count;
                document.getElementById('statTotalCalories').textContent = totalCal;
                document.getElementById('statTotalTime').textContent = Math.round(totalTime / 60);
                document.getElementById('statAvgCalories').textContent = Math.round(avgCal);
            }
        }

        window.renderChart = async function (metric = 'calories') {
            currentChartMetric = metric;

            // UI Toggle State
            const btnCal = document.getElementById('chartMetricCal');
            const btnTime = document.getElementById('chartMetricTime');
            const isDark = document.documentElement.classList.contains('dark');
            const activeClasses = ['bg-slate-600', 'text-white', 'shadow', 'dark:bg-slate-600'];
            const inactiveClasses = ['text-slate-600', 'dark:text-slate-400'];

            if (metric === 'calories') {
                btnCal.classList.add(...activeClasses);
                btnCal.classList.remove(...inactiveClasses);
                btnTime.classList.remove(...activeClasses);
                btnTime.classList.add(...inactiveClasses);
            } else {
                btnTime.classList.add(...activeClasses);
                btnTime.classList.remove(...inactiveClasses);
                btnCal.classList.remove(...activeClasses);
                btnCal.classList.add(...inactiveClasses);
            }

            let sql = '';
            let label = '';
            let color = '';
            let bgColor = '';

            if (metric === 'calories') {
                sql = `
                    SELECT date(date) as day, SUM(calories) as val
                    FROM workouts
                    WHERE date >= date('now', '-30 days')
                    GROUP BY date(date)
                    ORDER BY day
                `;
                label = 'Calories';
                color = 'rgb(251, 146, 60)'; // Orange
                bgColor = 'rgba(251, 146, 60, 0.6)';
            } else {
                // Duration in minutes
                sql = `
                    SELECT date(date) as day, SUM(total_work_time) / 60.0 as val
                    FROM workouts
                    WHERE date >= date('now', '-30 days')
                    GROUP BY date(date)
                    ORDER BY day
                `;
                label = 'Duration (min)';
                color = 'rgb(16, 185, 129)'; // Emerald
                bgColor = 'rgba(16, 185, 129, 0.6)';
            }

            const result = await executeQueryResult(sql);

            const labels = [];
            const data = [];

            if (result && result.length > 0) {
                result[0].values.forEach(row => {
                    labels.push(row[0].slice(5)); // MM-DD
                    data.push(row[1]); // Value
                });
            }

            const container = document.getElementById('chartContainer');
            const minWidth = 600;
            const requiredWidth = Math.max(minWidth, labels.length * 40);
            container.style.width = `${requiredWidth}px`;

            const ctx = document.getElementById('caloriesChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: bgColor,
                        borderColor: color,
                        borderWidth: 1,
                        borderRadius: 4,
                        maxBarThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' },
                            ticks: { color: isDark ? '#94a3b8' : '#475569' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: isDark ? '#94a3b8' : '#475569' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        async function renderStatsList() {
            let query = `
                SELECT id, date, rounds, work_time, rest_time, total_work_time, calories, weight, total_time
                FROM workouts
                ORDER BY date DESC
                LIMIT 50
            `;

            let result = await executeQueryResult(query);

            if (!result || result.length === 0 || result[0].values.length === 0) {
                document.getElementById('statsList').innerHTML = `
                    <div class="text-center text-slate-500 py-12">
                        <i class="fas fa-calendar-times text-4xl mb-4 opacity-20"></i>
                        <p>No workout records found</p>
                    </div>
                `;
                return;
            }

            const html = result[0].values.map(row => {
                const [id, date, rounds, workTime, restTime, totalWorkTime, calories, weight, totalTime] = row;
                const d = new Date(date);
                const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const workMins = Math.floor(totalWorkTime / 60);
                const workSecs = totalWorkTime % 60;

                return `
                    <div class="p-4 hover:bg-slate-200 dark:hover:bg-slate-700/30 transition flex items-center justify-between group border-l-4 border-indigo-500/50 bg-slate-100 dark:bg-slate-800/20 rounded-r-xl">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-12 h-12 rounded-xl bg-indigo-500/10 flex flex-col items-center justify-center text-indigo-400 shrink-0">
                                <span class="text-xs font-black leading-none">${rounds}</span>
                                <span class="text-[8px] uppercase font-bold opacity-60">Rounds</span>
                            </div>
                            <div class="min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fas fa-bolt text-[10px] text-lime-500 dark:text-lime-400"></i>
                                    <span class="font-bold text-slate-900 dark:text-slate-200">${dateStr}</span>
                                </div>
                                <div class="text-xs text-slate-600 dark:text-slate-400 flex flex-wrap gap-x-3 gap-y-1">
                                    <span><i class="fas fa-stopwatch mr-1 opacity-60 dark:opacity-50"></i>${workTime}s / ${restTime}s</span>
                                    <span><i class="fas fa-clock mr-1 opacity-60 dark:opacity-50"></i>Jump ${workMins}m ${workSecs}s</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 shrink-0">
                            <div class="text-right px-2">
                                <div class="text-xl font-black text-orange-600 dark:text-orange-400 leading-none">${calories}</div>
                                <div class="text-[10px] font-bold text-slate-600 dark:text-slate-500 uppercase tracking-tighter">kcal</div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="openEditModal(${id}, '${date}', ${rounds}, ${workTime}, ${restTime}, ${calories}, ${weight})" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition" title="Edit">
                                    <i class="fas fa-edit text-sm"></i>
                                </button>
                                <button onclick="deleteWorkout(${id})" class="w-9 h-9 flex items-center justify-center text-slate-400 hover:text-rose-400 hover:bg-rose-400/10 rounded-lg transition" title="Delete">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('statsList').innerHTML = `<div class="space-y-3">${html}</div>`;
        }

        // --- CRUD for Stats ---
        const editModal = document.getElementById('editModal');
        let currentEditId = null;

        window.openEditModal = function (id, date, rounds, work, rest, cals, weight) {
            currentEditId = id;
            document.getElementById('edit-rounds').value = rounds;
            document.getElementById('edit-work').value = work;
            document.getElementById('edit-rest').value = rest;
            document.getElementById('edit-cals').value = cals;
            document.getElementById('edit-weight').value = weight || '';
            try {
                const d = new Date(date);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                document.getElementById('edit-date').value = d.toISOString().slice(0, 16);
            } catch (e) { }
            editModal.classList.remove('hidden');
        };

        window.closeEditModal = function () {
            editModal.classList.add('hidden');
            currentEditId = null;
        };

        window.saveEdit = async function () {
            if (!currentEditId) return;
            const rounds = parseInt(document.getElementById('edit-rounds').value);
            const work = parseInt(document.getElementById('edit-work').value);
            const rest = parseInt(document.getElementById('edit-rest').value);
            const cals = parseInt(document.getElementById('edit-cals').value);
            const weight = parseFloat(document.getElementById('edit-weight').value);
            const dateStr = document.getElementById('edit-date').value;

            // Convert datetime-local format (YYYY-MM-DDTHH:mm) to full ISO format
            const fullDate = new Date(dateStr).toISOString();

            const sql = `UPDATE workouts SET date = ?, rounds = ?, work_time = ?, rest_time = ?, calories = ?, weight = ? WHERE id = ?`;
            const params = [fullDate, rounds, work, rest, cals, weight, currentEditId];

            try {
                await db.execute(sql, params);
                closeEditModal();
            } catch (err) {
                console.error('Save Edit Failed:', err);
                alert('Save Failed: ' + err.message);
            }
        };

        window.deleteWorkout = async function (id) {
            // Find session data for undo
            let query = `SELECT id, date, rounds, work_time, rest_time, total_work_time, calories, weight, total_time, start_time, end_time FROM workouts WHERE id = ?`;
            let result = await executeQueryResult(query, [id]);

            if (!result || !result[0] || !result[0].values[0]) return;

            const row = result[0].values[0];
            const session = {
                id: row[0], date: row[1], rounds: row[2], workTime: row[3], restTime: row[4],
                totalWorkTime: row[5], calories: row[6], weight: row[7], totalTime: row[8],
                startTime: row[9], endTime: row[10]
            };

            try {
                await db.execute('DELETE FROM workouts WHERE id = ?', [id]);
                showUndoToast(session);
                renderAllStats();
            } catch (err) {
                console.error('Delete Failed:', err);
            }
        };

        let undoTimeout = null;
        function showUndoToast(session) {
            const existing = document.getElementById('undoToast');
            if (existing) existing.remove();
            if (undoTimeout) clearTimeout(undoTimeout);

            const toast = document.createElement('div');
            toast.id = 'undoToast';
            toast.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-[1000] border border-slate-700/50 animate-fade-in';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </div>
                    <span class="text-sm font-medium">Deleted workout record</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="undoDeleteWorkout()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold transition-all active:scale-95">Undo</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="p-2 text-slate-500 hover:text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);

            window._deletedWorkout = session;

            undoTimeout = setTimeout(() => {
                toast.remove();
                window._deletedWorkout = null;
            }, 5000);
        }

        window.undoDeleteWorkout = async function () {
            const s = window._deletedWorkout;
            if (!s) return;

            try {
                await db.execute(
                    `INSERT INTO workouts (id, date, rounds, work_time, rest_time, total_work_time, calories, weight, total_time, start_time, end_time) 
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                    [s.id, s.date, s.rounds, s.workTime, s.restTime, s.totalWorkTime, s.calories, s.weight, s.totalTime, s.startTime, s.endTime]
                );
                window._deletedWorkout = null;
                const toast = document.getElementById('undoToast');
                if (toast) toast.remove();
                renderAllStats();
            } catch (e) {
                console.error('Undo failed:', e);
            }
        };

        window.openStats = openStats;
        window.closeStats = closeStats;
        window.exportDatabase = async function () {
            try {
                const binaryArray = await db.export();
                const blob = new Blob([binaryArray], { type: 'application/x-sqlite3' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hiit_workouts_${new Date().toISOString().slice(0, 10)}.sqlite`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Export error:', err);
            }
        };

        // === IDB Loading for Standalone Operation ===
        // Note: IDB_NAME, IDB_STORE, IDB_KEY, and openIndexedDB are defined in db-client.js

        // Listen for updates from SharedWorker - ALL pages save to IDB immediately
        db.on('db_updated', async () => {
            console.log('[HIIT] DB Updated, saving to IDB...');

            // Refresh stats UI if visible
            if (!els.statsOverlay.classList.contains('hidden')) {
                renderAllStats();
            }

            try {
                const data = await db.export();
                await db.saveSnapshotToIDB(data);
                console.log('[HIIT] Saved to IDB');
            } catch (err) {
                console.error('[HIIT] IDB Save Error:', err);
            }
        });

        // Handle periodic file sync (only when this page is the writer)
        db.on('sync_to_file', async () => {
            console.log('[HIIT] Syncing to file...');
            try {
                const snapshot = await db.loadSnapshotFromIDB();
                if (snapshot?.handle) {
                    const data = await db.export();
                    if (await db.ensureFilePermission(snapshot.handle)) {
                        const writable = await snapshot.handle.createWritable();
                        await writable.write(data);
                        await writable.close();
                        console.log('[HIIT] ✅ Synced to file:', snapshot.handle.name);
                    } else {
                        console.warn('[HIIT] File permission not granted');
                    }
                }
            } catch (err) {
                console.error('[HIIT] File sync error:', err);
            }
        });

        // Listen for writer status changes
        db.on('writer_changed', async (data) => {
            console.log('[HIIT] Writer status changed:', data?.isWriter ? 'I am now the writer' : 'No longer writer');
            if (data?.isWriter) {
                ensureFilePermission();
                // Start periodic file sync (every 10 seconds)
                db.startPeriodicSync(10000);
            }
        });

        // Startup: Load from IDB or wait for db_opened
        console.log('[HIIT] Setting up startup, db.isOpen =', db.isOpen);

        let initCalled = false;

        db.on('db_opened', () => {
            if (initCalled) return;
            initCalled = true;
            console.log('[HIIT] db_opened event received, calling initDatabase()...');
            initDatabase();
            // Try to become the file writer
            db.claimWriter();
        });

        if (db.isOpen) {
            initCalled = true;
            console.log('[HIIT] DB already open, calling initDatabase() immediately...');
            initDatabase();
            db.claimWriter();
        } else {
            console.log('[HIIT] DB not open, waiting for worker ready...');

            // Wait for worker ready, then load from IDB
            const tryLoadFromIDB = async () => {
                if (initCalled) return;
                console.log('[HIIT] Worker ready, trying to load from IDB...');
                try {
                    const snapshot = await db.loadSnapshotFromIDB();
                    if (initCalled) return;
                    if (snapshot && snapshot.data) {
                        console.log('[HIIT] Found IDB snapshot, initializing DB...');
                        await db.init(snapshot.data);
                        // db_opened event will be fired by the worker
                    } else {
                        console.log('[HIIT] No database found in IDB, initializing new empty DB...');
                        alert('No database found! Please open a database file in Settings first.');
                        await db.init();
                    }
                } catch (err) {
                    console.error('[HIIT] Failed to load from IDB:', err);
                    alert('Failed to load database!');
                    console.log('[HIIT] Fallback: Initializing empty DB due to error...');
                    await db.init();
                }
            };

            if (db.isReady) {
                tryLoadFromIDB();
            } else {
                db.on('ready', tryLoadFromIDB);
            }
        }



        async function initDatabase() {
            try {
                // 1. Ensure workouts table exists
                await db.execute(`
                    CREATE TABLE IF NOT EXISTS workouts (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        date TEXT NOT NULL,
                        rounds INTEGER,
                        work_time INTEGER,
                        rest_time INTEGER,
                        total_work_time INTEGER,
                        calories INTEGER,
                        weight REAL,
                        total_time INTEGER,
                        start_time TEXT,
                        end_time TEXT
                    )
                `);

                // Note: app_config table is created in index.html (system-level table)

                // 2. Safe Migration (Check columns first)
                try { await db.execute("ALTER TABLE workouts ADD COLUMN total_time INTEGER;"); } catch (e) { }
                try { await db.execute("ALTER TABLE workouts ADD COLUMN start_time TEXT;"); } catch (e) { }
                try { await db.execute("ALTER TABLE workouts ADD COLUMN end_time TEXT;"); } catch (e) { }

                console.log('[HIIT] Database initialized');

                // Load saved config
                await loadConfig();

                renderAllStats();

            } catch (err) {
                console.error('[HIIT] Database initialization/migration failed:', err);
            }
        }

        // === Configuration Storage ===
        async function loadConfig() {
            try {
                const result = await db.query(
                    `SELECT config_key, config_value FROM app_config WHERE tool_name = 'hiit'`
                );

                if (result && result.length > 0 && result[0].values) {
                    const config = {};
                    result[0].values.forEach(row => {
                        config[row[0]] = row[1];
                    });

                    console.log('[HIIT] Loaded config:', config);

                    // Apply config to inputs
                    if (config.workTime) {
                        els.workInput.value = config.workTime;
                        els.workDisplay.innerText = `${config.workTime}s`;
                    }
                    if (config.restTime) {
                        els.restInput.value = config.restTime;
                        els.restDisplay.innerText = `${config.restTime}s`;
                    }
                    if (config.rounds) {
                        els.roundsInput.value = config.rounds;
                        els.roundsDisplay.innerText = config.rounds;
                    }
                    if (config.weight) {
                        els.weightInput.value = config.weight;
                        els.weightDisplay.innerText = `${config.weight} kg`;
                    }
                    if (config.pace) {
                        els.paceInput.value = config.pace;
                        els.paceDisplay.innerText = `${config.pace} JPM`;
                    }

                    // Recalculate total time
                    calculateTotalTime();
                }
            } catch (err) {
                console.error('[HIIT] Failed to load config:', err);
            }
        }

        async function saveConfig(key, value) {
            try {
                await db.execute(
                    `INSERT OR REPLACE INTO app_config (tool_name, config_key, config_value, updated_at) 
                     VALUES (?, ?, ?, ?)`,
                    ['hiit', key, String(value), new Date().toISOString()]
                );
                console.log(`[HIIT] Saved config: ${key} = ${value}`);
            } catch (err) {
                console.error('[HIIT] Failed to save config:', err);
            }
        }

        async function saveWorkout(data) {
            try {
                console.log('[HIIT] Saving workout with data:', data);

                await db.execute(`
                    INSERT INTO workouts (date, rounds, work_time, rest_time, total_work_time, calories, weight, total_time, start_time, end_time)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `, [data.date, data.rounds, data.workTime, data.restTime, data.totalWorkTime, data.calories, data.weight, data.totalTime, data.startTime, data.endTime]);

                console.log('[HIIT] INSERT executed');

                // Verify the data was saved
                const verifyResult = await db.query(`SELECT * FROM workouts ORDER BY id DESC LIMIT 1`);
                console.log('[HIIT] Verify result:', verifyResult);

                // Get total count
                const countResult = await db.query(`SELECT COUNT(*) as count FROM workouts`);
                console.log('[HIIT] Total workouts count:', countResult);

                console.log('[HIIT] Workout saved successfully');
            } catch (err) {
                console.error('[HIIT] Save workout error:', err);
                alert('Save Failed: ' + err.message);
            }
        }

        // Initialize
        calculateTotalTime();

        // Database Startup
        // Register listener first, then check if already open (handles race condition)
        db.on('db_opened', initDatabase);
        if (db.isOpen) {
            initDatabase();
        }

        // Expose functions to window for onclick
        Object.assign(window, {
            toggleTimer: () => {
                if (state.phase === 'setup' || state.phase === 'finished') {
                    // Start
                    state.rounds = parseInt(els.roundsInput.value);
                    state.workTime = parseInt(els.workInput.value);
                    state.restTime = parseInt(els.restInput.value);
                    state.weight = parseFloat(els.weightInput.value) || 70;

                    state.timeLeft = 5; // Get Ready
                    state.phase = 'getReady';
                    state.currentRound = 1;
                    state.totalWorkTime = 0;
                    state.isPaused = false;

                    state.startTime = new Date().toISOString();

                    els.setupScreen.classList.add('hidden');
                    els.completeScreen.classList.add('hidden');
                    els.timerScreen.classList.remove('hidden');

                    updateColors('getReady');
                    startTimer();
                } else {
                    // Toggle Pause
                    state.isPaused = !state.isPaused;
                    els.toggleIcon.className = state.isPaused ? 'fas fa-play' : 'fas fa-pause';
                }
            },
            resetTimer: () => {
                if (confirm('Reset timer?')) {
                    clearInterval(state.intervalId);
                    state.phase = 'setup';
                    els.timerScreen.classList.add('hidden');
                    els.completeScreen.classList.add('hidden');
                    els.setupScreen.classList.remove('hidden');
                    updateColors('setup');
                }
            },
            homeBtnLogic: () => { // If home button exists
                clearInterval(state.intervalId);
                state.phase = 'setup';
                els.timerScreen.classList.add('hidden');
                els.completeScreen.classList.add('hidden');
                els.setupScreen.classList.remove('hidden');
                updateColors('setup');
            },
            // Note: finishWorkout is internal but calls saveWorkout
            openStats: () => {
                els.statsOverlay.classList.remove('hidden');
                renderAllStatsUI();
            },
            // savedEdit, deleteWorkout exposed earlier? No, I need to ensure they are visible.
            // But they were attached to window in previous edits?
            // "window.saveEdit = ..."
            // Yes, I redefined them as window.saveEdit = async function... earlier.
            // So they are safe.
        });



        // Keyboard Shortcuts
        window.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in an input
            if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

            if (e.key.toLowerCase() === 's') {
                openStats();
            } else if (e.key === 'Escape') {
                closeStats();
                // Also close edit modal if it's open
                const editModal = document.getElementById('editModal');
                if (editModal && !editModal.classList.contains('hidden')) {
                    closeEditModal();
                }
            }
        });
    </script>
</body>

</html>