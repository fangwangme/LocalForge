<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalForge</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <style>
        .sidebar-expanded {
            width: 16rem;
        }

        .sidebar-collapsed {
            width: 5rem;
        }

        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }

        /* Hide text in collapsed mode */
        .sidebar-collapsed .nav-text {
            display: none;
        }

        /* Center icons in collapsed mode */
        .sidebar-collapsed .nav-item {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        .sidebar-collapsed .section-title {
            display: none;
        }

        .sidebar-collapsed .logo-text {
            display: none;
        }
    </style>
</head>

<body>
    <div class="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="sidebar-expanded sidebar-transition bg-slate-900 border-r border-slate-800 flex flex-col z-20 relative">
            <!-- Sidebar Header -->
            <div class="h-16 flex items-center justify-between px-4 border-b border-slate-800 shrink-0">
                <div onclick="showDashboard()"
                    class="flex items-center gap-3 cursor-pointer overflow-hidden whitespace-nowrap">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shrink-0">
                        <i class="fas fa-layer-group text-white text-sm"></i>
                    </div>
                    <span class="logo-text font-bold text-lg tracking-tight">LocalForge</span>
                </div>
                <!-- Toggle Button (Absolute to stay accessible) -->
                <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white transition p-1">
                    <i id="sidebar-toggle-icon" class="fas fa-chevron-left"></i>
                </button>
            </div>

            <!-- Nav Items -->
            <nav class="flex-1 overflow-y-auto py-4 overflow-x-hidden">
                <ul class="space-y-1 px-2">
                    <li>
                        <button onclick="showDashboard()" id="nav-home"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition active-nav whitespace-nowrap group">
                            <i class="fas fa-home w-6 text-center shrink-0 group-hover:text-blue-400 transition"></i>
                            <span class="nav-text font-medium ml-3">主页概览</span>
                        </button>
                    </li>

                    <div
                        class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                        媒体工具</div>
                    <li>
                        <button onclick="openTool('image_editor.html');" id="nav-editor"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i class="fas fa-image w-6 text-center shrink-0 group-hover:text-purple-400 transition"></i>
                            <span class="nav-text ml-3">图片编辑器</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="openTool('image_resize.html');" id="nav-resize"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i
                                class="fas fa-compress-alt w-6 text-center shrink-0 group-hover:text-pink-400 transition"></i>
                            <span class="nav-text ml-3">图片压缩</span>
                        </button>
                    </li>

                    <div
                        class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                        健身运动</div>
                    <li>
                        <button onclick="openTool('hiit_jump_rope.html');" id="nav-timer"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i
                                class="fas fa-stopwatch w-6 text-center shrink-0 group-hover:text-rose-400 transition"></i>
                            <span class="nav-text ml-3">HIIT 计时器</span>
                        </button>
                    </li>
                    <li>


                        <div
                            class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                            效率工具</div>
                    <li>
                        <button onclick="openTool('pomodoro.html');" id="nav-pomodoro"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i class="fas fa-clock w-6 text-center shrink-0 group-hover:text-red-400 transition"></i>
                            <span class="nav-text ml-3">番茄钟</span>
                        </button>
                    </li>
                </ul>
            </nav>

            <!-- Bottom Settings -->
            <div class="p-2 border-t border-slate-800">
                <button onclick="openSettings()"
                    class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap">
                    <i class="fas fa-cog w-6 text-center shrink-0"></i>
                    <span class="nav-text ml-3">设置 & 数据库</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative">
            <!-- Header (Simplified) -->
            <header
                class="h-16 bg-slate-900 border-b border-slate-800 flex justify-between items-center px-6 shrink-0 z-10">
                <h2 id="page-title" class="text-lg font-medium text-white">主页概览</h2>
                <!-- Optional: Right side controls if needed -->
            </header>

            <!-- Content Area -->
            <div class="flex-1 relative overflow-hidden bg-slate-900">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="absolute inset-0 overflow-y-auto p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                        <!-- Cards -->
                        <div onclick="openTool('image_editor.html')"
                            class="group p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-blue-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden">
                            <div
                                class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition">
                            </div>
                            <div
                                class="w-12 h-12 rounded-xl bg-blue-500/10 text-blue-400 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">
                                <i class="fas fa-image"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">图片编辑器</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">16:9 裁剪、去水印、滤镜调整。</p>
                        </div>

                        <div onclick="openTool('image_resize.html')"
                            class="group p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-purple-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden">
                            <div
                                class="w-12 h-12 rounded-xl bg-purple-500/10 text-purple-400 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">
                                <i class="fas fa-compress-alt"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">图片压缩</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">智能压缩图片体积。</p>
                        </div>

                        <div onclick="openTool('hiit_jump_rope.html')"
                            class="group p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-rose-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden">
                            <div
                                class="w-12 h-12 rounded-xl bg-rose-500/10 text-rose-400 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">HIIT 计时器</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">自定义间歇训练计时。</p>
                        </div>



                        <div onclick="openTool('pomodoro.html')"
                            class="group p-6 bg-slate-800 rounded-2xl border border-slate-700 hover:border-red-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden">
                            <div
                                class="w-12 h-12 rounded-xl bg-red-500/10 text-red-400 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">番茄钟</h3>
                            <p class="text-slate-400 text-sm leading-relaxed">专注计时，历史记录。</p>
                        </div>
                    </div>
                </div>

                <!-- Iframe Container -->
                <div id="app-frame-container" class="absolute inset-0 hidden bg-slate-900">
                    <iframe id="app-frame" class="w-full h-full border-none"></iframe>
                </div>
            </div>
        </main>

        <!-- Hidden File Input for Legacy Browsers -->
        <input type="file" id="db-file-input" hidden accept=".sqlite,.db,application/x-sqlite3">

        <!-- Settings Modal Overlay -->
        <div id="settings-modal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-fade-in"
            onclick="if(event.target === this) closeSettings()">
            <div
                class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">设置 & 数据库</h3>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-white">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- DB Status Section -->
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700/50">
                        <div class="text-sm text-slate-400 mb-2">数据库状态</div>
                        <div id="modal-db-status" class="flex items-center gap-3 text-amber-400 font-medium">
                            <div class="w-3 h-3 rounded-full bg-amber-500 animate-pulse"></div>
                            <span id="modal-db-status-text">未连接 (使用内存暂存)</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openDatabase()"
                            class="flex flex-col items-center justify-center p-4 bg-indigo-600/10 border border-indigo-500/30 rounded-lg hover:bg-indigo-600/20 hover:border-indigo-500 transition group">
                            <i
                                class="fas fa-folder-open text-2xl text-indigo-400 mb-2 group-hover:scale-110 transition"></i>
                            <span class="text-indigo-100 font-medium">打开文件</span>
                        </button>

                        <button onclick="saveDatabaseToDisk(event)"
                            class="flex flex-col items-center justify-center p-4 bg-emerald-600/10 border border-emerald-500/30 rounded-lg hover:bg-emerald-600/20 hover:border-emerald-500 transition group">
                            <i class="fas fa-save text-2xl text-emerald-400 mb-2 group-hover:scale-110 transition"></i>
                            <span class="text-emerald-100 font-medium">保存到本地</span>
                        </button>
                    </div>

                    <!-- Reset/New Action -->
                    <button onclick="handleCreateNewDatabase()"
                        class="w-full mt-4 flex items-center justify-center gap-2 p-3 bg-slate-700/50 border border-slate-600 rounded-lg hover:bg-blue-500/20 hover:border-blue-500/50 hover:text-blue-300 transition text-slate-400 text-sm">
                        <i class="fas fa-plus-circle"></i> <span>新建本地数据库文件</span>
                    </button>

                    <div class="text-xs text-slate-500 text-center leading-relaxed mt-2">
                        注意：默认建议文件名为 <code>html_tools_db.sqlite</code>。<br>
                        "新建" 将引导您创建一个新的本地数据库文件。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === UI Logic ===
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleIcon = document.getElementById('sidebar-toggle-icon');
        const settingsModal = document.getElementById('settings-modal');
        const navItems = document.querySelectorAll('.nav-item');
        const dashboardView = document.getElementById('dashboard-view');
        const iframeContainer = document.getElementById('app-frame-container');
        const iframe = document.getElementById('app-frame');
        const pageTitle = document.getElementById('page-title');
        const dbFileInput = document.getElementById('db-file-input');

        let isSidebarCollapsed = false;

        function toggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            if (isSidebarCollapsed) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                sidebarToggleIcon.classList.remove('fa-chevron-left');
                sidebarToggleIcon.classList.add('fa-chevron-right');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                sidebarToggleIcon.classList.remove('fa-chevron-right');
                sidebarToggleIcon.classList.add('fa-chevron-left');
            }
        }

        function openSettings() {
            settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
        }

        function setActiveNav(id) {
            navItems.forEach(el => {
                if (el.id === id) {
                    el.classList.add('bg-slate-800', 'text-white');
                    el.classList.remove('text-slate-400');
                } else if (!el.id.includes('settings')) { // Don't dim settings button
                    el.classList.remove('bg-slate-800', 'text-white');
                    el.classList.add('text-slate-400');
                }
            });
        }

        function showDashboard() {
            dashboardView.classList.remove('hidden');
            iframeContainer.classList.add('hidden');
            iframe.src = '';
            setActiveNav('nav-home');
            pageTitle.innerText = '主页概览';
        }

        function openTool(url) {
            dashboardView.classList.add('hidden');
            iframeContainer.classList.remove('hidden');
            iframe.src = url;

            let title = '工具';
            let navId = '';

            if (url.includes('editor')) { title = '图片编辑器'; navId = 'nav-editor'; }
            else if (url.includes('resize')) { title = '图片压缩'; navId = 'nav-resize'; }
            else if (url.includes('jump')) { title = 'HIIT 计时器'; navId = 'nav-timer'; }
            else if (url.includes('pomodoro')) { title = '番茄钟'; navId = 'nav-pomodoro'; }

            pageTitle.innerText = title;
            setActiveNav(navId);
        }

        // === Database Logic ===
        let dbHandle = null;
        let db = null;
        let SQL = null;

        async function initSql() {
            if (!SQL) {
                SQL = await window.initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                });
            }
        }

        async function createNewDatabase() {
            await initSql();
            db = new SQL.Database();
            initAllTables();
            updateDbStatus('新建数据库 (未保存)', 'amber');
            console.log('New database created');
        }

        async function handleCreateNewDatabase() {
            if (db) {
                if (!confirm('确定要新建吗？如果当前有未保存的数据，将会丢失。新数据文件将覆盖当前会话。')) return;
            }

            dbHandle = null; // Clear key handle to force "Save As" behavior
            await createNewDatabase(); // Init clean in-memory
            // Trigger save after create
            await saveDatabaseToDisk();
        }

        // === IndexedDB Persistence Logic ===
        const IDB_NAME = 'LocalForgeDB';
        const IDB_STORE = 'snapshots';
        const IDB_KEY = 'main_db';

        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(IDB_STORE)) {
                        db.createObjectStore(IDB_STORE);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function saveSnapshotToIDB(data, handle = null, filename = null) {
            try {
                const idb = await openIndexedDB();
                const tx = idb.transaction(IDB_STORE, 'readwrite');
                const store = tx.objectStore(IDB_STORE);

                const record = {
                    data: data,
                    updated_at: Date.now()
                };
                if (handle) record.handle = handle;
                if (filename) record.filename = filename;

                // Merge with existing to keep handle if not provided
                // But wait, 'put' overwrites value. We should read first if we want to merge?
                // Actually, simpler: The caller should pass the handle if available.
                // Global dbHandle is available.
                if (dbHandle && !handle) record.handle = dbHandle;

                store.put(record, IDB_KEY);
                return new Promise((resolve, reject) => {
                    tx.oncomplete = resolve;
                    tx.onerror = reject;
                });
            } catch (err) {
                console.error('IDB Save Error:', err);
            }
        }

        async function loadSnapshotFromIDB() {
            try {
                const idb = await openIndexedDB();
                const tx = idb.transaction(IDB_STORE, 'readonly');
                const store = tx.objectStore(IDB_STORE);
                const request = store.get(IDB_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('IDB Load Error:', err);
                return null;
            }
        }

        // Handle File Input Change (Legacy Import)
        dbFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const uInt8Array = new Uint8Array(arrayBuffer);

                await initSql();
                db = new SQL.Database(uInt8Array);
                initAllTables();

                // Save imported to IDB (No handle in legacy)
                await saveSnapshotToIDB(uInt8Array, null, file.name);

                updateDbStatus(`已加载: ${file.name} (IDB Sync)`, 'emerald');
                dbHandle = null;
                closeSettings();

                if (iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                }
            } catch (err) {
                console.error('Legacy open error:', err);
                alert('加载失败: ' + err.message);
            }
            dbFileInput.value = '';
        });

        async function openDatabase() {
            // Check support
            if (typeof window.showOpenFilePicker === 'function') {
                try {
                    [dbHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'SQLite Database',
                            accept: { 'application/x-sqlite3': ['.sqlite', '.db'] }
                        }]
                    });

                    const file = await dbHandle.getFile();
                    const arrayBuffer = await file.arrayBuffer();
                    const uInt8Array = new Uint8Array(arrayBuffer);

                    await initSql();
                    db = new SQL.Database(uInt8Array);
                    initAllTables(); // Ensure tables exist

                    updateDbStatus(`已加载: ${file.name}`, 'emerald');
                    closeSettings();

                    // Refresh iframe if open
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    }

                } catch (err) {
                    console.error('Open database error:', err);
                    if (err.name !== 'AbortError') {
                        alert('打开数据库失败: ' + err.message);
                    }
                }
            } else {
                // Fallback
                dbFileInput.click();
            }
        }

        async function saveDatabaseToDisk(event, isAutoSave = false) {
            if (!db) return;
            try {
                const data = db.export();

                // ALWAYS save to IDB snapshot for persistence across reloads (Legacy/Backup)
                await saveSnapshotToIDB(data);

                if (typeof window.showSaveFilePicker === 'function') {
                    // Modern API
                    if (dbHandle) {
                        // Check/Request Permission
                        const opts = { mode: 'readwrite' };
                        if ((await dbHandle.queryPermission(opts)) !== 'granted') {
                            if (isAutoSave) {
                                // Cannot prompt during auto-save, skip disk write
                                updateDbStatus('自动保存暂停 (需手动保存验证)', 'amber');
                                return;
                            }
                            // Manual save: request permission
                            if ((await dbHandle.requestPermission(opts)) !== 'granted') {
                                alert('请授予写入权限以保存文件。');
                                return;
                            }
                        }

                        const writable = await dbHandle.createWritable();
                        await writable.write(data);
                        await writable.close();

                        updateDbStatus(`已保存: ${dbHandle.name}`, 'emerald');

                        // Feedback in button
                        if (event && event.currentTarget) {
                            const btn = event.currentTarget;
                            const icon = btn.querySelector('i');
                            const tempClass = icon.className;
                            icon.className = 'fas fa-check text-white';
                            setTimeout(() => icon.className = tempClass, 1500);
                        }
                    } else {
                        // If auto-save and no handle, skip prompt to avoid annoyance
                        if (isAutoSave) return;

                        const handle = await window.showSaveFilePicker({
                            types: [{
                                description: 'SQLite Database',
                                accept: { 'application/x-sqlite3': ['.sqlite', '.db'] }
                            }],
                            suggestedName: `html_tools_db_${new Date().toISOString().slice(0, 10)}.sqlite`
                        });
                        dbHandle = handle;
                        const writable = await handle.createWritable();
                        await writable.write(data);
                        await writable.close();

                        // Save new handle to IDB
                        await saveSnapshotToIDB(data, dbHandle, handle.name);

                        updateDbStatus(`已保存: ${handle.name}`, 'emerald');
                    }
                } else {
                    // Legacy Fallback (Download)
                    // If auto-save, DO NOT download automatically as it spams the user.
                    if (isAutoSave) return;

                    const blob = new Blob([data], { type: 'application/x-sqlite3' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `html_tools_db_${new Date().toISOString().slice(0, 10)}.sqlite`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    updateDbStatus('已导出 (Legacy)', 'emerald');
                }

            } catch (err) {
                console.error('Save database error:', err);
                if (err.name !== 'AbortError') {
                    alert('保存数据库失败: ' + err.message);
                }
            }
        }

        // Init on startup
        window.addEventListener('DOMContentLoaded', async () => {
            await initSql();

            const snapshot = await loadSnapshotFromIDB();
            if (snapshot && snapshot.data) {
                try {
                    // 1. Initial Load from IDB (Fastest)
                    db = new SQL.Database(snapshot.data);

                    if (snapshot.handle) {
                        dbHandle = snapshot.handle;

                        // 2. Try to Sync with File (Source of Truth)
                        try {
                            // Check read permission
                            const perm = await dbHandle.queryPermission({ mode: 'read' });
                            if (perm === 'granted') {
                                const file = await dbHandle.getFile();
                                const buf = await file.arrayBuffer();
                                const u8 = new Uint8Array(buf);
                                db = new SQL.Database(u8); // Reload with fresh file data
                                updateDbStatus(`已同步: ${file.name}`, 'emerald');

                                // Update IDB cache to match file
                                await saveSnapshotToIDB(u8, dbHandle, file.name);
                            } else {
                                const name = snapshot.filename || 'database.sqlite';
                                updateDbStatus(`缓存已加载: ${name} (需点击保存以同步文件)`, 'amber');
                            }
                        } catch (e) {
                            console.warn('File sync failed:', e);
                            const name = snapshot.filename || 'database.sqlite';
                            updateDbStatus(`已恢复: ${name} (文件同步失败)`, 'amber');
                        }
                    } else {
                        const name = snapshot.filename || 'Session Data';
                        updateDbStatus(`已恢复: ${name} (IDB)`, 'emerald');
                    }

                    initAllTables();

                    // Notify iframe that DB is ready
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    }

                } catch (err) {
                    console.error('Restore error:', err);
                    updateDbStatus('恢复失败', 'text-red-500');
                }
            } else {
                // First time load or empty
            }
        });

        async function openDatabase() {
            // Check support
            if (typeof window.showOpenFilePicker === 'function') {
                try {
                    [dbHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'SQLite Database',
                            accept: { 'application/x-sqlite3': ['.sqlite', '.db'] }
                        }]
                    });

                    const file = await dbHandle.getFile();
                    const arrayBuffer = await file.arrayBuffer();
                    const uInt8Array = new Uint8Array(arrayBuffer);

                    await initSql();
                    db = new SQL.Database(uInt8Array);
                    initAllTables();

                    // Save new state (Link Handle)
                    await saveSnapshotToIDB(uInt8Array, dbHandle, file.name);

                    updateDbStatus(`已加载: ${file.name}`, 'emerald');
                    closeSettings();

                    // Refresh iframe if open
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    }

                } catch (err) {
                    console.error('Open database error:', err);
                    if (err.name !== 'AbortError') {
                        alert('打开数据库失败: ' + err.message);
                    }
                }
            } else {
                // Fallback
                dbFileInput.click();
            }
        }

        // Init all tables for all tools
        function initAllTables() {
            if (!db) return;
            initHiitTables();
            initPomodoroTables();
        }

        function initHiitTables() {
            // HIIT Tool Table: workouts
            // Naming convention: Use 'workouts' for compatibility, but consider 'hiit_workouts' for future
            // Keeping 'workouts' as requested to maintain current tool compatibility
            db.run(`
                CREATE TABLE IF NOT EXISTS workouts (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    date TEXT NOT NULL,
                    rounds INTEGER,
                    work_time INTEGER,
                    rest_time INTEGER,
                    total_work_time INTEGER,
                    calories INTEGER,
                    weight REAL,
                    total_time INTEGER,
                    start_time TEXT,
                    end_time TEXT
                )
            `);
            try {
                db.run("ALTER TABLE workouts ADD COLUMN total_time INTEGER;");
                db.run("ALTER TABLE workouts ADD COLUMN start_time TEXT;");
                db.run("ALTER TABLE workouts ADD COLUMN end_time TEXT;");
            } catch (e) { }
        }

        function initPomodoroTables() {
            db.run(`
                CREATE TABLE IF NOT EXISTS pomodoro_tags (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    color TEXT NOT NULL,
                    is_default INTEGER DEFAULT 0
                )
            `);



            db.run(`
                CREATE TABLE IF NOT EXISTS pomodoro_sessions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    start_time TEXT NOT NULL,
                    end_time TEXT NOT NULL,
                    duration_minutes INTEGER NOT NULL,
                    tag_id INTEGER,
                    status TEXT,
                    description TEXT,
                    created_at TEXT NOT NULL
                )
            `);
            try {
                db.run("ALTER TABLE pomodoro_sessions ADD COLUMN description TEXT;");
            } catch (e) { }
        }

        function updateDbStatus(text, color) {
            const statusText = document.getElementById('modal-db-status-text');
            const statusDot = document.querySelector('#modal-db-status div');
            const statusContainer = document.getElementById('modal-db-status');

            if (statusText) {
                statusText.innerText = text;
                statusContainer.className = `flex items-center gap-3 font-medium ${color === 'emerald' ? 'text-emerald-400' : 'text-amber-400'}`;
                statusDot.className = `w-3 h-3 rounded-full ${color === 'emerald' ? 'bg-emerald-500' : 'bg-amber-500'} ${color === 'amber' ? 'animate-pulse' : ''}`;
            }
        }

        // === PostMessage Logic ===
        window.addEventListener('message', async (event) => {
            const msg = event.data;
            if (!msg || !msg.type) return;

            console.log('[Host] Received message:', msg.type, msg);

            if (msg.type === 'REQUEST_DB_DATA') {
                const targetFrame = document.getElementById('app-frame');
                if (!targetFrame || !targetFrame.contentWindow) {
                    console.error('[Host] Target iframe not found!');
                    return;
                }
                const target = targetFrame.contentWindow;

                if (db) {
                    try {
                        console.log('[Host] Executing SQL:', msg.sql);
                        const result = db.exec(msg.sql);
                        console.log('[Host] Query Result Rows:', result.length > 0 ? result[0].values.length : 0);

                        target.postMessage({
                            type: 'DB_QUERY_RESULT',
                            requestId: msg.requestId,
                            result: result,
                            status: 'success'
                        }, '*');
                    } catch (e) {
                        console.error('[Host] Query Error:', e);
                        target.postMessage({
                            type: 'DB_QUERY_RESULT',
                            requestId: msg.requestId,
                            status: 'error',
                            message: e.message
                        }, '*');
                    }
                } else {
                    console.error('[Host] Database NOT loaded yet!');
                    target.postMessage({
                        type: 'DB_QUERY_RESULT',
                        requestId: msg.requestId,
                        status: 'error',
                        message: 'Database not loaded'
                    }, '*');
                }
            } else if (msg.type === 'SAVE_WORKOUT') {
                if (!db) { await createNewDatabase(); }
                try {
                    db.run(`INSERT INTO workouts (date, rounds, work_time, rest_time, total_work_time, calories, weight, total_time, start_time, end_time) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                        [msg.data.date, msg.data.rounds, msg.data.workTime, msg.data.restTime, msg.data.totalWorkTime, msg.data.calories, msg.data.weight, msg.data.totalTime, msg.data.startTime, msg.data.endTime]);

                    await saveDatabaseToDisk(null, true);

                    iframe.contentWindow.postMessage({ type: 'SAVE_SUCCESS', requestId: msg.requestId }, '*');
                } catch (err) {
                    iframe.contentWindow.postMessage({ type: 'SAVE_ERROR', requestId: msg.requestId, message: err.message }, '*');
                }
            } else if (msg.type === 'DELETE_WORKOUT') {
                if (db) {
                    try {
                        db.run('DELETE FROM workouts WHERE id = ?', [msg.id]);
                        await saveDatabaseToDisk(null, true);
                        // Notify success/refresh
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    } catch (err) {
                        console.error('Delete error:', err);
                        alert('删除失败: ' + err.message);
                    }
                }
            } else if (msg.type === 'UPDATE_WORKOUT') {
                if (db) {
                    try {
                        const d = msg.data;
                        // Recalculate total_work_time
                        const totalWork = d.rounds * d.work_time;
                        db.run(`UPDATE workouts SET date = ?, rounds = ?, work_time = ?, rest_time = ?, total_work_time = ?, calories = ?, weight = ? WHERE id = ?`,
                            [d.date, d.rounds, d.work_time, d.rest_time, totalWork, d.calories, d.weight, d.id]);

                        await saveDatabaseToDisk(null, true);
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    } catch (err) {
                        console.error('Update error:', err);
                        alert('更新失败: ' + err.message);
                    }
                }
            } else if (msg.type === 'SAVE_POMODORO') {
                if (!db) await createNewDatabase();
                try {
                    db.run(`INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)`,
                        [msg.data.startTime, msg.data.endTime, msg.data.duration, msg.data.tagId, msg.data.status, msg.data.description || '', new Date().toISOString()]);
                    await saveDatabaseToDisk(null, true);
                    iframe.contentWindow.postMessage({ type: 'SAVE_SUCCESS', requestId: msg.requestId }, '*');
                } catch (err) {
                    iframe.contentWindow.postMessage({ type: 'SAVE_ERROR', requestId: msg.requestId, message: err.message }, '*');
                }
            } else if (msg.type === 'DELETE_POMODORO') {
                if (db) {
                    try {
                        db.run('DELETE FROM pomodoro_sessions WHERE id = ?', [msg.id]);
                        await saveDatabaseToDisk(null, true);
                        iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                    } catch (err) {
                        console.error('Delete Pomodoro error:', err);
                    }
                }
            } else if (msg.type === 'SAVE_TAG') {
                if (!db) await createNewDatabase();
                try {
                    db.run(`INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, 0)`,
                        [msg.data.name, msg.data.color]);
                    await saveDatabaseToDisk(null, true);
                    iframe.contentWindow.postMessage({ type: 'DB_UPDATED' }, '*');
                } catch (err) {
                    console.error('Save Tag error:', err);
                }
            }
        });

        window.addEventListener('load', async () => {
            await initSql();
            if (!db) { createNewDatabase(); }
            showDashboard();
        });
    </script>
</body>

</html>