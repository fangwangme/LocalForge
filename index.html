<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalForge Dashboard</title>
    <script>
        // Suppress Tailwind production warning
        const originalWarn = console.warn;
        console.warn = function (...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                return;
            }
            originalWarn.apply(console, args);
        };
    </script>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
    <style>
        .sidebar-expanded {
            width: 16rem;
        }

        .sidebar-collapsed {
            width: 5rem;
        }

        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }

        /* Hide text in collapsed mode */
        .sidebar-collapsed .nav-text {
            display: none;
        }

        /* Center icons in collapsed mode */
        .sidebar-collapsed .nav-item {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        .sidebar-collapsed .section-title {
            display: none;
        }

        .sidebar-collapsed .logo-text {
            display: none;
        }
    </style>
</head>

<body>
    <div class="flex h-screen bg-slate-900 text-slate-100 font-sans overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="sidebar-expanded sidebar-transition bg-slate-900 border-r border-slate-800 flex flex-col z-20 relative">
            <!-- Sidebar Header -->
            <div class="h-16 flex items-center justify-between px-4 border-b border-slate-800 shrink-0">
                <div onclick="showDashboard()"
                    class="flex items-center gap-3 cursor-pointer overflow-hidden whitespace-nowrap">
                    <div
                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shrink-0">
                        <i class="fas fa-layer-group text-white text-sm"></i>
                    </div>
                    <span class="logo-text font-bold text-lg tracking-tight">LocalForge</span>
                </div>
                <!-- Toggle Button (Absolute to stay accessible) -->
                <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white transition p-1">
                    <i id="sidebar-toggle-icon" class="fas fa-chevron-left"></i>
                </button>
            </div>

            <!-- Nav Items -->
            <nav class="flex-1 overflow-y-auto py-4 overflow-x-hidden">
                <ul class="space-y-1 px-2">
                    <li>
                        <button onclick="showDashboard()" id="nav-home"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition active-nav whitespace-nowrap group">
                            <i class="fas fa-home w-6 text-center shrink-0 group-hover:text-blue-400 transition"></i>
                            <span class="nav-text font-medium ml-3">主页概览</span>
                        </button>
                    </li>

                    <div
                        class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                        媒体工具</div>
                    <li>
                        <a href="image_editor.html"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i class="fas fa-image w-6 text-center shrink-0 group-hover:text-purple-400 transition"></i>
                            <span class="nav-text ml-3">图片编辑器</span>
                        </a>
                    </li>
                    <li>
                        <a href="image_resize.html"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i
                                class="fas fa-compress-alt w-6 text-center shrink-0 group-hover:text-pink-400 transition"></i>
                            <span class="nav-text ml-3">图片压缩</span>
                        </a>
                    </li>

                    <div
                        class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                        健身运动</div>
                    <li>
                        <a href="hiit_jump_rope.html"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i
                                class="fas fa-stopwatch w-6 text-center shrink-0 group-hover:text-rose-400 transition"></i>
                            <span class="nav-text ml-3">HIIT 计时器</span>
                        </a>
                    </li>
                    <li>


                        <div
                            class="section-title px-4 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-4 whitespace-nowrap">
                            效率工具</div>
                    <li>
                        <a href="pomodoro.html"
                            class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap group">
                            <i class="fas fa-clock w-6 text-center shrink-0 group-hover:text-red-400 transition"></i>
                            <span class="nav-text ml-3">番茄钟</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Bottom Settings -->
            <div class="p-2 border-t border-slate-800">
                <button onclick="window.openSettings()"
                    class="nav-item w-full flex items-center px-4 py-3 text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition whitespace-nowrap">
                    <i class="fas fa-cog w-6 text-center shrink-0"></i>
                    <span class="nav-text ml-3">设置 & 数据库</span>
                </button>
            </div>
        </aside>

        <!-- Main Content (Dashboard Only) -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-900 relative">
            <!-- Header (Simplified) -->
            <header
                class="h-16 bg-slate-900 border-b border-slate-800 flex justify-between items-center px-6 shrink-0 z-10">
                <h2 id="page-title" class="text-lg font-medium text-white">主页概览</h2>
            </header>

            <!-- Content Area -->
            <div class="flex-1 relative overflow-hidden bg-slate-900">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="absolute inset-0 overflow-y-auto p-8">
                    <div class="max-w-5xl mx-auto space-y-10">

                        <!-- Section: 媒体工具 -->
                        <section>
                            <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-4 ml-1">媒体工具</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Image Editor -->
                                <a href="image_editor.html"
                                    class="group p-5 bg-slate-800 rounded-xl border border-slate-700 hover:border-blue-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden block">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition">
                                    </div>
                                    <div
                                        class="w-10 h-10 rounded-lg bg-blue-500/10 text-blue-400 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">图片编辑器</h3>
                                    <p class="text-slate-400 text-xs leading-relaxed">16:9 裁剪、去水印。</p>
                                </a>

                                <!-- Image Resize -->
                                <a href="image_resize.html"
                                    class="group p-5 bg-slate-800 rounded-xl border border-slate-700 hover:border-purple-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden block">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition">
                                    </div>
                                    <div
                                        class="w-10 h-10 rounded-lg bg-purple-500/10 text-purple-400 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                                        <i class="fas fa-compress-alt"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">图片压缩</h3>
                                    <p class="text-slate-400 text-xs leading-relaxed">智能压缩图片体积。</p>
                                </a>
                            </div>
                        </section>

                        <!-- Section: 健身运动 -->
                        <section>
                            <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-4 ml-1">健身运动</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- HIIT Timer -->
                                <a href="hiit_jump_rope.html"
                                    class="group p-5 bg-slate-800 rounded-xl border border-slate-700 hover:border-rose-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden block">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-br from-rose-500/10 to-transparent opacity-0 group-hover:opacity-100 transition">
                                    </div>
                                    <div
                                        class="w-10 h-10 rounded-lg bg-rose-500/10 text-rose-400 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                                        <i class="fas fa-stopwatch"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">HIIT 计时器</h3>
                                    <p class="text-slate-400 text-xs leading-relaxed">自定义间歇训练计时。</p>
                                </a>
                            </div>
                        </section>

                        <!-- Section: 效率工具 -->
                        <section>
                            <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-4 ml-1">效率工具</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Pomodoro -->
                                <a href="pomodoro.html"
                                    class="group p-5 bg-slate-800 rounded-xl border border-slate-700 hover:border-red-500/50 hover:bg-slate-800/80 transition cursor-pointer relative overflow-hidden block">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-br from-red-500/10 to-transparent opacity-0 group-hover:opacity-100 transition">
                                    </div>
                                    <div
                                        class="w-10 h-10 rounded-lg bg-red-500/10 text-red-400 flex items-center justify-center text-xl mb-3 group-hover:scale-110 transition">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <h3 class="text-base font-bold text-white mb-1">番茄钟</h3>
                                    <p class="text-slate-400 text-xs leading-relaxed">专注计时，历史记录。</p>
                                </a>
                            </div>
                        </section>

                    </div>
                </div>

            </div>
        </main>

        <!-- Hidden File Input for Legacy Browsers -->
        <input type="file" id="db-file-input" hidden accept=".sqlite,.db,application/x-sqlite3">

        <!-- Settings Modal Overlay -->
        <div id="settings-modal"
            class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center animate-fade-in"
            onclick="if(event.target === this) closeSettings()">
            <div
                class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">设置 & 数据库</h3>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-white">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- DB Status Section -->
                    <div class="bg-slate-900/50 rounded-lg p-4 border border-slate-700/50">
                        <div class="text-sm text-slate-400 mb-2">数据库状态</div>
                        <div id="modal-db-status" class="flex items-center gap-3 text-amber-400 font-medium">
                            <div class="w-3 h-3 rounded-full bg-amber-500 animate-pulse"></div>
                            <span id="modal-db-status-text">未连接 (使用内存暂存)</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openDatabase()"
                            class="flex flex-col items-center justify-center p-4 bg-indigo-600/10 border border-indigo-500/30 rounded-lg hover:bg-indigo-600/20 hover:border-indigo-500 transition group">
                            <i
                                class="fas fa-folder-open text-2xl text-indigo-400 mb-2 group-hover:scale-110 transition"></i>
                            <span class="text-indigo-100 font-medium">打开文件</span>
                        </button>

                        <button onclick="saveDatabaseToDisk(event)"
                            class="flex flex-col items-center justify-center p-4 bg-emerald-600/10 border border-emerald-500/30 rounded-lg hover:bg-emerald-600/20 hover:border-emerald-500 transition group">
                            <i class="fas fa-save text-2xl text-emerald-400 mb-2 group-hover:scale-110 transition"></i>
                            <span class="text-emerald-100 font-medium">保存到本地</span>
                        </button>
                    </div>

                    <!-- Reset/New Action -->
                    <button onclick="handleCreateNewDatabase()"
                        class="w-full mt-4 flex items-center justify-center gap-2 p-3 bg-slate-700/50 border border-slate-600 rounded-lg hover:bg-blue-500/20 hover:border-blue-500/50 hover:text-blue-300 transition text-slate-400 text-sm">
                        <i class="fas fa-plus-circle"></i> <span>新建本地数据库文件</span>
                    </button>

                    <div class="text-xs text-slate-500 text-center leading-relaxed mt-2">
                        注意：默认建议文件名为 <code>html_tools_db.sqlite</code>。<br>
                        <script type="module">
                            import { db } from './js/db-client.js';

                            // === State ===
                            let dbHandle = null; // FileSystemFileHandle
                            let isAutoSave = false;

                            // === Helper Functions (Exposed to Window) ===
                            window.toggleSidebar = () => {
                                const sidebar = document.getElementById('sidebar');
                                const toggleIcon = document.getElementById('sidebar-toggle-icon');
                                if (sidebar.classList.contains('sidebar-expanded')) {
                                    sidebar.classList.remove('sidebar-expanded');
                                    sidebar.classList.add('sidebar-collapsed');
                                    toggleIcon.classList.remove('fa-chevron-left');
                                    toggleIcon.classList.add('fa-chevron-right');
                                } else {
                                    sidebar.classList.remove('sidebar-collapsed');
                                    sidebar.classList.add('sidebar-expanded');
                                    toggleIcon.classList.remove('fa-chevron-right');
                                    toggleIcon.classList.add('fa-chevron-left');
                                }
                            };

                            window.showDashboard = () => {
                                // Just focus, maybe nothing else needed as we are single page now
                                // Or maybe reset scroll?
                            };

                            window.openSettings = () => {
                                document.getElementById('settings-modal').classList.remove('hidden');
                            };

                            window.closeSettings = () => {
                                document.getElementById('settings-modal').classList.add('hidden');
                            };

                            function updateDbStatus(text, color) {
                                const statusText = document.getElementById('modal-db-status-text');
                                const statusDot = document.querySelector('#modal-db-status div');
                                const statusContainer = document.getElementById('modal-db-status');

                                if (statusText) {
                                    statusText.innerText = text;
                                    statusContainer.className = `flex items-center gap-3 font-medium ${color === 'emerald' ? 'text-emerald-400' : 'text-amber-400'}`;
                                    statusDot.className = `w-3 h-3 rounded-full ${color === 'emerald' ? 'bg-emerald-500' : 'bg-amber-500'} ${color === 'amber' ? 'animate-pulse' : ''}`;
                                }
                            }

                            // === Database Logic Using db-client ===

                            // Listen for DB events
                            db.on('ready', () => {
                                updateDbStatus('引擎就绪', 'amber');
                                // Try load from IDB
                                loadSnapshotFromIDB().then(snapshot => {
                                    if (snapshot && snapshot.data) {
                                        if (snapshot.handle) dbHandle = snapshot.handle;
                                        db.init(snapshot.data).then(() => {
                                            updateDbStatus(dbHandle ? `已恢复: ${snapshot.filename || dbHandle.name}` : `已恢复: ${snapshot.filename || '缓存数据'}`, 'emerald');
                                        });
                                    } else {
                                        db.init().then(() => {
                                            updateDbStatus('新数据库 (内存)', 'amber');
                                        });
                                    }
                                });
                            });

                            db.on('db_opened', () => {
                                console.log('[Host] Database opened/connected');
                            });

                            db.on('db_updated', () => {
                                if (isAutoSave) window.triggerAutoSave();
                            });


                            window.handleCreateNewDatabase = async () => {
                                if (confirm('确定要新建吗？如果当前有未保存的数据，将会丢失。')) {
                                    await db.init(); // Re-init with empty
                                    dbHandle = null;
                                    updateDbStatus('新建数据库 (未保存)', 'amber');
                                }
                            };

                            window.triggerAutoSave = () => {
                                window.saveDatabaseToDisk(null, true);
                            };

                            window.openDatabase = async () => {
                                if (typeof window.showOpenFilePicker === 'function') {
                                    try {
                                        const [handle] = await window.showOpenFilePicker({
                                            types: [{ description: 'SQLite Database', accept: { 'application/x-sqlite3': ['.sqlite', '.db'] } }]
                                        });
                                        const file = await handle.getFile();
                                        const arrayBuffer = await file.arrayBuffer();

                                        await db.init(arrayBuffer);

                                        dbHandle = handle;
                                        updateDbStatus(`已加载: ${file.name}`, 'emerald');

                                        // IDB Cache
                                        const u8 = new Uint8Array(arrayBuffer);
                                        saveSnapshotToIDB(u8, handle, file.name);

                                        // window.closeSettings();
                                        setTimeout(window.closeSettings, 2000); // Close after delay

                                    } catch (err) {
                                        if (err.name !== 'AbortError') {
                                            console.error(err);
                                            alert('打开文件失败: ' + err.message);
                                        }
                                    }
                                } else {
                                    document.getElementById('db-file-input').click();
                                }
                            };

                            window.saveDatabaseToDisk = async (event, isAuto = false) => {
                                try {
                                    const data = await db.export(); // Uint8Array

                                    if (dbHandle) {
                                        // Permission Check
                                        const opts = { mode: 'readwrite' };
                                        if ((await dbHandle.queryPermission(opts)) !== 'granted') {
                                            if (isAuto) {
                                                updateDbStatus('自动保存暂停 (需手动保存验证)', 'amber');
                                                return;
                                            }
                                            if ((await dbHandle.requestPermission(opts)) !== 'granted') return;
                                        }

                                        const writable = await dbHandle.createWritable();
                                        await writable.write(data);
                                        await writable.close();

                                        updateDbStatus(`已保存: ${dbHandle.name}`, 'emerald');
                                        saveSnapshotToIDB(data, dbHandle, dbHandle.name);

                                        // Feedback
                                        if (event && event.currentTarget) {
                                            const icon = event.currentTarget.querySelector('i');
                                            if (icon) {
                                                const tempClass = icon.className;
                                                icon.className = 'fas fa-check text-white';
                                                setTimeout(() => icon.className = tempClass, 1500);
                                            }
                                        }
                                    } else if (!isAuto) {
                                        const handle = await window.showSaveFilePicker({
                                            types: [{ description: 'SQLite Database', accept: { 'application/x-sqlite3': ['.sqlite', '.db'] } }],
                                            suggestedName: `html_tools_db_${new Date().toISOString().slice(0, 10)}.sqlite`
                                        });
                                        dbHandle = handle;
                                        const writable = await handle.createWritable();
                                        await writable.write(data);
                                        await writable.close();

                                        saveSnapshotToIDB(data, dbHandle, handle.name);
                                        updateDbStatus(`已保存: ${handle.name}`, 'emerald');
                                    } else {
                                        // Legacy download fallback
                                        if (isAuto) return;
                                        const blob = new Blob([data], { type: 'application/x-sqlite3' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `localforge_backup_${Date.now()}.sqlite`;
                                        a.click();
                                    }
                                } catch (err) {
                                    console.error('Save failed:', err);
                                }
                            };

                            // Handle Legacy Input
                            document.getElementById('db-file-input').addEventListener('change', async (e) => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const buf = await file.arrayBuffer();
                                await db.init(buf);
                                dbHandle = null;
                                saveSnapshotToIDB(new Uint8Array(buf), null, file.name);
                                updateDbStatus(`已加载: ${file.name} (Legacy)`, 'emerald');
                                // window.closeSettings();
                                setTimeout(window.closeSettings, 2000);
                            });

                            // === IDB Persistence (Keep same logic) ===
                            const IDB_NAME = 'LocalForgeDB';
                            const IDB_STORE = 'snapshots';
                            const IDB_KEY = 'main_db';

                            function openIndexedDB() {
                                return new Promise((resolve, reject) => {
                                    const request = indexedDB.open(IDB_NAME, 1);
                                    request.onupgradeneeded = (event) => {
                                        const db = event.target.result;
                                        if (!db.objectStoreNames.contains(IDB_STORE)) {
                                            db.createObjectStore(IDB_STORE);
                                        }
                                    };
                                    request.onsuccess = (event) => resolve(event.target.result);
                                    request.onerror = (event) => reject(event.target.error);
                                });
                            }

                            async function saveSnapshotToIDB(data, handle = null, filename = null) {
                                try {
                                    const idb = await openIndexedDB();
                                    const tx = idb.transaction(IDB_STORE, 'readwrite');
                                    const store = tx.objectStore(IDB_STORE);
                                    const record = { data: data, updated_at: Date.now() };
                                    if (handle) record.handle = handle;
                                    if (filename) record.filename = filename;
                                    if (dbHandle && !handle) record.handle = dbHandle;
                                    store.put(record, IDB_KEY);
                                    return new Promise((resolve, reject) => {
                                        tx.oncomplete = resolve;
                                        tx.onerror = reject;
                                    });
                                } catch (err) { console.error('IDB Save Error:', err); }
                            }

                            async function loadSnapshotFromIDB() {
                                try {
                                    const idb = await openIndexedDB();
                                    const tx = idb.transaction(IDB_STORE, 'readonly');
                                    const store = tx.objectStore(IDB_STORE);
                                    const request = store.get(IDB_KEY);
                                    return new Promise((resolve, reject) => {
                                        request.onsuccess = () => resolve(request.result);
                                        request.onerror = () => reject(request.error);
                                    });
                                } catch (err) { console.error('IDB Load Error:', err); return null; }
                            }

                            // Init Autosave Toggle
                            const autoSaveToggle = document.getElementById('autoSaveToggle');
                            if (autoSaveToggle) {
                                autoSaveToggle.addEventListener('change', (e) => {
                                    isAutoSave = e.target.checked;
                                    if (isAutoSave) window.triggerAutoSave();
                                });
                            }
                        </script>
</body>

</html>