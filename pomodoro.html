<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟 - LocalForge</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Custom Components -->
    <script type="module" src="js/components.js"></script>
    <!-- Global Styles -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(12px, 1fr));
            gap: 2px;
        }

        .pixel-block {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .pixel-filled {
            box-shadow: 0 0 2px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse-yellow {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7);
                opacity: 0.7;
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 6px rgba(234, 179, 8, 0);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
                opacity: 0.7;
            }
        }

        .animate-pulse-yellow {
            animation: pulse-yellow 2s infinite;
        }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <local-sidebar></local-sidebar>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col min-w-0 relative">

        <!-- Header -->
        <local-header title="番茄钟">
            <i slot="icon" class="fas fa-clock text-rose-500"></i>
            <div slot="actions" class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="openTagsManagement()" class="p-3 text-slate-400 hover:text-white transition"
                        title="管理标签">
                        <i class="fas fa-tags text-xl"></i>
                    </button>
                    <button onclick="openStats()" class="p-3 text-slate-400 hover:text-white transition" title="统计历史">
                        <i class="fas fa-history text-xl"></i>
                    </button>
                </div>
            </div>
        </local-header>

        <div class="flex-1 overflow-y-auto">
            <main class="max-w-4xl mx-auto px-4 py-8">

                <!-- Timer View -->
                <div id="timerView" class="flex flex-col items-center justify-center min-h-[60vh]">

                    <!-- Digital Timer -->
                    <div class="text-[8rem] font-bold font-mono tracking-tighter leading-none mb-4 tabular-nums text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400"
                        id="digitalTimer">
                        25:00
                    </div>

                    <!-- Pixel Tomato -->
                    <div class="w-full max-w-md mb-12">
                        <div id="pixelGrid"
                            class="pixel-grid bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 backdrop-blur-sm">
                            <!-- Blocks injected here -->
                        </div>
                        <div class="text-center mt-2 text-xs text-slate-500">
                            <span id="progressText">0 / 25 min</span>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex items-center gap-6">
                        <!-- Tag Selector (Hidden - now in save modal) -->
                        <div class="relative group hidden" id="mainTagSelector">
                            <button onclick="toggleTagMenu()" id="currentTagBtn"
                                class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 hover:border-slate-600 text-sm transition h-10">
                                <span id="currentTagDot" class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
                                <span id="currentTagName">Default</span>
                                <i class="fas fa-chevron-down text-xs text-slate-500"></i>
                            </button>
                            <div id="tagMenu"
                                class="hidden absolute bottom-full left-0 mb-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-2 z-20">
                                <div id="tagList" class="max-h-60 overflow-y-auto">
                                    <!-- Tags rendered here -->
                                </div>
                                <div class="border-t border-slate-700 mt-1 pt-1 px-2">
                                    <button onclick="openAddTagModal()"
                                        class="w-full text-left px-2 py-1.5 text-xs text-slate-400 hover:text-white rounded hover:bg-slate-700 transition flex items-center gap-2">
                                        <i class="fas fa-plus"></i> 新建标签
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Settings (Only valid when stopped) -->
                        <div id="durationSettings"
                            class="flex items-center bg-slate-800 rounded-full p-1 border border-slate-700">
                            <button onclick="setDuration(5)"
                                class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                data-min="5">5</button>
                            <button onclick="setDuration(15)"
                                class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                data-min="15">15</button>
                            <button onclick="setDuration(25)"
                                class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm"
                                data-min="25">25</button>
                            <button onclick="setDuration(45)"
                                class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                data-min="45">45</button>
                            <button onclick="setDuration(60)"
                                class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                                data-min="60">60</button>
                            <button onclick="askCustomDuration()"
                                class="px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"><i
                                    class="fas fa-edit"></i></button>
                        </div>

                        <!-- Main Action -->
                        <button id="mainBtn" onclick="toggleTimer()"
                            class="h-16 w-16 rounded-full bg-rose-500 hover:bg-rose-400 text-white text-2xl flex items-center justify-center shadow-lg shadow-rose-500/30 transition transform hover:scale-105 active:scale-95">
                            <i class="fas fa-play ml-1"></i>
                        </button>

                        <!-- Stop Button (Hidden by default, shown when running) -->
                        <button id="resetBtn" onclick="resetTimer()"
                            class="hidden h-12 w-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center shadow-lg transition">
                            <i class="fas fa-stop"></i>
                        </button>



                    </div>

                    <!-- Notification Toggle -->
                    <div class="mt-8 flex items-center gap-2 opacity-50 hover:opacity-100 transition duration-300">
                        <input type="checkbox" id="notifyToggle" checked
                            class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-rose-500 focus:ring-rose-500 focus:ring-offset-slate-900 cursor-pointer accent-rose-500">
                        <label for="notifyToggle"
                            class="text-sm text-slate-400 cursor-pointer select-none">任务结束通知</label>
                    </div>
                </div>



            </main>
        </div>
    </div>

    <!-- Save Modal -->
    <!-- Stats View (Modal/Overlay) -->
    <div id="statsOverlay"
        class="fixed inset-0 bg-slate-900 z-[60] transform translate-y-full transition duration-300 overflow-y-auto">
        <div class="max-w-5xl mx-auto px-4 pb-8">
            <div
                class="sticky top-0 z-[70] bg-slate-900/95 backdrop-blur pt-8 pb-4 mb-6 flex justify-between items-center border-b border-slate-800/50">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-chart-pie text-rose-500"></i> 数据概览
                </h2>
                <div class="flex items-center gap-4">
                    <!-- Unified Time Range Toggle -->
                    <div class="flex bg-slate-800 rounded-lg p-0.5 border border-slate-700">
                        <button onclick="setStatsTimeRange('today')" id="statsRangeToday"
                            class="px-3 py-1.5 text-xs rounded-md transition bg-rose-600 text-white shadow-sm">今天</button>
                        <button onclick="setStatsTimeRange('week')" id="statsRangeWeek"
                            class="px-3 py-1.5 text-xs rounded-md transition text-slate-400 hover:text-white">本周</button>
                    </div>
                    <button onclick="closeStats()"
                        class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition text-sm font-medium">
                        关闭
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">专注次数</div>
                    <div class="text-2xl font-bold text-white"><span id="statsFocusCount">0</span> <span
                            class="text-sm font-normal text-slate-500">个番茄</span></div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">总时长</div>
                    <div class="text-xl font-bold text-blue-400" id="statsTotalTime">0分钟</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">有效时长</div>
                    <div class="text-xl font-bold text-emerald-400" id="statsEffectiveTime">0分钟</div>
                    <div class="text-xs text-slate-500 mt-1">不含 Default</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                    <div class="text-slate-400 text-xs mb-1">标签数</div>
                    <div class="text-2xl font-bold text-amber-400"><span id="statsTagCount">0</span> <span
                            class="text-sm font-normal text-slate-500">个</span></div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="md:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-medium text-slate-300">专注趋势</h3>
                        <div class="flex items-center gap-4">
                            <button onclick="toggleFullView()" id="fullViewBtn"
                                class="px-2 py-1 text-xs border border-slate-600 rounded text-slate-400 hover:text-white hover:border-slate-400 transition">
                                <i class="fas fa-expand"></i> 全景
                            </button>
                            <button onclick="openExportPanoramaModal()"
                                class="px-2 py-1 text-xs border border-emerald-600 rounded text-emerald-400 hover:text-white hover:border-emerald-400 hover:bg-emerald-600/20 transition">
                                <i class="fas fa-image"></i> 导出
                            </button>
                            <div class="flex items-center gap-2 text-xs text-slate-400" id="sliderContainer">
                                <button onclick="moveSlider(-1)" class="p-1 hover:text-white transition"><i
                                        class="fas fa-chevron-left"></i></button>
                                <input type="range" id="chartSlider" min="0" max="20" step="1" value="0"
                                    class="w-24 md:w-32 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                    oninput="onSliderChange(this.value)">
                                <button onclick="moveSlider(1)" class="p-1 hover:text-white transition"><i
                                        class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-medium text-slate-300">分布占比</h3>
                    </div>
                    <div class="h-64 flex items-center justify-center">
                        <canvas id="distChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- History List (Unified with Export) -->
            <div class="bg-slate-800 rounded-xl border border-slate-700/50 overflow-hidden">
                <!-- Header with Filters -->
                <div class="p-4 border-b border-slate-700">
                    <div class="flex flex-wrap gap-3 items-center justify-between">
                        <h3 class="font-medium text-slate-300">详细记录</h3>
                        <div class="flex flex-wrap gap-2 items-center">
                            <!-- Quick Filters -->
                            <div class="flex bg-slate-900 rounded-lg p-0.5">
                                <button onclick="setHistoryFilter('today')" id="filterBtnToday"
                                    class="px-3 py-1 text-xs rounded-md transition bg-blue-600 text-white">今天</button>
                                <button onclick="setHistoryFilter('week')" id="filterBtnWeek"
                                    class="px-3 py-1 text-xs rounded-md transition text-slate-400 hover:text-white">本周</button>
                                <button onclick="setHistoryFilter('all')" id="filterBtnAll"
                                    class="px-3 py-1 text-xs rounded-md transition text-slate-400 hover:text-white">全部</button>
                            </div>
                            <div class="h-4 w-px bg-slate-600 hidden sm:block"></div>
                            <!-- Date Picker -->
                            <input type="date" id="historyDatePicker" onchange="setHistoryFilter('date')"
                                class="bg-slate-900 border border-slate-700 text-xs rounded px-2 py-1 text-white outline-none focus:border-blue-500">
                        </div>
                    </div>
                    <!-- Status & Export Controls -->
                    <div
                        class="flex flex-wrap gap-3 items-center justify-between mt-3 pt-3 border-t border-slate-700/50">
                        <div id="historyStatus" class="text-xs text-slate-500">加载中...</div>
                        <div class="flex gap-2 items-center">
                            <label class="flex items-center gap-1.5 text-xs text-slate-400 cursor-pointer">
                                <input type="checkbox" id="exportExcludeRelax" class="rounded w-3 h-3">
                                导出时排除休息
                            </label>
                            <button onclick="exportCurrentList()"
                                class="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition flex items-center gap-1.5">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                        </div>
                    </div>
                </div>
                <!-- History Items -->
                <div id="historyList" class="divide-y divide-slate-700/50 max-h-[400px] overflow-y-auto">
                    <!-- Items rendered by JS -->
                </div>
            </div>
        </div>
    </div>
    <!-- Save Modal -->
    <div id="saveModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div
            class="bg-slate-800 border-t-4 border-rose-500 rounded-2xl w-full max-w-sm p-8 shadow-2xl transform scale-90 transition-transform duration-300">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-3xl animate-bounce">
                    <i class="fas fa-check"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">专注达成！</h3>
                <p class="text-slate-400">刚刚完成了 <span id="saveDuration" class="text-white font-bold">25</span> 分钟的专注。
                </p>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6">
                <div class="mb-3 relative">
                    <label class="block text-xs text-slate-500 mb-1">标签</label>
                    <div class="relative" id="saveTagCustomSelector">
                        <button type="button" onclick="toggleSaveTagMenu()" id="saveTagBtn"
                            class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white hover:border-slate-600 focus:border-rose-500 outline-none transition text-left flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span id="saveSelectedTagDot" class="w-2.5 h-2.5 rounded-full bg-slate-500"></span>
                                <span id="saveSelectedTagName">Default</span>
                            </div>
                            <i class="fas fa-chevron-down text-xs text-slate-500"></i>
                        </button>
                        <div id="saveTagMenu"
                            class="hidden absolute top-full left-0 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-1 z-50 max-h-48 overflow-y-auto mt-1">
                            <!-- Items rendered here -->
                        </div>
                        <!-- Hidden input to store value -->
                        <input type="hidden" id="saveTagValue">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-xs text-slate-500 mb-1">标题</label>
                    <input type="text" id="saveTitle" placeholder="做了什么？"
                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white placeholder-slate-500 focus:border-rose-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-500 mb-1">备注 (可选)</label>
                    <textarea id="saveDescription" rows="2" placeholder="补充说明..."
                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white placeholder-slate-500 focus:border-rose-500 outline-none transition resize-none"></textarea>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="discardSession()"
                    class="py-3 rounded-xl border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">
                    丢弃
                </button>
                <button onclick="confirmSaveSession()"
                    class="py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white font-bold shadow-lg shadow-rose-600/20 transition">
                    记录
                </button>
            </div>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagsManagementModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-white flex items-center gap-2">
                    <i class="fas fa-tags text-rose-500"></i> 标签管理
                </h3>
                <button onclick="closeTagsManagement()" class="text-slate-400 hover:text-white transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <button onclick="openAddTagModal()"
                    class="w-full py-2 bg-slate-700/50 hover:bg-slate-700 border border-slate-600 border-dashed text-slate-300 rounded-lg text-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> 新建标签
                </button>
            </div>

            <div id="manageTagList" class="space-y-2 max-h-80 overflow-y-auto pr-1">
                <!-- Tags rendered here -->
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="closeTagsManagement()"
                    class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <div id="addTagModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4" id="tagModalTitle">新建标签</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">名称</label>
                    <input type="text" id="newTagName" placeholder="例如：Coding"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">颜色</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="newTagColor" value="#3b82f6"
                            class="w-10 h-10 p-0 rounded border-none cursor-pointer bg-transparent">
                        <span class="text-xs text-slate-500">点击色块选择颜色</span>
                    </div>
                </div>
                <div class="flex items-center gap-2 pt-2">
                    <input type="checkbox" id="newTagDefault"
                        class="w-4 h-4 rounded border-slate-600 bg-slate-900 text-blue-500 focus:ring-blue-500 cursor-pointer accent-blue-500">
                    <label for="newTagDefault" class="text-xs text-slate-400 cursor-pointer select-none">设为默认标签</label>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('addTagModal').classList.add('hidden')"
                    class="px-3 py-1.5 text-xs text-slate-400 hover:text-white">取消</button>
                <button onclick="confirmAddTag()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded">保存</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-white">编辑记录</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">开始时间</label>
                    <input type="datetime-local" id="editStartTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">结束时间</label>
                    <input type="datetime-local" id="editEndTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">标签</label>
                        <select id="editTagSelect"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">状态</label>
                        <select id="editStatusSelect"
                            class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                            <option value="completed">✅ 已完成</option>
                            <option value="aborted">⏹️ 中断</option>
                            <option value="in_progress">⏳ 进行中</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">标题</label>
                    <input type="text" id="editTitle" placeholder="事件名称"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">备注</label>
                    <textarea id="editDescription" rows="2" placeholder="可选备注..."
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEditSessionModal()"
                    class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">取消</button>
                <button onclick="confirmEditSession()"
                    class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">保存</button>
            </div>
        </div>
    </div>

    <!-- Custom Duration Modal -->
    <div id="customDurationModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">自定义时长</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <button onclick="adjustCustomInput(-5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-minus"></i></button>
                        <div class="text-3xl font-bold font-mono text-blue-400 w-20 text-center">
                            <span id="customInputDisplay">25</span>
                        </div>
                        <button onclick="adjustCustomInput(5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-plus"></i></button>
                    </div>
                    <input type="range" id="customInputRange" min="1" max="180" step="1" value="25"
                        class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2"
                        oninput="updateCustomDisplay(this.value)">
                    <p class="text-center text-xs text-slate-500">分钟</p>
                </div>
            </div>
            <div class="flex justify-between gap-3 mt-6">
                <button onclick="closeCustomDuration()"
                    class="flex-1 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">取消</button>
                <button onclick="confirmCustomDuration()"
                    class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">确定</button>
            </div>
        </div>
    </div>

    <!-- Export Records Modal (Daily Markdown) -->
    <div id="exportRecordsModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-white flex items-center gap-2">
                <i class="fas fa-file-export text-blue-400"></i> 导出记录
                <span id="exportDateLabel" class="text-sm font-normal text-slate-400 ml-auto"></span>
            </h3>
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="exportIncludeRelax"
                        class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-blue-500 focus:ring-blue-500 cursor-pointer accent-blue-500">
                    <label for="exportIncludeRelax"
                        class="text-sm text-slate-300 cursor-pointer select-none">包含休息时段</label>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Markdown 输出</label>
                    <textarea id="exportRecordsOutput" rows="10" readonly
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-slate-300 font-mono focus:border-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeExportRecordsModal()"
                    class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">关闭</button>
                <button onclick="copyExportRecords()"
                    class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition flex items-center gap-2">
                    <i class="fas fa-copy"></i> 复制
                </button>
            </div>
        </div>
    </div>

    <!-- Export Panorama Modal (7-Day PNG) -->
    <div id="exportPanoramaModal" style="z-index: 100;"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center overflow-y-auto py-8">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-2xl p-6 shadow-2xl my-auto">
            <h3 class="font-bold text-lg mb-4 text-white flex items-center gap-2">
                <i class="fas fa-image text-emerald-400"></i> 导出7日全景图
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">选择周起始日期（周一）</label>
                    <input type="date" id="exportPanoramaDate"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <!-- Preview Container -->
                <div id="panoramaPreview" class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="text-center text-slate-500 py-8">选择日期后生成预览</div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeExportPanoramaModal()"
                    class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">关闭</button>
                <button onclick="downloadPanoramaPNG()"
                    class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-600/20 transition flex items-center gap-2">
                    <i class="fas fa-download"></i> 下载 PNG
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/db-client.js';

        console.log('[Pomodoro] Script starting...');

        // === State ===
        let currentState = 'stopped'; // stopped, running
        let currentEditTagId = null; // null for add, id for edit
        let pendingAbort = false; // true if user clicked stop button (for save modal)
        let durationMinutes = 25;
        let timeLeftSeconds = 25 * 60;
        let timerInterval = null;
        let startTime = null;
        let sessionEndTime = null; // Track when timer actually ends (not when user confirms)

        let currentTag = null; // Will be set on load
        let tags = [];
        let sessions = [];
        let statsTimeRange = 'today'; // Unified time range for Summary Cards and Distribution Chart

        // === Session Tracking ===
        let currentSessionId = null; // Track record ID in DB for early save/periodic update
        let lastSyncTime = 0;       // Last time we updated DB
        let lastUpdateCheckSecs = 0; // The timeLeft value at last DB update

        // === DOM Elements ===
        const els = {
            digital: document.getElementById('digitalTimer'),
            pixelGrid: document.getElementById('pixelGrid'),
            mainBtn: document.getElementById('mainBtn'),
            resetBtn: document.getElementById('resetBtn'),
            durationBtns: document.querySelectorAll('.duration-btn'),
            statsOverlay: document.getElementById('statsOverlay'),
            saveModal: document.getElementById('saveModal'),
            tagMenu: document.getElementById('tagMenu'),
            tagList: document.getElementById('tagList'),
            currentTagName: document.getElementById('currentTagName'),
            currentTagDot: document.getElementById('currentTagDot'),
            currentTagBtn: document.getElementById('currentTagBtn'),
            progressText: document.getElementById('progressText')
        };

        // === Init ===
        async function init() {
            console.log('[Pomodoro] init() called.');

            // 1. DB Init
            await initTables();

            // 2. Data Init
            await requestData();

            // Notify Toggle & Permission Sync
            const notifyToggle = document.getElementById('notifyToggle');

            if ('Notification' in window) {
                // Always default to checked as requested
                notifyToggle.checked = true;

                // Sync initial UI state with permission
                if (notifyToggle.checked && Notification.permission === 'granted') {
                    notifyToggle.parentElement.classList.remove('opacity-50');
                } else {
                    notifyToggle.parentElement.classList.add('opacity-50');
                }

                // Handle User Click - request permission when checked
                notifyToggle.addEventListener('change', (e) => {
                    if (notifyToggle.checked) {
                        if (Notification.permission === 'granted') {
                            notifyToggle.parentElement.classList.remove('opacity-50');
                        } else if (Notification.permission === 'denied') {
                            notifyToggle.checked = false;
                            alert('请在浏览器设置中允许通知权限。');
                        } else {
                            Notification.requestPermission().then(perm => {
                                if (perm === 'granted') {
                                    notifyToggle.parentElement.classList.remove('opacity-50');
                                } else {
                                    notifyToggle.checked = false;
                                    if (perm === 'denied') {
                                        alert('请在浏览器设置中允许通知权限。');
                                    }
                                }
                            });
                        }
                    } else {
                        notifyToggle.parentElement.classList.add('opacity-50');
                    }
                });
            } else {
                notifyToggle.parentElement.classList.add('opacity-50');
                notifyToggle.checked = false;
                notifyToggle.disabled = true;
            }

            // 3. Global Click Listener for Tag Menu
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('tagMenu');
                const btn = document.getElementById('currentTagBtn');
                // If menu is open, and click is NOT on menu AND NOT on button, close it.
                if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.add('hidden');
                }

                const saveMenu = document.getElementById('saveTagMenu');
                const saveBtn = document.getElementById('saveTagBtn');
                // Check if elements exist (save modal might be hidden/inactive but elements are in DOM)
                if (saveMenu && saveBtn && !saveMenu.classList.contains('hidden') && !saveMenu.contains(e.target) && !saveBtn.contains(e.target)) {
                    saveMenu.classList.add('hidden');
                }
            });
        }

        // === Timer State Persistence ===
        // Note: Sessions are now written to DB early to prevent data loss.
        // We use currentSessionId to track the row across updates.

        let isUpserting = false; // Prevent concurrent upsert calls
        async function upsertSessionRecord() {
            if (!startTime || !currentTag || isUpserting) return;
            isUpserting = true;

            const startStr = startTime.toISOString();
            const tagId = currentTag.id;

            try {
                // Check if already exists (prevent duplicate start for same tag and time)
                const existing = await db.query(
                    "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                    [startStr, tagId]
                );

                if (existing && existing[0] && existing[0].values.length > 0) {
                    currentSessionId = existing[0].values[0][0];
                    console.log('[Pomodoro] Resumed existing record:', currentSessionId);
                    isUpserting = false;
                    return;
                }

                // Create new record
                const res = await db.execute(
                    `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) 
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                    [startStr, startStr, 0, tagId, 'in_progress', '', '', new Date().toISOString()]
                );

                if (res && res.lastInsertRowid) {
                    currentSessionId = res.lastInsertRowid;
                    console.log('[Pomodoro] Created early session record:', currentSessionId);
                }
            } catch (err) {
                console.error('[Pomodoro] upsertSessionRecord failed:', err);
            } finally {
                isUpserting = false;
            }
        }

        async function updateActiveSessionProgress() {
            if (!currentSessionId) return;

            const elapsedMinutes = Math.max(0, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));
            const nowStr = new Date().toISOString();

            try {
                await db.execute(
                    "UPDATE pomodoro_sessions SET duration_minutes = ?, end_time = ? WHERE id = ?",
                    [elapsedMinutes, nowStr, currentSessionId]
                );
                lastSyncTime = Date.now();
                lastUpdateCheckSecs = timeLeftSeconds;
                console.log('[Pomodoro] Session progress synced:', elapsedMinutes, 'mins');
            } catch (err) {
                console.error('[Pomodoro] updateActiveSessionProgress failed:', err);
            }
        }


        // === Timer Logic ===
        function setDuration(mins) {
            if (currentState === 'running') return;
            durationMinutes = mins;
            timeLeftSeconds = mins * 60;
            updateDigitalDisplay();
            renderPixels();

            // UI Update
            els.durationBtns.forEach(btn => {
                const btnMins = parseInt(btn.dataset.min);
                if (btnMins === mins) {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm';
                } else {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white';
                }
            });
        }

        function askCustomDuration() {
            if (currentState === 'running') return;
            const modal = document.getElementById('customDurationModal');
            const range = document.getElementById('customInputRange');
            // Set current
            range.value = durationMinutes;
            updateCustomDisplay(durationMinutes);

            modal.classList.remove('hidden');
        }

        function closeCustomDuration() {
            document.getElementById('customDurationModal').classList.add('hidden');
        }

        function updateCustomDisplay(val) {
            document.getElementById('customInputDisplay').innerText = val;
            document.getElementById('customInputRange').value = val;
        }

        function adjustCustomInput(delta) {
            const range = document.getElementById('customInputRange');
            let val = parseInt(range.value) + delta;
            if (val < 1) val = 1;
            if (val > 180) val = 180;
            updateCustomDisplay(val);
        }

        function confirmCustomDuration() {
            const val = parseInt(document.getElementById('customInputRange').value);
            setDuration(val);
            closeCustomDuration();
        }

        async function toggleTimer() {
            // Only start if stopped - there's no pause, only stop (reset button)
            if (currentState === 'stopped') {
                await startTimer();
            }
            // When running, user can only use reset button to stop
        }

        let targetEndTime = null;
        let segmentStartTime = null; // Track when current segment started

        async function startTimer() {
            if (currentState === 'running') return;
            currentState = 'running'; // Set immediately to prevent toggle race

            // Initialize new session
            startTime = new Date();
            timeLeftSeconds = durationMinutes * 60;

            // Reset session tracking
            currentSessionId = null;
            lastSyncTime = Date.now();
            lastUpdateCheckSecs = timeLeftSeconds;

            // Track segment start time
            segmentStartTime = new Date();

            // Calculate target end time based on current remaining seconds
            targetEndTime = Date.now() + (timeLeftSeconds * 1000);

            // UI Adjustments
            els.mainBtn.classList.add('hidden');
            els.currentTagBtn.classList.add('opacity-50', 'cursor-not-allowed');
            els.tagMenu.classList.add('hidden');

            els.resetBtn.classList.remove('hidden');
            els.resetBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            els.resetBtn.classList.add('opacity-100', 'cursor-pointer', 'bg-red-500', 'hover:bg-red-600');
            els.resetBtn.onclick = resetTimer;
            els.resetBtn.innerHTML = '<i class="fas fa-stop"></i>';

            // Early save to prevent data loss - Await to ensure ID is set before interval or save actions
            await upsertSessionRecord();

            // Use timestamp diffing for accuracy
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((targetEndTime - now) / 1000);

                if (diff > 0) {
                    if (timeLeftSeconds !== diff) {
                        timeLeftSeconds = diff;
                        updateDigitalDisplay();
                        updatePixelDisplay();

                        // Periodic Sync every 30 seconds
                        if (lastUpdateCheckSecs - timeLeftSeconds >= 30) {
                            updateActiveSessionProgress();
                        }
                    }
                } else {
                    timeLeftSeconds = 0;
                    updateDigitalDisplay();
                    updatePixelDisplay();
                    completeSession();
                }
            }, 200);
        }

        // pauseTimer removed - no pause functionality

        async function resetTimer() {
            // Stop timer and show save modal with abort status
            currentState = 'stopped';
            clearInterval(timerInterval);

            pendingAbort = true; // Mark as abort for save modal
            sessionEndTime = new Date(); // Record actual end time

            // Show Modal (same as completeSession, but status will be 'aborted')
            const elapsedMinutes = Math.max(1, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));
            document.getElementById('saveDuration').innerText = elapsedMinutes;
            renderSaveModalTagOptions(); // Populate tag dropdown
            document.getElementById('saveTitle').value = '';
            document.getElementById('saveDescription').value = '';

            const modal = els.saveModal;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-90');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        async function completeSession() {
            // Stop intervals without completing segment (will be done via save modal)
            currentState = 'stopped';
            clearInterval(timerInterval);
            pendingAbort = false; // This is a completed session, not aborted
            sessionEndTime = new Date(); // Record actual end time

            playCompletionSound();

            // System Notification
            const notifyToggle = document.getElementById('notifyToggle');
            console.log('[Pomodoro] Notification check:', {
                checked: notifyToggle?.checked,
                permission: typeof Notification !== 'undefined' ? Notification.permission : 'N/A'
            });

            if (notifyToggle && notifyToggle.checked) {
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    try {
                        const n = new Notification('专注完成！', {
                            body: `恭喜！你刚刚完成了 ${durationMinutes} 分钟的专注。`,
                            icon: 'favicon.png',
                            tag: 'pomodoro-complete'
                        });
                        console.log('[Pomodoro] Notification sent:', n);
                    } catch (e) {
                        console.error('[Pomodoro] Notify Error:', e);
                    }
                } else {
                    console.log('[Pomodoro] Notification permission not granted, requesting...');
                    Notification.requestPermission();
                }
            }


            // Show Modal
            document.getElementById('saveDuration').innerText = durationMinutes;
            renderSaveModalTagOptions(); // Populate tag dropdown
            document.getElementById('saveTitle').value = ''; // Clear previous input
            document.getElementById('saveDescription').value = ''; // Clear previous input

            const modal = els.saveModal;
            modal.classList.remove('hidden');
            // Trigger animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-90');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        async function discardSession() {
            // Get selected tag from modal dropdown (in case user selected one before discarding)
            const selectedTagId = parseInt(document.getElementById('saveTagValue').value);
            const selectedTag = tags.find(t => t.id === selectedTagId) || currentTag;

            closeSaveModal();

            // Write an aborted record to track the discarded session
            const end = sessionEndTime || new Date();
            const start = startTime || new Date(end.getTime() - durationMinutes * 60000);
            const actualDuration = Math.max(0, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60));

            try {
                if (currentSessionId) {
                    await db.execute(
                        "UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ? WHERE id = ?",
                        [end.toISOString(), actualDuration, selectedTag.id, 'aborted', currentSessionId]
                    );
                } else {
                    // Fallback: Triple check if record exists before inserting
                    const existing = await db.query(
                        "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                        [start.toISOString(), selectedTag.id]
                    );

                    if (existing && existing[0] && existing[0].values.length > 0) {
                        const foundId = existing[0].values[0][0];
                        await db.execute(
                            "UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ? WHERE id = ?",
                            [end.toISOString(), actualDuration, selectedTag.id, 'aborted', foundId]
                        );
                    } else {
                        await db.execute(
                            `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                            [start.toISOString(), end.toISOString(), actualDuration, selectedTag.id, 'aborted', '', '', new Date().toISOString()]
                        );
                    }
                }
                console.log('[Pomodoro] Discarded session saved as aborted');
            } catch (err) {
                console.error('[Pomodoro] Failed to save aborted session:', err);
            }

            currentSessionId = null; // Clear tracking
            resetTimerUI();
        }

        // === Save Modal Tag Logic ===
        function toggleSaveTagMenu() {
            const menu = document.getElementById('saveTagMenu');
            menu.classList.toggle('hidden');
        }

        function selectSaveTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                document.getElementById('saveSelectedTagName').innerText = t.name;
                document.getElementById('saveSelectedTagDot').style.backgroundColor = t.color;
                document.getElementById('saveTagValue').value = t.id;
            }
            document.getElementById('saveTagMenu').classList.add('hidden');
        }

        // Render tag options for save modal dropdown
        function renderSaveModalTagOptions() {
            const menu = document.getElementById('saveTagMenu');
            if (!menu) return;

            const listHtml = tags.map(t => `
                <button type="button" onclick="selectSaveTag(${t.id})" class="w-full text-left px-3 py-2 hover:bg-slate-700 transition flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                    <span class="text-sm text-slate-300 hover:text-white">${t.name}</span>
                </button>
            `).join('');

            menu.innerHTML = listHtml;

            // Set initial selection
            if (currentTag) {
                selectSaveTag(currentTag.id);
            } else if (tags.length > 0) {
                selectSaveTag(tags[0].id);
            }
        }

        function resetTimerUI() {
            currentState = 'stopped';
            pendingAbort = false; // Reset abort flag
            sessionEndTime = null; // Clear end time
            timeLeftSeconds = durationMinutes * 60;
            updateDigitalDisplay();
            renderPixels();

            // Enable tag selection
            els.currentTagBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show main button again
            els.mainBtn.classList.remove('hidden');
            els.mainBtn.innerHTML = '<i class="fas fa-play ml-1"></i>';

            // Hide reset button when stopped (only show when running as stop button)
            els.resetBtn.classList.add('hidden');

            resetTimerToDefaultTag();
        }

        function resetTimerToDefaultTag() {
            const defaultTag = tags.find(t => t.isDefault) || tags[0];
            if (defaultTag) {
                currentTag = defaultTag;
                els.currentTagName.innerText = defaultTag.name;
                els.currentTagDot.style.backgroundColor = defaultTag.color;
            }
        }

        let pomosCompleted = 0;
        let lastWorkTagId = null;

        async function confirmSaveSession() {
            // Get inputs
            const title = document.getElementById('saveTitle').value.trim();
            const desc = document.getElementById('saveDescription').value.trim();

            // Get selected tag
            const selectedTagId = parseInt(document.getElementById('saveTagValue').value);
            const selectedTag = tags.find(t => t.id === selectedTagId) || currentTag;

            // Update currentTag for auto-flow
            currentTag = selectedTag;

            // Time calculation
            const end = sessionEndTime || new Date();
            const start = startTime || new Date(end.getTime() - durationMinutes * 60000);

            // Status and duration
            const status = pendingAbort ? 'aborted' : 'completed';
            const actualDuration = pendingAbort
                ? Math.max(1, Math.round((durationMinutes * 60 - timeLeftSeconds) / 60))
                : durationMinutes;

            console.log('[Pomodoro] confirmSaveSession called, id:', currentSessionId, 'tag:', selectedTag.name, 'status:', status);

            try {
                // Check if cross day
                if (start.toDateString() !== end.toDateString()) {
                    // Cross-day: Delete the early-saved record and insert split records
                    if (currentSessionId) {
                        await db.execute("DELETE FROM pomodoro_sessions WHERE id = ?", [currentSessionId]);
                    }

                    const midnight = new Date(start);
                    midnight.setHours(24, 0, 0, 0);
                    const dur1 = Math.round((midnight - start) / 60000);
                    const dur2 = actualDuration - dur1;

                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                        [start.toISOString(), midnight.toISOString(), dur1, selectedTag.id, status, title + ' (Part 1)', desc, new Date().toISOString()]
                    );
                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                        [midnight.toISOString(), end.toISOString(), dur2, selectedTag.id, status, title, desc, new Date().toISOString()]
                    );
                } else {
                    if (currentSessionId) {
                        // Update existing record
                        await db.execute(
                            `UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                            [end.toISOString(), actualDuration, selectedTag.id, status, title, desc, currentSessionId]
                        );
                    } else {
                        // Fallback: Triple check if record exists by start_time before inserting
                        const existing = await db.query(
                            "SELECT id FROM pomodoro_sessions WHERE start_time = ? AND tag_id = ?",
                            [start.toISOString(), selectedTag.id]
                        );

                        if (existing && existing[0] && existing[0].values.length > 0) {
                            const foundId = existing[0].values[0][0];
                            await db.execute(
                                `UPDATE pomodoro_sessions SET end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                                [end.toISOString(), actualDuration, selectedTag.id, status, title, desc, foundId]
                            );
                        } else {
                            await db.execute(
                                `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                                [start.toISOString(), end.toISOString(), actualDuration, selectedTag.id, status, title, desc, new Date().toISOString()]
                            );
                        }
                    }
                }
            } catch (err) {
                console.error('Save Session Failed:', err);
            }

            currentSessionId = null; // Clear tracking
            closeSaveModal();
            resetTimerUI();
            handleAutoFlow();
        }

        function handleAutoFlow() {
            // Simply reset UI, user manually chooses next action
            pomosCompleted++;
            resetTimerUI();
        }



        function closeSaveModal() {
            const modal = els.saveModal;
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-90');
            modal.querySelector('div').classList.remove('scale-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // === Audio Logic ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playCompletionSound() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const now = audioCtx.currentTime;

            // Note 1: E5 (659.25 Hz)
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(659.25, now);
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.start(now);
            osc1.stop(now + 0.5);

            // Note 2: G#5 (830.61 Hz)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(830.61, now + 0.1);
            gain2.gain.setValueAtTime(0.1, now + 0.1);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start(now + 0.1);
            osc2.stop(now + 0.6);

            // Note 3: B5 (987.77 Hz) - Major chord finish
            const osc3 = audioCtx.createOscillator();
            const gain3 = audioCtx.createGain();
            osc3.type = 'sine';
            osc3.frequency.setValueAtTime(987.77, now + 0.2);
            gain3.gain.setValueAtTime(0.1, now + 0.2);
            gain3.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
            osc3.connect(gain3);
            gain3.connect(audioCtx.destination);
            osc3.start(now + 0.2);
            osc3.stop(now + 1.2);
        }

        // === Utils ===
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // === UI Rendering ===
        function updateDigitalDisplay() {
            const mins = Math.floor(timeLeftSeconds / 60);
            const secs = timeLeftSeconds % 60;
            const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            els.digital.innerText = timeStr;
            const tagName = currentTag?.name || '';
            document.title = tagName ? `${timeStr} - ${tagName} - 番茄钟` : `${timeStr} - 番茄钟`;
        }

        // Smoother, rounder tomato shape
        const TOMATO_MAP = [
            [0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0],
            [0, 0, 1, 1, 2, 2, 2, 2, 2, 1, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0]
        ];

        function renderPixels() {
            els.pixelGrid.innerHTML = '';
            els.pixelGrid.style.display = 'grid';
            els.pixelGrid.style.gridTemplateColumns = `repeat(13, 1fr)`;
            els.pixelGrid.style.gap = '2px';
            els.pixelGrid.style.maxWidth = '300px';
            els.pixelGrid.style.margin = '0 auto';

            TOMATO_MAP.flat().forEach((val, index) => {
                const div = document.createElement('div');
                div.id = `pixel-${index}`;

                if (val === 0) {
                    div.className = 'pixel-block invisible';
                } else {
                    div.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                    div.dataset.type = val; // 1=Body, 2=Stem
                    // Keep aspect ratio roughly square
                    div.style.aspectRatio = '1/1';
                }
                els.pixelGrid.appendChild(div);
            });

            els.progressText.innerText = `0 / ${durationMinutes} min`;
        }

        function updatePixelDisplay() {
            const totalSeconds = durationMinutes * 60;
            const elapsed = totalSeconds - timeLeftSeconds;
            const percentage = elapsed / totalSeconds;
            const elapsedMins = Math.floor(elapsed / 60);

            // Update text
            els.progressText.innerText = `${elapsedMins} / ${durationMinutes} min`;

            // Calculate active pixels
            const allPixels = Array.from(els.pixelGrid.children);
            const fillablePixels = allPixels.filter(el => !el.classList.contains('invisible'));
            const countToFill = Math.floor(fillablePixels.length * percentage);

            fillablePixels.forEach((block, i) => {
                const type = block.dataset.type;
                if (i < countToFill) {
                    if (type === '2') {
                        block.style.backgroundColor = '#4ade80'; // Green stem
                    } else {
                        block.style.backgroundColor = '#f43f5e'; // Rose-500 (Redder Tomato)
                    }
                    block.classList.add('shadow-[0_0_5px_rgba(0,0,0,0.5)]');
                    // Add a slight "lit" effect override opacity/brightness if needed
                    block.style.filter = 'brightness(1.2)';
                } else {
                    block.style.backgroundColor = ''; // Revert to slate-800
                    block.classList.remove('bg-slate-800'); // Wait, we need base color
                    block.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                    block.style.filter = '';
                    block.style.boxShadow = '';
                }
            });
        }

        // === Tag Logic ===
        function toggleTagMenu() {
            if (currentState === 'running') return;
            els.tagMenu.classList.toggle('hidden');
        }

        function selectTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                currentTag = t;
                els.currentTagName.innerText = t.name;
                els.currentTagDot.style.backgroundColor = t.color;
            }
            els.tagMenu.classList.add('hidden');
        }

        function renderTags(tagList, showActions = true) {
            if (tagList) {
                tags = tagList.map(r => ({
                    id: r.values[0],
                    name: r.values[1],
                    color: r.values[2],
                    isDefault: r.values[3] === 1
                }));

                // Sort: isDefault first, then alphabetically by name
                tags.sort((a, b) => {
                    if (a.isDefault && !b.isDefault) return -1;
                    if (!a.isDefault && b.isDefault) return 1;
                    return a.name.localeCompare(b.name, 'zh-CN');
                });
            }

            if (tags.length === 0) {
                // No tags found? Create defaults.
                console.log('[Pomodoro] No tags found, creating defaults...');
                createDefaultTags();
                return;
            }

            // Logic to determine selection
            let selected = null;
            if (currentTag) {
                // Try to keep current selection
                selected = tags.find(t => t.id === currentTag.id);
            }

            // Always prefer Default tag initially, ignore localStorage

            if (!selected) {
                // Fallback: Default tag or First tag
                selected = tags.find(t => t.isDefault) || tags[0];
            }

            // Update currentTag reference
            currentTag = selected;
            // Update UI for current tag
            if (currentTag) {
                try {
                    els.currentTagName.innerText = currentTag.name;
                    els.currentTagDot.style.backgroundColor = currentTag.color;
                    checkSkipButton();
                } catch (e) { }
            }

            els.tagList.innerHTML = tags.map(t => `
                <div class="w-full px-3 py-1 hover:bg-slate-700/50 transition flex items-center justify-between group">
                    <button onclick="selectTag(${t.id})" class="flex-1 flex items-center gap-2 py-1.5 text-left">
                        <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                        <span class="text-sm ${currentTag && t.id === currentTag.id ? 'text-white font-bold' : 'text-slate-300 group-hover:text-white'}">${t.name}</span>
                    </button>
                    ${showActions ? `
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="editTag(${t.id})" class="p-1.5 text-slate-500 hover:text-blue-400" title="编辑">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        ${!t.isDefault ? `
                        <button onclick="confirmDeleteTag(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="p-1.5 text-slate-500 hover:text-rose-400" title="删除">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                        ` : ''}
                    </div>
                    ` : (currentTag && t.id === currentTag.id ? '<i class="fas fa-check text-xs text-blue-500"></i>' : '')}
                </div>
            `).join('');

            // Also update the list in Tags Management modal
            const manageList = document.getElementById('manageTagList');
            if (manageList) {
                manageList.innerHTML = tags.map(t => `
                    <div class="bg-slate-900/50 border border-slate-700/50 p-3 rounded-xl flex items-center justify-between group">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full shadow-sm" style="background-color: ${t.color}"></div>
                            <div>
                                <div class="text-sm font-medium text-slate-200">${t.name}</div>
                                ${t.isDefault ? '<div class="text-[10px] text-slate-500 uppercase tracking-wider">默认标签</div>' : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="editTag(${t.id})" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-blue-400 hover:bg-blue-400/10 transition">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            ${!t.isDefault ? `
                            <button onclick="confirmDeleteTag(${t.id}, '${t.name.replace(/'/g, "\\'")}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-slate-400 hover:text-rose-400 hover:bg-rose-400/10 transition">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }
        }

        function openTagsManagement() {
            document.getElementById('tagsManagementModal').classList.remove('hidden');
        }

        function closeTagsManagement() {
            document.getElementById('tagsManagementModal').classList.add('hidden');
        }

        async function createDefaultTags() {
            const defaults = [
                { name: 'Default', color: '#e2e8f0', is_default: 1 }  // slate-200 柔和浅灰
            ];

            for (const d of defaults) {
                try {
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, ?)", [d.name, d.color, d.is_default]);
                } catch (e) { }
            }

            // Reload after short delay (or wait for event)
            setTimeout(requestData, 500); // reuse requestData which loads tags
        }

        // Add Tag color picker

        function openAddTagModal() {
            els.tagMenu.classList.add('hidden');
            currentEditTagId = null;
            document.getElementById('tagModalTitle').innerText = '新建标签';
            document.getElementById('newTagName').value = '';
            document.getElementById('newTagColor').value = '#3b82f6';
            document.getElementById('newTagDefault').checked = false;
            document.getElementById('addTagModal').classList.remove('hidden');
        }

        function closeAddTagModal() {
            document.getElementById('addTagModal').classList.add('hidden');
        }

        async function editTag(id) {
            const tag = tags.find(t => t.id === id);
            if (!tag) return;

            currentEditTagId = id;
            document.getElementById('tagModalTitle').innerText = '编辑标签';
            document.getElementById('newTagName').value = tag.name;
            document.getElementById('newTagColor').value = tag.color;
            document.getElementById('newTagDefault').checked = tag.isDefault;
            document.getElementById('addTagModal').classList.remove('hidden');
        }

        async function confirmDeleteTag(id, name) {
            if (confirm(`确定要删除标签 "${name}" 吗？\n相关的所有历史记录仍会保留，但标签将显示为“未知”。`)) {
                try {
                    await db.execute("DELETE FROM pomodoro_tags WHERE id = ?", [id]);
                } catch (e) { console.error('Delete Tag Failed:', e); }
            }
        }

        async function confirmAddTag() {
            const name = document.getElementById('newTagName').value.trim();
            const color = document.getElementById('newTagColor').value;
            const isDefault = document.getElementById('newTagDefault').checked ? 1 : 0;

            if (!name) return;

            try {
                // If this tag is being set as default, unset others first
                if (isDefault === 1) {
                    await db.execute("UPDATE pomodoro_tags SET is_default = 0");
                }

                if (currentEditTagId) {
                    await db.execute("UPDATE pomodoro_tags SET name = ?, color = ?, is_default = ? WHERE id = ?", [name, color, isDefault, currentEditTagId]);
                } else {
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, ?)", [name, color, isDefault]);
                }

                // If we unset a default but didn't set a new one, we might need a fallback.
                // But normally we'd always want at least one default. 
                // Ensuring at least one default tag exists:
                if (isDefault === 0) {
                    const countRes = await db.query("SELECT COUNT(*) FROM pomodoro_tags WHERE is_default = 1");
                    if (countRes && countRes[0].values[0][0] === 0) {
                        // If no default exists, force this one or keep the first one as default
                        // For now, let's just let it be, but usually it's better to keep one.
                    }
                }
            } catch (e) { console.error('Save Tag Failed:', e); }

            document.getElementById('addTagModal').classList.add('hidden');
            document.getElementById('newTagName').value = '';
        }


        // === Stats Logic ===
        function openStats() {
            els.statsOverlay.classList.remove('translate-y-full');

            // Set date picker to today
            const datePicker = document.getElementById('exportDatePicker');
            if (datePicker) {
                const today = new Date();
                const pad = (n) => String(n).padStart(2, '0');
                datePicker.value = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
            }

            // Load stats data
            requestData();
        }

        function closeStats() {
            els.statsOverlay.classList.add('translate-y-full');
        }

        let tablesInitialized = false; // Flag to ensure migration is complete

        async function requestData() {
            if (!db.isOpen) {
                // console.warn('Database not open');
                if (!document.getElementById('db-warning-toast')) {
                    const toast = document.createElement('div');
                    toast.id = 'db-warning-toast';
                    toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg z-50 animate-bounce';
                    toast.innerText = '请先在主页打开数据库 / Please open database in Dashboard';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                return;
            }

            if (!tablesInitialized) {
                console.log('[Pomodoro] Waiting for tables initialization...');
                return;
            }

            // Calculate Start of Week (Monday)
            const now = new Date();
            const day = now.getDay() || 7;
            if (day !== 1 || now.getHours() !== 0 || now.getMinutes() !== 0 || now.getSeconds() !== 0 || now.getMilliseconds() !== 0) {
                now.setHours(0, 0, 0, 0);
                now.setDate(now.getDate() - (day - 1));
            }
            const startOfWeek = now.toISOString();

            try {
                // 1. Get Tags
                console.log('[Pomodoro] Querying tags...');
                const tagsResult = await db.query("SELECT id, name, color, is_default FROM pomodoro_tags");
                console.log('[Pomodoro] Tags result:', tagsResult);
                if (tagsResult && tagsResult.length > 0) {
                    const formattedTags = tagsResult[0].values.map(v => ({ values: v }));
                    console.log('[Pomodoro] Formatted tags:', formattedTags);
                    renderTags(formattedTags);
                } else {
                    console.log('[Pomodoro] No tags found in database');
                }

                // 2. Get Sessions
                console.log('[Pomodoro] Querying sessions from', startOfWeek);
                const sessionsResult = await db.query("SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description FROM pomodoro_sessions WHERE start_time >= ? ORDER BY start_time DESC", [startOfWeek]);
                console.log('[Pomodoro] Sessions result:', sessionsResult);

                if (sessionsResult && sessionsResult.length > 0) {
                    const raw = sessionsResult[0].values;
                    sessions = raw.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                    console.log('[Pomodoro] Parsed sessions:', sessions.length);
                } else {
                    sessions = [];
                    console.log('[Pomodoro] No sessions found');
                }

                if (!els.statsOverlay.classList.contains('translate-y-full')) {
                    updateStatsUI();
                }

            } catch (err) {
                console.error('[Pomodoro] Data Load Error:', err);
            }
        }

        // Listen for updates (reload data + save to IDB)
        db.on('db_updated', () => {
            console.log('[Pomodoro] DB Updated, reloading...');
            requestData();
            // Note: saveSnapshotToIDB is registered separately below
        });


        let trendChart = null;
        let distChart = null;

        function updateStatsUI() {
            // Helper: get tag
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
            const isRelax = (s) => getTag(s.tagId).name === 'Relax';
            const isDefault = (s) => getTag(s.tagId).name === 'Default';

            const now = new Date();

            // Filter out Relax for ALL summary metrics
            const focusSessions = sessions.filter(s => !isRelax(s));

            // Calculate week start (Monday)
            const weekStartDate = new Date(now);
            const dayOfWeek = weekStartDate.getDay();
            const diffToMonday = weekStartDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            weekStartDate.setDate(diffToMonday);
            weekStartDate.setHours(0, 0, 0, 0);

            // Filter sessions based on statsTimeRange
            let rangedSessions;
            if (statsTimeRange === 'today') {
                rangedSessions = focusSessions.filter(s => new Date(s.startTime).toDateString() === now.toDateString());
            } else {
                rangedSessions = focusSessions.filter(s => new Date(s.startTime) >= weekStartDate);
            }

            // Calculate metrics for ranged sessions
            const focusCount = rangedSessions.length;
            const totalMins = rangedSessions.reduce((sum, s) => sum + s.duration, 0);

            // Effective = exclude Default tag
            const effectiveSessions = rangedSessions.filter(s => !isDefault(s));
            const effectiveMins = effectiveSessions.reduce((sum, s) => sum + s.duration, 0);

            // Unique tags used in ranged sessions
            const usedTagIds = [...new Set(rangedSessions.map(s => s.tagId))];
            const tagCount = usedTagIds.length;

            // Helper: format minutes as "xx H xx mins"
            function formatDuration(mins) {
                if (mins < 60) return `${mins} mins`;
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return m > 0 ? `${h} H ${m} mins` : `${h} H`;
            }

            // Update Summary Cards
            document.getElementById('statsFocusCount').innerText = focusCount;
            document.getElementById('statsTotalTime').innerText = formatDuration(totalMins);
            document.getElementById('statsEffectiveTime').innerText = formatDuration(effectiveMins);
            document.getElementById('statsTagCount').innerText = tagCount;

            // 2. Charts
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            const ctxDist = document.getElementById('distChart').getContext('2d');

            // Trend: Last 7 Days Timeline (0-24h) - INCLUDE Relax (User request)
            const timelineData = [];
            const timelineColors = [];
            const dayLabels = [];

            // 1. Generate last 7 days labels (Y-axis categories)
            for (let i = 0; i < 7; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dayStr = d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }); // e.g. 12/13
                dayLabels.unshift(dayStr);
            }

            // 2. Map sessions to timeline bars
            sessions.forEach(s => {
                const sDate = new Date(s.startTime);
                const dayStr = sDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });

                // Only include if this day is in our last 7 days
                const dayIndex = dayLabels.indexOf(dayStr);
                if (dayIndex !== -1) {
                    const startDisp = sDate.getHours() + sDate.getMinutes() / 60;
                    const endDisp = startDisp + (s.duration / 60);

                    const tag = getTag(s.tagId);

                    timelineData.push({
                        x: [startDisp, endDisp],
                        y: dayStr, // Matches Y-axis label
                        tag: tag.name, // For tooltip
                        rawStart: sDate // For tooltip formatting
                    });
                    timelineColors.push(tag.color); // Color by tag
                }
            });

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctxTrend, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: '专注记录',
                        data: timelineData,
                        backgroundColor: timelineColors,
                        borderWidth: 0,
                        barPercentage: 0.6, // Thinner bars for elegance
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    // Move Tag and Duration to Title
                                    const raw = context[0].raw;
                                    const durationHours = raw.x[1] - raw.x[0];
                                    const totalMins = Math.round(durationHours * 60);

                                    let durationStr = '';
                                    if (totalMins < 60) {
                                        durationStr = `${totalMins}分钟`;
                                    } else {
                                        const h = Math.floor(totalMins / 60);
                                        const m = totalMins % 60;
                                        durationStr = m > 0 ? `${h}小时${m}分钟` : `${h}小时`;
                                    }
                                    return `${raw.y} · ${raw.tag} · ${durationStr}`;
                                },
                                label: function (context) {
                                    // Only show Time Range in body
                                    const raw = context.raw;
                                    const st = raw.rawStart;
                                    const itemDuration = raw.x[1] - raw.x[0];
                                    const ed = new Date(st.getTime() + itemDuration * 3600000);

                                    const formatTime = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                                    return `${formatTime(st)} - ${formatTime(ed)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 24, // WILL BE OVERRIDDEN by slider logic immediately after
                            grid: { color: '#334155' },
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return value + ':00';
                                },
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#cbd5e1' }
                        }
                    }
                }
            });



            // 3. Distribution Chart (Rendered separately)
            renderDistChart();

            // 4. History List
            renderHistoryList();

            // 4. Set Initial Slider Position (Center on Now)
            const currentHour = new Date().getHours();
            let safeStart = currentHour - 2;
            if (safeStart < 0) safeStart = 0;
            if (safeStart > 20) safeStart = 20;

            document.getElementById('chartSlider').value = safeStart;
            onSliderChange(safeStart);
        }

        let isFullView = false;
        let lastSliderVal = 0;

        function toggleFullView() {
            if (!trendChart) return;
            const btn = document.getElementById('fullViewBtn');
            const slider = document.getElementById('chartSlider');
            const sliderContainer = document.getElementById('sliderContainer');

            isFullView = !isFullView;

            if (isFullView) {
                // Switch to Full View
                lastSliderVal = slider.value;
                trendChart.options.scales.x.min = 0;
                trendChart.options.scales.x.max = 24;
                trendChart.options.scales.x.ticks.stepSize = 4; // Less dense ticks
                trendChart.update();

                btn.classList.add('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.remove('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-compress"></i> 退出';

                sliderContainer.classList.add('opacity-50', 'pointer-events-none');
                slider.disabled = true;
            } else {
                // Restore Focus View
                trendChart.options.scales.x.min = parseInt(lastSliderVal);
                trendChart.options.scales.x.max = parseInt(lastSliderVal) + 4;
                trendChart.options.scales.x.ticks.stepSize = 1; // Detailed ticks
                trendChart.update();

                btn.classList.remove('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.add('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-expand"></i> 全景';

                sliderContainer.classList.remove('opacity-50', 'pointer-events-none');
                slider.disabled = false;
            }
        }

        function moveSlider(delta) {
            const slider = document.getElementById('chartSlider');
            let val = parseInt(slider.value) + delta;
            // Clamp
            if (val < 0) val = 0;
            if (val > 20) val = 20;

            slider.value = val;
            onSliderChange(val);
        }

        function onSliderChange(val) {
            if (isFullView) return; // Ignore if in full view
            const start = parseInt(val);
            if (trendChart) {
                trendChart.options.scales.x.min = start;
                trendChart.options.scales.x.max = start + 4; // Fixed 4h window
                trendChart.update('none'); // Efficient update works better
            }
        }

        function setStatsTimeRange(mode) {
            statsTimeRange = mode;
            // Update Toggle UI
            const btnToday = document.getElementById('statsRangeToday');
            const btnWeek = document.getElementById('statsRangeWeek');

            if (mode === 'today') {
                btnToday.className = 'px-3 py-1.5 text-xs rounded-md transition bg-rose-600 text-white shadow-sm';
                btnWeek.className = 'px-3 py-1.5 text-xs rounded-md transition text-slate-400 hover:text-white';
            } else {
                btnToday.className = 'px-3 py-1.5 text-xs rounded-md transition text-slate-400 hover:text-white';
                btnWeek.className = 'px-3 py-1.5 text-xs rounded-md transition bg-rose-600 text-white shadow-sm';
            }

            // Re-render both Summary Cards and Distribution Chart
            updateStatsUI();
        }

        function renderDistChart() {
            const ctxDist = document.getElementById('distChart').getContext('2d');
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
            const isRelax = (s) => getTag(s.tagId).name === 'Relax';

            // Filter Sessions based on statsTimeRange (same as Summary Cards)
            const focusSessions = sessions.filter(s => !isRelax(s));
            const now = new Date();
            let distSource = [];

            if (statsTimeRange === 'today') {
                distSource = focusSessions.filter(s => new Date(s.startTime).toDateString() === now.toDateString());
            } else {
                // Week
                const d = new Date(now);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const weekStart = new Date(d.setDate(diff));
                weekStart.setHours(0, 0, 0, 0);
                distSource = focusSessions.filter(s => new Date(s.startTime) >= weekStart);
            }

            const tagStats = {};
            distSource.forEach(s => {
                const t = getTag(s.tagId);
                tagStats[t.name] = (tagStats[t.name] || 0) + s.duration;
            });

            const distLabels = Object.keys(tagStats);
            const distData = Object.values(tagStats);
            const distColors = distLabels.map(name => tags.find(t => t.name === name)?.color || '#ccc');

            if (distChart) distChart.destroy();

            // Handle Empty Data
            if (distData.length === 0) {
                // Maybe show a "No Data" text or empty chart? 
                // Chart.js handles empty data okay, but let's just render it.
            }

            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: distLabels,
                    datasets: [{
                        data: distData,
                        backgroundColor: distColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: ${value}分钟 (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // === Unified History Filter State ===
        let currentHistoryFilter = 'today'; // 'today', 'week', 'all', 'date'
        let currentHistorySessions = []; // Currently displayed sessions (for export)

        function setHistoryFilter(filter) {
            currentHistoryFilter = filter;

            // Update button states
            const btnToday = document.getElementById('filterBtnToday');
            const btnWeek = document.getElementById('filterBtnWeek');
            const btnAll = document.getElementById('filterBtnAll');
            const datePicker = document.getElementById('historyDatePicker');

            const activeClass = 'bg-blue-600 text-white';
            const inactiveClass = 'text-slate-400 hover:text-white';

            [btnToday, btnWeek, btnAll].forEach(btn => {
                btn.className = `px-3 py-1 text-xs rounded-md transition ${inactiveClass}`;
            });

            if (filter === 'today') {
                btnToday.className = `px-3 py-1 text-xs rounded-md transition ${activeClass}`;
            } else if (filter === 'week') {
                btnWeek.className = `px-3 py-1 text-xs rounded-md transition ${activeClass}`;
            } else if (filter === 'all') {
                btnAll.className = `px-3 py-1 text-xs rounded-md transition ${activeClass}`;
            }
            // 'date' filter doesn't highlight any button, just uses date picker

            loadHistorySessions();
        }

        async function loadHistorySessions() {
            const list = document.getElementById('historyList');
            const statusEl = document.getElementById('historyStatus');
            const datePicker = document.getElementById('historyDatePicker');
            const now = new Date();

            let startDate, endDate;
            let filterLabel = '';

            if (currentHistoryFilter === 'today') {
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                filterLabel = '今天';
            } else if (currentHistoryFilter === 'week') {
                const d = new Date(now);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                startDate = new Date(d.setDate(diff));
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date();
                endDate.setDate(endDate.getDate() + 1);
                filterLabel = '本周';
            } else if (currentHistoryFilter === 'date' && datePicker.value) {
                startDate = new Date(datePicker.value + 'T00:00:00');
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                filterLabel = datePicker.value;
            } else {
                // 'all' - use sessions already loaded
                currentHistorySessions = [...sessions];
                renderHistoryItems();
                return;
            }

            // Query from database
            statusEl.textContent = '加载中...';
            statusEl.className = 'text-xs text-amber-400';

            try {
                const result = await db.query(
                    `SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description 
                     FROM pomodoro_sessions 
                     WHERE start_time >= ? AND start_time < ? 
                     ORDER BY start_time DESC`,
                    [startDate.toISOString(), endDate.toISOString()]
                );

                if (result && result.length > 0 && result[0].values) {
                    currentHistorySessions = result[0].values.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                } else {
                    currentHistorySessions = [];
                }
            } catch (err) {
                console.error('[Pomodoro] Load History Failed:', err);
                statusEl.textContent = '加载失败';
                statusEl.className = 'text-xs text-rose-400';
                return;
            }

            renderHistoryItems();
        }

        function renderHistoryItems() {
            const list = document.getElementById('historyList');
            const statusEl = document.getElementById('historyStatus');

            // Calculate stats
            const totalMins = currentHistorySessions.reduce((sum, s) => sum + s.duration, 0);
            const hrs = Math.floor(totalMins / 60);
            const mins = totalMins % 60;
            const timeStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;

            statusEl.textContent = `${currentHistorySessions.length} 条记录，共 ${timeStr}`;
            statusEl.className = 'text-xs text-emerald-400';

            if (currentHistorySessions.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-slate-500">暂无记录</div>';
                return;
            }

            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            list.innerHTML = currentHistorySessions.map(s => {
                const tag = getTag(s.tagId);
                const date = new Date(s.startTime);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Status badge
                let statusBadge = '';
                let statusBorder = '';
                if (s.status === 'completed') {
                    statusBadge = '<span class="text-emerald-400 text-xs ml-1" title="已完成"><i class="fas fa-check-circle"></i></span>';
                    statusBorder = 'border-l-2 border-emerald-500';
                } else if (s.status === 'in_progress' || s.status === 'running') {
                    statusBadge = '<span class="text-yellow-400 text-[10px] ml-1 flex items-center justify-center animate-pulse-yellow" title="进行中"><i class="fas fa-circle"></i></span>';
                    statusBorder = 'border-l-2 border-yellow-500';
                } else if (s.status === 'aborted') {
                    statusBadge = '<span class="text-rose-400 text-xs ml-1" title="已中止"><i class="fas fa-times-circle"></i></span>';
                    statusBorder = 'border-l-2 border-rose-500';
                }

                return `
                    <div class="p-4 hover:bg-slate-700/50 transition flex items-center justify-between group ${statusBorder}">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-slate-400 font-bold shrink-0">
                                ${s.duration}
                            </div>
                            <div class="min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="w-2 h-2 rounded-full" style="background-color: ${tag.color}"></span>
                                    <span class="font-medium text-slate-200">${escapeHtml(tag.name)}</span>
                                    ${statusBadge}
                                </div>
                                ${s.title ? `<div class="text-sm text-white mb-1 break-words">${escapeHtml(s.title)}</div>` : ''}
                                ${s.description ? `<div class="text-xs text-slate-400 mb-1 break-words">${escapeHtml(s.description)}</div>` : ''}
                                <div class="text-xs text-slate-500">${dateStr}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                            <button onclick="editSession(${s.id})" class="text-slate-500 hover:text-blue-500 p-2" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSession(${s.id})" class="text-slate-500 hover:text-rose-500 p-2" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Keep old function for compatibility
        function renderHistoryList() {
            loadHistorySessions();
        }

        // Export current list to clipboard as markdown
        function exportCurrentList() {
            const excludeRelax = document.getElementById('exportExcludeRelax').checked;
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            let sessionsToExport = [...currentHistorySessions];

            // Filter out Relax if checked
            if (excludeRelax) {
                sessionsToExport = sessionsToExport.filter(s => {
                    const tagName = getTag(s.tagId).name;
                    return tagName !== 'Relax' && tagName !== 'Break' && tagName !== 'Rest';
                });
            }

            // Sort by start time ascending (chronological order for export)
            sessionsToExport.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

            if (sessionsToExport.length === 0) {
                alert('没有可导出的记录');
                return;
            }

            // Generate markdown
            const lines = sessionsToExport.map(s => {
                const start = new Date(s.startTime);
                const end = new Date(s.endTime);
                const formatTime = (d) => {
                    const h = String(d.getHours()).padStart(2, '0');
                    const m = String(d.getMinutes()).padStart(2, '0');
                    return `${h}:${m}`;
                };

                const tag = getTag(s.tagId);
                const tagName = tag ? tag.name : '';
                const title = s.title || '';

                let label = '';
                if (title && tagName && title !== tagName) {
                    label = `${title} | ${tagName}`;
                } else if (title) {
                    label = title;
                } else if (tagName) {
                    label = tagName;
                }

                return ` - ${formatTime(start)} - ${formatTime(end)} ${label} (${s.duration}min)`;
            });

            const markdown = lines.join('\n');

            // Copy to clipboard
            navigator.clipboard.writeText(markdown).then(() => {
                const btn = document.querySelector('button[onclick="exportCurrentList()"]');
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                btn.classList.add('bg-emerald-600');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                }, 1500);
            }).catch(err => {
                alert('复制失败：' + err);
            });
        }

        async function deleteSession(id) {
            // Store session data for potential undo
            const session = sessions.find(s => s.id === id);
            if (!session) return;

            try {
                await db.execute('DELETE FROM pomodoro_sessions WHERE id = ?', [id]);

                // Show undo toast
                showUndoToast(session);
            } catch (e) {
                console.error('Delete Failed:', e);
            }
        }

        let undoTimeout = null;
        function showUndoToast(session) {
            // Remove existing toast
            const existing = document.getElementById('undoToast');
            if (existing) existing.remove();
            if (undoTimeout) clearTimeout(undoTimeout);

            const toast = document.createElement('div');
            toast.id = 'undoToast';
            toast.className = 'fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-6 z-[1000] border border-slate-700/50 animate-fade-in';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </div>
                    <span class="text-sm font-medium">已删除一条专注记录</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="undoDelete()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold transition-all active:scale-95">撤销</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="p-2 text-slate-500 hover:text-white transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);

            // Store session for undo
            window._deletedSession = session;

            // Auto-remove after 5 seconds
            undoTimeout = setTimeout(() => {
                toast.remove();
                window._deletedSession = null;
            }, 5000);
        }

        async function undoDelete() {
            const session = window._deletedSession;
            if (!session) return;

            try {
                await db.execute(
                    `INSERT INTO pomodoro_sessions (id, start_time, end_time, duration_minutes, tag_id, status, title, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
                    [session.id, session.startTime, session.endTime, session.duration, session.tagId, session.status, session.title || '', session.description || '', new Date().toISOString()]
                );
                window._deletedSession = null;

                const toast = document.getElementById('undoToast');
                if (toast) toast.remove();
            } catch (e) {
                console.error('Undo failed:', e);
            }
        }


        function exportData() {
            // Legacy - no longer used, keep for compatibility
        }

        // === Daily Records Export (Markdown) ===
        async function onExportDateChange() {
            const datePicker = document.getElementById('exportDatePicker');
            const statusEl = document.getElementById('exportPreviewStatus');
            const previewArea = document.getElementById('exportPreviewArea');

            if (!datePicker.value) {
                statusEl.textContent = '请选择日期加载数据';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            statusEl.textContent = '正在加载...';
            statusEl.className = 'text-xs text-amber-400 mb-2';

            await generateDailyMarkdown();
        }

        // Keep for backward compatibility
        async function openExportRecordsModal() {
            // Just trigger date change if date is already set
            const datePicker = document.getElementById('exportDatePicker');
            if (datePicker.value) {
                await onExportDateChange();
            }
        }

        function closeExportRecordsModal() {
            document.getElementById('exportRecordsModal').classList.add('hidden');
        }

        async function generateDailyMarkdown() {
            const datePicker = document.getElementById('exportDatePicker');
            const includeRelax = document.getElementById('exportIncludeRelax').checked;
            const output = document.getElementById('exportRecordsOutput');
            const statusEl = document.getElementById('exportPreviewStatus');
            const previewArea = document.getElementById('exportPreviewArea');

            if (!datePicker.value) {
                statusEl.textContent = '请先选择日期';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            const selectedDate = new Date(datePicker.value + 'T00:00:00');
            const nextDate = new Date(selectedDate);
            nextDate.setDate(nextDate.getDate() + 1);

            // Query database for the selected date
            let daySessions = [];
            try {
                const result = await db.query(
                    `SELECT id, start_time, end_time, duration_minutes, tag_id, status, title, description 
                     FROM pomodoro_sessions 
                     WHERE start_time >= ? AND start_time < ? 
                     ORDER BY start_time ASC`,
                    [selectedDate.toISOString(), nextDate.toISOString()]
                );

                if (result && result.length > 0 && result[0].values) {
                    daySessions = result[0].values.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], title: r[6] || '', description: r[7] || ''
                    }));
                }
            } catch (err) {
                console.error('[Pomodoro] Query failed:', err);
                statusEl.textContent = '查询失败：' + err.message;
                statusEl.className = 'text-xs text-rose-400 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            // Filter out Relax if not included
            if (!includeRelax) {
                const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
                daySessions = daySessions.filter(s => {
                    const tagName = getTag(s.tagId).name;
                    return tagName !== 'Relax' && tagName !== 'Break' && tagName !== 'Rest';
                });
            }

            if (daySessions.length === 0) {
                statusEl.textContent = '该日期没有记录';
                statusEl.className = 'text-xs text-slate-500 mb-2';
                previewArea.classList.add('hidden');
                return;
            }

            // Calculate total duration
            const totalMins = daySessions.reduce((sum, s) => sum + s.duration, 0);

            // Generate markdown
            const lines = daySessions.map(s => {
                const start = new Date(s.startTime);
                const end = new Date(s.endTime);
                const formatTime = (d) => {
                    const h = String(d.getHours()).padStart(2, '0');
                    const m = String(d.getMinutes()).padStart(2, '0');
                    return `${h}:${m}`;
                };

                const tag = tags.find(t => t.id === s.tagId);
                const tagName = tag ? tag.name : '';
                const title = escapeHtml(s.title || '');

                let label = '';
                if (title && tagName && title !== tagName) {
                    label = `${title} | ${tagName}`;
                } else if (title) {
                    label = title;
                } else if (tagName) {
                    label = tagName;
                }

                return ` - ${formatTime(start)} - ${formatTime(end)} ${label} (${s.duration}min)`;
            });

            output.value = lines.join('\n');

            // Update status and show preview
            statusEl.textContent = `已加载 ${daySessions.length} 条记录，共 ${totalMins} 分钟`;
            statusEl.className = 'text-xs text-emerald-400 mb-2';
            previewArea.classList.remove('hidden');
        }

        function copyExportRecords() {
            const output = document.getElementById('exportRecordsOutput');
            navigator.clipboard.writeText(output.value).then(() => {
                // Show feedback
                const btn = document.querySelector('#exportPreviewArea button[onclick="copyExportRecords()"]');
                if (!btn) return;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                btn.classList.add('bg-emerald-600');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-emerald-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                }, 1500);
            }).catch(err => {
                alert('复制失败：' + err);
            });
        }

        // === 7-Day Panorama Export (PNG) ===
        function openExportPanoramaModal() {
            const modal = document.getElementById('exportPanoramaModal');
            const dateInput = document.getElementById('exportPanoramaDate');

            // Set default to current week's Monday
            const now = new Date();
            const day = now.getDay() || 7;
            const monday = new Date(now);
            monday.setDate(now.getDate() - (day - 1));

            const pad = (n) => String(n).padStart(2, '0');
            dateInput.value = `${monday.getFullYear()}-${pad(monday.getMonth() + 1)}-${pad(monday.getDate())}`;

            // Generate initial preview
            generatePanoramaPreview();

            // Add event listener for live update
            dateInput.onchange = generatePanoramaPreview;

            modal.classList.remove('hidden');
        }

        function closeExportPanoramaModal() {
            document.getElementById('exportPanoramaModal').classList.add('hidden');
        }

        function generatePanoramaPreview() {
            const dateInput = document.getElementById('exportPanoramaDate');
            const preview = document.getElementById('panoramaPreview');

            const startDate = new Date(dateInput.value + 'T00:00:00');
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 7);

            // Get all sessions in this week
            const weekSessions = sessions.filter(s => {
                const sDate = new Date(s.startTime);
                return sDate >= startDate && sDate < endDate;
            });

            if (weekSessions.length === 0) {
                preview.innerHTML = '<div class="text-center text-slate-500 py-8">该周没有记录</div>';
                return;
            }

            // Calculate stats by category
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#94a3b8' };
            const stats = {};
            let totalMins = 0;

            weekSessions.forEach(s => {
                const tag = getTag(s.tagId);
                if (!stats[tag.name]) {
                    stats[tag.name] = { mins: 0, color: tag.color };
                }
                stats[tag.name].mins += s.duration;
                totalMins += s.duration;
            });

            // Generate day labels
            const dayLabels = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startDate);
                d.setDate(d.getDate() + i);
                dayLabels.push(d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', weekday: 'short' }));
            }

            // Build preview HTML
            let html = `
                <div style="background: #0f172a; padding: 20px; border-radius: 8px; font-family: system-ui, sans-serif;">
                    <h2 style="color: white; font-size: 18px; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="color: #f43f5e;">🍅</span> 7日专注全景图
                        <span style="color: #64748b; font-size: 12px; font-weight: normal; margin-left: auto;">
                            ${startDate.toLocaleDateString('zh-CN')} - ${new Date(endDate.getTime() - 86400000).toLocaleDateString('zh-CN')}
                        </span>
                    </h2>
                    
                    <!-- Timeline Grid -->
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: grid; gap: 8px;">
            `;

            // Render each day
            dayLabels.forEach((dayLabel, dayIndex) => {
                const dayStart = new Date(startDate);
                dayStart.setDate(dayStart.getDate() + dayIndex);
                const dayStr = dayStart.toDateString();

                const daySessions = weekSessions.filter(s => new Date(s.startTime).toDateString() === dayStr);

                html += `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 80px; color: #94a3b8; font-size: 12px; flex-shrink: 0;">${dayLabel}</div>
                        <div style="flex: 1; height: 24px; background: #334155; border-radius: 4px; position: relative; overflow: hidden;">
                `;

                // Render session bars
                daySessions.forEach(s => {
                    const sDate = new Date(s.startTime);
                    const startHour = sDate.getHours() + sDate.getMinutes() / 60;
                    const durationHours = s.duration / 60;
                    const leftPct = (startHour / 24) * 100;
                    const widthPct = (durationHours / 24) * 100;
                    const tag = getTag(s.tagId);

                    html += `<div style="position: absolute; left: ${leftPct}%; width: ${Math.max(widthPct, 0.5)}%; height: 100%; background: ${tag.color}; border-radius: 2px;" title="${tag.name}: ${s.duration}分钟"></div>`;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            // Time axis
            html += `
                    </div>
                    <div style="display: flex; margin-top: 8px; padding-left: 92px;">
                        <div style="flex: 1; color: #64748b; font-size: 10px;">0:00</div>
                        <div style="flex: 1; color: #64748b; font-size: 10px; text-align: center;">6:00</div>
                        <div style="flex: 1; color: #64748b; font-size: 10px; text-align: center;">12:00</div>
                        <div style="flex: 1; color: #64748b; font-size: 10px; text-align: center;">18:00</div>
                        <div style="color: #64748b; font-size: 10px;">24:00</div>
                    </div>
                </div>
                
                <!-- Stats & Legend -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <!-- Category Distribution -->
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #cbd5e1; font-size: 14px; margin: 0 0 12px 0;">分布占比</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
            `;

            // Sort by time descending
            const sortedStats = Object.entries(stats).sort((a, b) => b[1].mins - a[1].mins);

            sortedStats.forEach(([name, data]) => {
                const pct = totalMins > 0 ? ((data.mins / totalMins) * 100).toFixed(1) : 0;
                const hours = Math.floor(data.mins / 60);
                const mins = data.mins % 60;
                const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

                html += `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; border-radius: 3px; background: ${data.color}; flex-shrink: 0;"></div>
                        <div style="color: #e2e8f0; font-size: 13px; flex: 1;">${name}</div>
                        <div style="color: #94a3b8; font-size: 12px;">${timeStr}</div>
                        <div style="color: #64748b; font-size: 12px; width: 45px; text-align: right;">${pct}%</div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                    
                    <!-- Total Stats -->
                    <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
                        <h3 style="color: #cbd5e1; font-size: 14px; margin: 0 0 12px 0;">总计统计</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">总专注时长</div>
                                <div style="color: #fbbf24; font-size: 24px; font-weight: bold;">${(totalMins / 60).toFixed(1)} <span style="font-size: 14px; font-weight: normal;">小时</span></div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">番茄数量</div>
                                <div style="color: #f43f5e; font-size: 24px; font-weight: bold;">${weekSessions.length} <span style="font-size: 14px; font-weight: normal;">个</span></div>
                            </div>
                            <div>
                                <div style="color: #64748b; font-size: 11px; margin-bottom: 4px;">日均时长</div>
                                <div style="color: #3b82f6; font-size: 24px; font-weight: bold;">${(totalMins / 7 / 60).toFixed(1)} <span style="font-size: 14px; font-weight: normal;">小时</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;

            preview.innerHTML = html;
        }

        function downloadPanoramaPNG() {
            const preview = document.getElementById('panoramaPreview');
            const dateInput = document.getElementById('exportPanoramaDate');

            if (!preview.firstElementChild) {
                alert('请先选择日期生成预览');
                return;
            }

            html2canvas(preview.firstElementChild, {
                backgroundColor: '#0f172a',
                scale: 2 // Higher quality
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `pomodoro_week_${dateInput.value}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                alert('导出失败：' + err);
            });
        }



        let currentEditSessionId = null;

        function editSession(id) {
            const targetId = parseInt(id);
            const session = currentHistorySessions.find(s => s.id === targetId) || sessions.find(s => s.id === targetId);

            if (!session) return;

            currentEditSessionId = targetId;

            // Format times for datetimelocal (YYYY-MM-DDTHH:mm)
            const formatForInput = (isoStr) => {
                const d = new Date(isoStr);
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            document.getElementById('editStartTime').value = formatForInput(session.startTime);
            document.getElementById('editEndTime').value = formatForInput(session.endTime);
            document.getElementById('editTitle').value = session.title || '';
            document.getElementById('editDescription').value = session.description || '';

            // Set status
            const statusSelect = document.getElementById('editStatusSelect');
            statusSelect.value = session.status || 'completed';

            // Populate tags
            const select = document.getElementById('editTagSelect');
            select.innerHTML = tags.map(t => `<option value="${t.id}" ${t.id === session.tagId ? 'selected' : ''}>${t.name}</option>`).join('');

            document.getElementById('editSessionModal').classList.remove('hidden');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').classList.add('hidden');
            currentEditSessionId = null;
        }

        async function confirmEditSession() {
            if (!currentEditSessionId) return;

            const stVal = document.getElementById('editStartTime').value;
            const etVal = document.getElementById('editEndTime').value;
            const tagId = parseInt(document.getElementById('editTagSelect').value);
            const status = document.getElementById('editStatusSelect').value;
            const title = document.getElementById('editTitle').value.trim();
            const desc = document.getElementById('editDescription').value.trim();

            if (!stVal || !etVal) {
                alert('请填写完整的时间');
                return;
            }

            const start = new Date(stVal);
            const end = new Date(etVal);

            if (end <= start) {
                alert('结束时间必须晚于开始时间');
                return;
            }

            const durationMins = Math.round((end - start) / 60000);

            try {
                await db.execute(
                    `UPDATE pomodoro_sessions SET start_time = ?, end_time = ?, duration_minutes = ?, tag_id = ?, status = ?, title = ?, description = ? WHERE id = ?`,
                    [start.toISOString(), end.toISOString(), durationMins, tagId, status, title, desc, currentEditSessionId]
                );
            } catch (e) { console.error('Update Failed:', e); }

            closeEditSessionModal();
        }

        async function initTables() {
            console.log('[Pomodoro] initTables() called');
            try {
                console.log('[Pomodoro] Creating pomodoro_tags table...');
                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_tags (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        color TEXT NOT NULL,
                        is_default INTEGER DEFAULT 0
                    )
                `);

                // Tags Check
                console.log('[Pomodoro] Checking if tags exist...');
                const countRes = await db.query("SELECT COUNT(*) FROM pomodoro_tags");
                console.log('[Pomodoro] Tag count result:', countRes);
                if (countRes && countRes[0].values[0][0] === 0) {
                    console.log('[Pomodoro] No tags found, inserting defaults...');
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Work', '#3b82f6', 1)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Study', '#a855f7', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Workout', '#e11d48', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Relax', '#10b981', 0)");
                    console.log('[Pomodoro] Default tags inserted');
                } else {
                    console.log('[Pomodoro] Tags already exist, count:', countRes[0].values[0][0]);
                }

                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_sessions (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        start_time TEXT NOT NULL,
                        end_time TEXT NOT NULL,
                        duration_minutes INTEGER NOT NULL,
                        tag_id INTEGER,
                        status TEXT,
                        title TEXT,
                        description TEXT,
                        created_at TEXT NOT NULL
                    )
                `);

                tablesInitialized = true;
                console.log('[Pomodoro] Tables initialized');

            } catch (err) {
                console.error('Init Tables Failed:', err);
            }
        }

        // === File Permission & Sync Functions ===
        let lastSyncFailed = false;
        let syncFailAlertShown = false;

        function updateSyncStatus(success, message = '') {
            if (success) {
                lastSyncFailed = false;
                syncFailAlertShown = false;
            } else {
                lastSyncFailed = true;
                // Show alert only once per failure sequence
                if (message && !syncFailAlertShown) {
                    syncFailAlertShown = true;
                    console.warn('[Pomodoro] Sync failed:', message);
                    // Show a non-blocking toast warning
                    showSyncWarningToast(message);
                }
            }
        }

        function showSyncWarningToast(message) {
            // Remove existing toast if any
            const existingToast = document.getElementById('sync-warning-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'sync-warning-toast';
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-amber-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:text-amber-200">&times;</button>
            `;
            document.body.appendChild(toast);
            // Auto-remove after 8 seconds
            setTimeout(() => toast.remove(), 8000);
        }

        // Handle database updates - ALL pages save to IDB immediately
        db.on('db_updated', async () => {
            console.log('[Pomodoro] DB Updated, saving to IDB...');
            try {
                const data = await db.export();
                await db.saveSnapshotToIDB(data);
                console.log('[Pomodoro] Saved to IDB');
            } catch (err) {
                console.error('[Pomodoro] IDB Save Error:', err);
            }
        });

        // Handle periodic file sync (only when this page is the writer)
        db.on('sync_to_file', async () => {
            console.log('[Pomodoro] Syncing to file...');
            try {
                const snapshot = await db.loadSnapshotFromIDB();
                if (snapshot?.handle) {
                    const data = await db.export();
                    if (await db.ensureFilePermission(snapshot.handle)) {
                        const writable = await snapshot.handle.createWritable();
                        await writable.write(data);
                        await writable.close();
                        console.log('[Pomodoro] ✅ Synced to file:', snapshot.handle.name);
                        updateSyncStatus(true);
                    } else {
                        console.warn('[Pomodoro] File permission not granted');
                        updateSyncStatus(false, '文件权限已丢失');
                    }
                }
            } catch (err) {
                console.error('[Pomodoro] File sync error:', err);
                updateSyncStatus(false, '文件同步失败');
            }
        });

        // Listen for writer status changes
        db.on('writer_changed', async (data) => {
            console.log('[Pomodoro] Writer status changed:', data?.isWriter ? 'I am now the writer' : 'No longer writer');
            if (data?.isWriter) {
                const snapshot = await db.loadSnapshotFromIDB();
                if (snapshot?.handle) {
                    const hasPerm = await db.ensureFilePermission(snapshot.handle);
                    updateSyncStatus(hasPerm, hasPerm ? null : '需授权');
                }
                // Start periodic file sync (every 10 seconds)
                db.startPeriodicSync(10000);
            }
        });

        // Startup: Load from IDB or wait for db_opened
        console.log('[Pomodoro] Setting up startup, db.isOpen =', db.isOpen);

        let initCalled = false;

        db.on('db_opened', () => {
            if (initCalled) return;
            initCalled = true;
            console.log('[Pomodoro] db_opened event received, calling init()...');
            init();
            db.claimWriter();
        });

        if (db.isOpen) {
            initCalled = true;
            console.log('[Pomodoro] DB already open, calling init() immediately...');
            init();
            db.claimWriter();
        } else {
            console.log('[Pomodoro] DB not open, waiting for worker ready...');

            // Wait for worker ready, then load from IDB
            const tryLoadFromIDB = async () => {
                if (initCalled) return;
                console.log('[Pomodoro] Worker ready, trying to load from IDB...');
                try {
                    const snapshot = await db.loadSnapshotFromIDB();
                    if (initCalled) return;
                    if (snapshot && snapshot.data) {
                        console.log('[Pomodoro] Found IDB snapshot, initializing DB...');
                        await db.init(snapshot.data);
                        // db_opened event will be fired by the worker
                    } else {
                        console.error('[Pomodoro] No database found in IDB!');
                        alert('数据库未找到！请先在主页 Settings 中打开数据库文件。\n\nNo database found! Please open a database file in Settings first.');
                    }
                } catch (err) {
                    console.error('[Pomodoro] Failed to load from IDB:', err);
                    alert('数据库加载失败！\n\nFailed to load database!');
                }
            };

            if (db.isReady) {
                console.log('[Pomodoro] Worker already ready, trying IDB...');
                tryLoadFromIDB();
            } else {
                db.on('ready', () => {
                    console.log('[Pomodoro] Got ready event, trying IDB...');
                    tryLoadFromIDB();
                });
                // Double check in case ready event was already fired
                setTimeout(() => {
                    if (db.isReady && !initCalled) {
                        console.log('[Pomodoro] Late ready check, trying IDB...');
                        tryLoadFromIDB();
                    }
                }, 100);
            }
        }


        // Expose to window for HTML events
        window.toggleTagMenu = toggleTagMenu;
        window.toggleSaveTagMenu = toggleSaveTagMenu;
        window.selectSaveTag = selectSaveTag;
        window.openAddTagModal = openAddTagModal;
        window.closeAddTagModal = closeAddTagModal;
        window.selectTag = selectTag;
        window.confirmAddTag = confirmAddTag;
        window.openStats = openStats;
        window.closeStats = closeStats;
        window.toggleFullView = toggleFullView;
        window.onSliderChange = onSliderChange;
        window.exportData = exportData;
        window.editSession = editSession;
        window.closeEditSessionModal = closeEditSessionModal;
        window.confirmEditSession = confirmEditSession;
        window.deleteSession = deleteSession;
        window.undoDelete = undoDelete;
        window.toggleTimer = toggleTimer;
        window.resetTimer = resetTimer;
        window.askCustomDuration = askCustomDuration;
        window.closeCustomDuration = closeCustomDuration;
        window.adjustCustomInput = adjustCustomInput;
        window.confirmCustomDuration = confirmCustomDuration;
        window.confirmSaveSession = confirmSaveSession;
        window.discardSession = discardSession;
        window.openTagsManagement = openTagsManagement;
        window.closeTagsManagement = closeTagsManagement;
        window.editTag = editTag;
        window.confirmDeleteTag = confirmDeleteTag;
        window.setDuration = setDuration;
        window.setStatsTimeRange = setStatsTimeRange;
        window.renderHistoryList = renderHistoryList;
        window.setHistoryFilter = setHistoryFilter;
        window.exportCurrentList = exportCurrentList;
        window.moveSlider = moveSlider;
        window.openExportRecordsModal = openExportRecordsModal;
        window.onExportDateChange = onExportDateChange;
        window.closeExportRecordsModal = closeExportRecordsModal;
        window.copyExportRecords = copyExportRecords;
        window.openExportPanoramaModal = openExportPanoramaModal;
        window.closeExportPanoramaModal = closeExportPanoramaModal;
        window.downloadPanoramaPNG = downloadPanoramaPNG;

        // === Immediate UI Init ===
        console.log('[Pomodoro] Executing immediate UI init...');
        setDuration(25);
        // History filter is now button-based, default is 'today' (set in setHistoryFilter)

    </script>
</body>

</html>