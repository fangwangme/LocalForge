<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>番茄钟 - LocalForge</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(12px, 1fr));
            gap: 2px;
        }

        .pixel-block {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .pixel-filled {
            box-shadow: 0 0 2px rgba(239, 68, 68, 0.5);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>

<body class="bg-slate-900 text-white font-sans min-h-screen">

    <!-- Header -->
    <header
        class="p-4 flex justify-between items-center bg-slate-900/80 backdrop-blur-sm sticky top-0 z-10 border-b border-slate-800">
        <div class="flex items-center gap-4">
            <a href="index.html"
                class="text-xl font-bold tracking-wider hover:opacity-80 transition flex items-center gap-2">
                <i class="fas fa-clock text-rose-500"></i>番茄钟
            </a>
            <!-- Tag Selector -->
            <div class="relative group">
                <button onclick="toggleTagMenu()" id="currentTagBtn"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700 hover:border-slate-600 text-sm transition">
                    <span id="currentTagDot" class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
                    <span id="currentTagName">Work</span>
                    <i class="fas fa-chevron-down text-xs text-slate-500"></i>
                </button>
                <div id="tagMenu"
                    class="hidden absolute top-full left-0 mt-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-2 z-20">
                    <div id="tagList" class="max-h-60 overflow-y-auto">
                        <!-- Tags rendered here -->
                    </div>
                    <div class="border-t border-slate-700 mt-1 pt-1 px-2">
                        <button onclick="openAddTagModal()"
                            class="w-full text-left px-2 py-1.5 text-xs text-slate-400 hover:text-white rounded hover:bg-slate-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> 新建标签
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="openStats()" class="p-2 text-slate-400 hover:text-white transition" title="统计历史">
                <i class="fas fa-history text-lg"></i>
            </button>
            <button onclick="exportData()" class="p-2 text-slate-400 hover:text-white transition" title="导出数据">
                <i class="fas fa-download text-lg"></i>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">

        <!-- Timer View -->
        <div id="timerView" class="flex flex-col items-center justify-center min-h-[60vh]">

            <!-- Digital Timer -->
            <div class="text-[8rem] font-bold font-mono tracking-tighter leading-none mb-4 tabular-nums text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400"
                id="digitalTimer">
                25:00
            </div>

            <!-- Pixel Tomato -->
            <div class="w-full max-w-md mb-12">
                <div id="pixelGrid"
                    class="pixel-grid bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 backdrop-blur-sm">
                    <!-- Blocks injected here -->
                </div>
                <div class="text-center mt-2 text-xs text-slate-500">
                    <span id="progressText">0 / 25 min</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex items-center gap-6">

                <!-- Duration Settings (Only valid when stopped) -->
                <div id="durationSettings"
                    class="flex items-center bg-slate-800 rounded-full p-1 border border-slate-700">
                    <button onclick="setDuration(15)"
                        class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                        data-min="15">15</button>
                    <button onclick="setDuration(25)"
                        class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm"
                        data-min="25">25</button>
                    <button onclick="setDuration(45)"
                        class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                        data-min="45">45</button>
                    <button onclick="setDuration(60)"
                        class="duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"
                        data-min="60">60</button>
                    <button onclick="askCustomDuration()"
                        class="px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white"><i
                            class="fas fa-edit"></i></button>
                </div>

                <!-- Main Action -->
                <button id="mainBtn" onclick="toggleTimer()"
                    class="h-16 w-16 rounded-full bg-rose-500 hover:bg-rose-400 text-white text-2xl flex items-center justify-center shadow-lg shadow-rose-500/30 transition transform hover:scale-105 active:scale-95">
                    <i class="fas fa-play ml-1"></i>
                </button>

                <!-- Reset (Hidden when stopped) -->
                <button id="resetBtn" onclick="resetTimer()"
                    class="h-12 w-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center shadow-lg transition opacity-50 cursor-not-allowed pointer-events-none">
                    <i class="fas fa-rotate-right"></i>
                </button>

                <!-- Skip (Hidden by default) -->
                <button id="skipBtn" onclick="skipRelax()"
                    class="hidden h-12 w-12 rounded-full bg-slate-700 hover:bg-slate-600 text-white flex items-center justify-center shadow-lg transition"
                    title="跳过">
                    <i class="fas fa-forward"></i>
                </button>

            </div>

            <!-- Notification Toggle -->
            <div class="mt-8 flex items-center gap-2 opacity-50 hover:opacity-100 transition duration-300">
                <input type="checkbox" id="notifyToggle"
                    class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-rose-500 focus:ring-rose-500 focus:ring-offset-slate-900 cursor-pointer accent-rose-500">
                <label for="notifyToggle" class="text-sm text-slate-400 cursor-pointer select-none">任务结束通知</label>
            </div>
        </div>

        <!-- Stats View (Modal/Overlay) -->
        <div id="statsOverlay"
            class="fixed inset-0 bg-slate-900 z-30 transform translate-y-full transition duration-300 overflow-y-auto">
            <div class="max-w-5xl mx-auto px-4 py-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-chart-pie text-rose-500"></i> 数据概览
                    </h2>
                    <button onclick="closeStats()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-full transition">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                        <div class="text-slate-400 text-xs mb-1">今日专注</div>
                        <div class="text-2xl font-bold text-white"><span id="todayCount">0</span> <span
                                class="text-sm font-normal text-slate-500">个番茄</span></div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                        <div class="text-slate-400 text-xs mb-1">今日时长</div>
                        <div class="text-2xl font-bold text-blue-400"><span id="todayMins">0</span> <span
                                class="text-sm font-normal text-slate-500">分钟</span></div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                        <div class="text-slate-400 text-xs mb-1">本周累计</div>
                        <div class="text-2xl font-bold text-emerald-400"><span id="weekCount">0</span> <span
                                class="text-sm font-normal text-slate-500">个</span></div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700/50">
                        <div class="text-slate-400 text-xs mb-1">总专注时长</div>
                        <div class="text-2xl font-bold text-amber-400"><span id="totalHours">0.0</span> <span
                                class="text-sm font-normal text-slate-500">小时</span></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-medium text-slate-300">专注趋势</h3>
                            <div class="flex items-center gap-4">
                                <button onclick="toggleFullView()" id="fullViewBtn"
                                    class="px-2 py-1 text-xs border border-slate-600 rounded text-slate-400 hover:text-white hover:border-slate-400 transition">
                                    <i class="fas fa-expand"></i> 全景
                                </button>
                                <div class="flex items-center gap-2 text-xs text-slate-400" id="sliderContainer">
                                    <button onclick="moveSlider(-1)" class="p-1 hover:text-white transition"><i
                                            class="fas fa-chevron-left"></i></button>
                                    <input type="range" id="chartSlider" min="0" max="20" step="1" value="0"
                                        class="w-24 md:w-32 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                                        oninput="onSliderChange(this.value)">
                                    <button onclick="moveSlider(1)" class="p-1 hover:text-white transition"><i
                                            class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700/50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-sm font-medium text-slate-300">分布占比</h3>
                            <div class="flex bg-slate-900 rounded-lg p-0.5 border border-slate-700">
                                <button onclick="setDistMode('today')" id="distModeToday"
                                    class="px-3 py-1 text-xs rounded-md transition bg-slate-700 text-white shadow-sm">今天</button>
                                <button onclick="setDistMode('week')" id="distModeWeek"
                                    class="px-3 py-1 text-xs rounded-md transition text-slate-400 hover:text-white">本周</button>
                            </div>
                        </div>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="distChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- History List -->
                <div class="bg-slate-800 rounded-xl border border-slate-700/50 overflow-hidden">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-medium text-slate-300">详细记录</h3>
                        <div class="flex gap-2">
                            <select id="historyFilter" onchange="renderHistoryList()"
                                class="bg-slate-900 border border-slate-700 text-xs rounded px-2 py-1 outline-none focus:border-blue-500">
                                <option value="all">全部</option>
                                <option value="today">今天</option>
                                <option value="week">本周</option>
                            </select>
                        </div>
                    </div>
                    <div id="historyList" class="divide-y divide-slate-700/50 max-h-96 overflow-y-auto">
                        <!-- Items -->
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Save Modal -->
    <div id="saveModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div
            class="bg-slate-800 border-t-4 border-rose-500 rounded-2xl w-full max-w-sm p-8 shadow-2xl transform scale-90 transition-transform duration-300">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-3xl animate-bounce">
                    <i class="fas fa-check"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">专注达成！</h3>
                <p class="text-slate-400">刚刚完成了 <span id="saveDuration" class="text-white font-bold">25</span> 分钟的专注。
                </p>
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6">
                <div class="text-xs text-slate-500 mb-1">标签</div>
                <div class="flex items-center gap-2 mb-3">
                    <span id="saveTagColor" class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span id="saveTagName" class="text-sm font-medium text-slate-300">Work</span>
                </div>
                <div>
                    <label class="block text-xs text-slate-500 mb-1">备注 (可选)</label>
                    <textarea id="saveDescription" rows="2" placeholder="做了什么？"
                        class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm text-white placeholder-slate-500 focus:border-rose-500 outline-none transition resize-none"></textarea>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="discardSession()"
                    class="py-3 rounded-xl border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">
                    丢弃
                </button>
                <button onclick="confirmSaveSession()"
                    class="py-3 rounded-xl bg-rose-600 hover:bg-rose-500 text-white font-bold shadow-lg shadow-rose-600/20 transition">
                    记录
                </button>
            </div>
        </div>
    </div>

    <!-- Add Tag Modal -->
    <div id="addTagModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">新建标签</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">名称</label>
                    <input type="text" id="newTagName" placeholder="例如：Coding"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">颜色</label>
                    <div class="grid grid-cols-5 gap-2" id="colorPicker">
                        <!-- Colors generated by JS -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('addTagModal').classList.add('hidden')"
                    class="px-3 py-1.5 text-xs text-slate-400 hover:text-white">取消</button>
                <button onclick="confirmAddTag()"
                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded">保存</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="editSessionModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-white">编辑记录</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">开始时间</label>
                    <input type="datetime-local" id="editStartTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">结束时间</label>
                    <input type="datetime-local" id="editEndTime"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">标签</label>
                    <select id="editTagSelect"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">备注</label>
                    <textarea id="editDescription" rows="2"
                        class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500 outline-none resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEditSessionModal()"
                    class="px-4 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">取消</button>
                <button onclick="confirmEditSession()"
                    class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">保存</button>
            </div>
        </div>
    </div>

    <!-- Custom Duration Modal -->
    <div id="customDurationModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-xs p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-center">自定义时长</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <button onclick="adjustCustomInput(-5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-minus"></i></button>
                        <div class="text-3xl font-bold font-mono text-blue-400 w-20 text-center">
                            <span id="customInputDisplay">25</span>
                        </div>
                        <button onclick="adjustCustomInput(5)"
                            class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white transition"><i
                                class="fas fa-plus"></i></button>
                    </div>
                    <input type="range" id="customInputRange" min="1" max="180" step="1" value="25"
                        class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2"
                        oninput="updateCustomDisplay(this.value)">
                    <p class="text-center text-xs text-slate-500">分钟</p>
                </div>
            </div>
            <div class="flex justify-between gap-3 mt-6">
                <button onclick="closeCustomDuration()"
                    class="flex-1 py-2 rounded-lg border border-slate-600 text-slate-400 hover:text-white hover:bg-slate-700 transition">取消</button>
                <button onclick="confirmCustomDuration()"
                    class="flex-1 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg shadow-blue-600/20 transition">确定</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/db-client.js';

        console.log('[Pomodoro] Script starting...');

        // === State ===
        let currentState = 'stopped'; // stopped, running, paused
        let durationMinutes = 25;
        let timeLeftSeconds = 25 * 60;
        let timerInterval = null;
        let startTime = null;

        let currentTag = null; // Will be set on load
        let tags = [];
        let sessions = [];
        let currentDistMode = 'today'; // 'today' or 'week'

        // === DOM Elements ===
        const els = {
            digital: document.getElementById('digitalTimer'),
            pixelGrid: document.getElementById('pixelGrid'),
            mainBtn: document.getElementById('mainBtn'),
            resetBtn: document.getElementById('resetBtn'),
            durationBtns: document.querySelectorAll('.duration-btn'),
            statsOverlay: document.getElementById('statsOverlay'),
            saveModal: document.getElementById('saveModal'),
            tagMenu: document.getElementById('tagMenu'),
            tagList: document.getElementById('tagList'),
            currentTagName: document.getElementById('currentTagName'),
            currentTagDot: document.getElementById('currentTagDot'),
            progressText: document.getElementById('progressText'),
            skipBtn: document.getElementById('skipBtn')
        };

        // === Init ===
        async function init() {
            console.log('[Pomodoro] init() called.');

            // 1. DB Init
            await initTables();

            // document.getElementById('historyFilter').value = 'today'; // Moved to immediate init
            // setDuration(25); // Moved to immediate init

            // 2. Data Init
            await requestData();

            // Notify Toggle & Permission Sync
            const notifyToggle = document.getElementById('notifyToggle');

            if ('Notification' in window) {
                // Handle User Click - request permission when checked
                notifyToggle.addEventListener('change', (e) => {
                    if (notifyToggle.checked) {
                        if (Notification.permission === 'granted') {
                            notifyToggle.parentElement.classList.remove('opacity-50');
                        } else {
                            Notification.requestPermission().then(perm => {
                                if (perm === 'granted') {
                                    notifyToggle.parentElement.classList.remove('opacity-50');
                                } else {
                                    notifyToggle.checked = false;
                                    alert('请在浏览器设置中允许通知权限。');
                                }
                            });
                        }
                    } else {
                        notifyToggle.parentElement.classList.add('opacity-50');
                    }
                });
            } else {
                notifyToggle.parentElement.classList.add('opacity-50');
                notifyToggle.disabled = true;
            }
        }

        // === Timer Logic ===
        function setDuration(mins) {
            if (currentState === 'running') return;
            durationMinutes = mins;
            timeLeftSeconds = mins * 60;
            updateDigitalDisplay();
            renderPixels();

            // UI Update
            els.durationBtns.forEach(btn => {
                const btnMins = parseInt(btn.dataset.min);
                if (btnMins === mins) {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition bg-slate-700 text-white shadow-sm';
                } else {
                    btn.className = 'duration-btn px-4 py-2 rounded-full text-sm font-medium transition text-slate-400 hover:text-white';
                }
            });
        }

        function askCustomDuration() {
            if (currentState === 'running') return;
            const modal = document.getElementById('customDurationModal');
            const range = document.getElementById('customInputRange');
            // Set current
            range.value = durationMinutes;
            updateCustomDisplay(durationMinutes);

            modal.classList.remove('hidden');
        }

        function closeCustomDuration() {
            document.getElementById('customDurationModal').classList.add('hidden');
        }

        function updateCustomDisplay(val) {
            document.getElementById('customInputDisplay').innerText = val;
            document.getElementById('customInputRange').value = val;
        }

        function adjustCustomInput(delta) {
            const range = document.getElementById('customInputRange');
            let val = parseInt(range.value) + delta;
            if (val < 1) val = 1;
            if (val > 180) val = 180;
            updateCustomDisplay(val);
        }

        function confirmCustomDuration() {
            const val = parseInt(document.getElementById('customInputRange').value);
            setDuration(val);
            closeCustomDuration();
        }

        async function toggleTimer() {
            if (currentState === 'stopped' || currentState === 'paused') {
                // Check file permission before starting
                if (currentState === 'stopped') {
                    await ensureFilePermission();
                }
                startTimer();
            } else {
                pauseTimer();
            }
        }

        let targetEndTime = null;

        function startTimer() {
            if (currentState === 'stopped') {
                startTime = new Date();
                timeLeftSeconds = durationMinutes * 60; // Reset just in case
            }

            // Calculate target end time based on current remaining seconds
            // This works for both fresh start and resume
            targetEndTime = Date.now() + (timeLeftSeconds * 1000);

            currentState = 'running';
            els.mainBtn.innerHTML = '<i class="fas fa-pause"></i>';
            els.mainBtn.classList.add('bg-amber-500', 'hover:bg-amber-400', 'shadow-amber-500/30');
            els.mainBtn.classList.remove('bg-rose-500', 'hover:bg-rose-400', 'shadow-rose-500/30');

            els.resetBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            els.resetBtn.classList.add('opacity-100', 'cursor-pointer', 'bg-red-500', 'hover:bg-red-600');
            els.resetBtn.onclick = resetTimer; // Enable click
            els.resetBtn.onclick = resetTimer; // Enable click
            els.resetBtn.innerHTML = '<i class="fas fa-stop"></i>';

            checkSkipButton();

            // Use timestamp diffing for accuracy
            // Poll faster (200ms) to ensure UI updates roughly on time, but rely on Date.now() for value
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                const diff = Math.ceil((targetEndTime - now) / 1000);

                if (diff > 0) {
                    if (timeLeftSeconds !== diff) {
                        timeLeftSeconds = diff;
                        updateDigitalDisplay();
                        updatePixelDisplay();
                    }
                } else {
                    timeLeftSeconds = 0;
                    updateDigitalDisplay();
                    updatePixelDisplay();
                    completeSession();
                }
            }, 200);
        }

        function pauseTimer() {
            currentState = 'paused';
            clearInterval(timerInterval);
            els.mainBtn.innerHTML = '<i class="fas fa-play ml-1"></i>';
            els.mainBtn.classList.add('bg-rose-500', 'hover:bg-rose-400', 'shadow-rose-500/30');
            els.mainBtn.classList.remove('bg-amber-500', 'hover:bg-amber-400', 'shadow-amber-500/30');
            els.mainBtn.classList.remove('bg-amber-500', 'hover:bg-amber-400', 'shadow-amber-500/30');
            checkSkipButton();
        }

        function resetTimer() {
            pauseTimer();
            currentState = 'stopped';
            timeLeftSeconds = durationMinutes * 60;
            updateDigitalDisplay();
            renderPixels(); // Reset pixels

            els.resetBtn.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            els.resetBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            els.resetBtn.classList.add('bg-slate-700', 'hover:bg-slate-600');
            els.resetBtn.innerHTML = '<i class="fas fa-rotate-right"></i>';
            els.resetBtn.classList.add('bg-slate-700', 'hover:bg-slate-600');
            els.resetBtn.innerHTML = '<i class="fas fa-rotate-right"></i>';
            checkSkipButton();
        }

        function completeSession() {
            pauseTimer(); // Stop interval
            currentState = 'stopped'; // Reset state
            playCompletionSound();

            // System Notification
            const notifyToggle = document.getElementById('notifyToggle');
            console.log('[Pomodoro] Notification check:', {
                checked: notifyToggle?.checked,
                permission: typeof Notification !== 'undefined' ? Notification.permission : 'N/A'
            });

            if (notifyToggle && notifyToggle.checked) {
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    try {
                        const n = new Notification('专注完成！', {
                            body: `恭喜！你刚刚完成了 ${durationMinutes} 分钟的专注。`,
                            icon: 'favicon.png',
                            tag: 'pomodoro-complete'
                        });
                        console.log('[Pomodoro] Notification sent:', n);
                    } catch (e) {
                        console.error('[Pomodoro] Notify Error:', e);
                    }
                } else {
                    console.log('[Pomodoro] Notification permission not granted, requesting...');
                    Notification.requestPermission();
                }
            }


            // Show Modal
            document.getElementById('saveDuration').innerText = durationMinutes;
            document.getElementById('saveTagColor').style.backgroundColor = currentTag.color;
            document.getElementById('saveTagName').innerText = currentTag.name;
            document.getElementById('saveDescription').value = ''; // Clear previous input

            const modal = els.saveModal;
            modal.classList.remove('hidden');
            // Trigger animation
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-90');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function discardSession() {
            closeSaveModal();
            resetTimer();
        }

        let pomosCompleted = 0;
        let lastWorkTagId = null;

        async function confirmSaveSession() {
            // Save to DB
            const end = new Date();
            const start = startTime || new Date(end.getTime() - durationMinutes * 60000);
            const desc = document.getElementById('saveDescription').value.trim();

            try {
                // Check if cross day
                if (start.toDateString() !== end.toDateString()) {
                    // Split into two
                    // 1. Start to Midnight
                    const midnight = new Date(start);
                    midnight.setHours(24, 0, 0, 0); // Next midnight

                    const dur1 = Math.round((midnight - start) / 60000);
                    const dur2 = durationMinutes - dur1;

                    // Save Part 1 (Yesterday)
                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)`,
                        [start.toISOString(), midnight.toISOString(), dur1, currentTag.id, 'completed', desc + ' (Part 1)', new Date().toISOString()]
                    );

                    // Save Part 2 (Today)
                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)`,
                        [midnight.toISOString(), end.toISOString(), dur2, currentTag.id, 'completed', desc, new Date().toISOString()]
                    );
                } else {
                    // Normal Save
                    await db.execute(
                        `INSERT INTO pomodoro_sessions (start_time, end_time, duration_minutes, tag_id, status, description, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)`,
                        [start.toISOString(), end.toISOString(), durationMinutes, currentTag.id, 'completed', desc, new Date().toISOString()]
                    );
                }
            } catch (err) {
                console.error('Save Session Failed:', err);
            }

            closeSaveModal();
            handleAutoFlow();
        }

        async function saveTag(inputValue) {
            if (inputValue) {
                const newTag = { name: inputValue, color: '#64748b' }; // Default color
                try {
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, 0)", [newTag.name, newTag.color]);
                    // Reload tags will happen via db_updated event
                } catch (e) { console.error(e); }

                closeAddTagModal();
            }
        }

        async function deleteTag(tagId) {
            try {
                await db.execute("DELETE FROM pomodoro_tags WHERE id = ?", [tagId]);
            } catch (e) { console.error(e); }
        }


        function handleAutoFlow() {
            // Check if current was Relax
            const isRelax = currentTag.name === 'Relax' || currentTag.name === 'Break' || currentTag.name === 'Rest' || currentTag.name === 'Relax';

            if (isRelax) {
                // Determine next step: Back to Work
                // Restore last work tag if available
                if (lastWorkTagId) {
                    const workTag = tags.find(t => t.id === lastWorkTagId);
                    if (workTag) {
                        currentTag = workTag;
                        els.currentTagName.innerText = workTag.name;
                        els.currentTagDot.style.backgroundColor = workTag.color;
                    }
                }
                // Default work duration
                setDuration(25);
                resetTimer(); // Updates display

            } else {
                // Must be work session
                pomosCompleted++;
                lastWorkTagId = currentTag.id;

                let breakMins = 5;
                if (pomosCompleted % 4 === 0) {
                    breakMins = 15; // Long break
                }

                // Find Relax Tag (Default is provided in index.html as 'Relax')
                // But we load tags from DB. We need to find one with name 'Relax'.
                const relaxTag = tags.find(t => t.name === 'Relax') || tags.find(t => t.name === 'Rest');
                if (relaxTag) {
                    selectTag(relaxTag.id);
                }

                setDuration(breakMins);
                resetTimer();

                if (breakMins === 15) {
                    // Optional: Notify user of long break
                }
            }
        }

        // === Skip Logic ===
        function checkSkipButton() {
            // Check if current is Relax
            const isRelax = currentTag && (currentTag.name === 'Relax' || currentTag.name === 'Break' || currentTag.name === 'Rest');

            // Show skip if:
            // 1. Tag is Relax
            // 2. Timer is NOT stopped (running or paused) OR if stopped but we want to skip from start? 
            // Usually skip is valid even if stopped, if we are in 'Relax' mode waiting to start.
            // But let's say, if we are in 'Relax' mode, we can always skip back to work.

            if (isRelax) {
                els.skipBtn.classList.remove('hidden');
            } else {
                els.skipBtn.classList.add('hidden');
            }
        }

        function skipRelax() {
            // Confirm we are in relax
            const isRelax = currentTag.name === 'Relax' || currentTag.name === 'Break' || currentTag.name === 'Rest';
            if (!isRelax) return;

            // Stop timer if running
            if (currentState === 'running') {
                clearInterval(timerInterval);
                currentState = 'stopped';

                // Reset Main Button UI
                els.mainBtn.innerHTML = '<i class="fas fa-play ml-1"></i>';
                els.mainBtn.classList.add('bg-rose-500', 'hover:bg-rose-400', 'shadow-rose-500/30');
                els.mainBtn.classList.remove('bg-amber-500', 'hover:bg-amber-400', 'shadow-amber-500/30');

                // Reset Reset Button UI
                els.resetBtn.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                els.resetBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                els.resetBtn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                els.resetBtn.innerHTML = '<i class="fas fa-rotate-right"></i>';
            }

            // Execute AutoFlow to switch to Work
            handleAutoFlow();
        }

        function closeSaveModal() {
            const modal = els.saveModal;
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-90');
            modal.querySelector('div').classList.remove('scale-100');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // === Audio Logic ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playCompletionSound() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const now = audioCtx.currentTime;

            // Note 1: E5 (659.25 Hz)
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(659.25, now);
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.start(now);
            osc1.stop(now + 0.5);

            // Note 2: G#5 (830.61 Hz)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(830.61, now + 0.1);
            gain2.gain.setValueAtTime(0.1, now + 0.1);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start(now + 0.1);
            osc2.stop(now + 0.6);

            // Note 3: B5 (987.77 Hz) - Major chord finish
            const osc3 = audioCtx.createOscillator();
            const gain3 = audioCtx.createGain();
            osc3.type = 'sine';
            osc3.frequency.setValueAtTime(987.77, now + 0.2);
            gain3.gain.setValueAtTime(0.1, now + 0.2);
            gain3.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
            osc3.connect(gain3);
            gain3.connect(audioCtx.destination);
            osc3.start(now + 0.2);
            osc3.stop(now + 1.2);
        }

        // === UI Rendering ===
        function updateDigitalDisplay() {
            const mins = Math.floor(timeLeftSeconds / 60);
            const secs = timeLeftSeconds % 60;
            els.digital.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            document.title = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')} - 番茄钟`;
        }

        // Smoother, rounder tomato shape
        const TOMATO_MAP = [
            [0, 0, 0, 0, 0, 2, 2, 2, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0],
            [0, 0, 1, 1, 2, 2, 2, 2, 2, 1, 1, 0, 0],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
            [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0],
            [0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0]
        ];

        function renderPixels() {
            els.pixelGrid.innerHTML = '';
            els.pixelGrid.style.display = 'grid';
            els.pixelGrid.style.gridTemplateColumns = `repeat(13, 1fr)`;
            els.pixelGrid.style.gap = '2px';
            els.pixelGrid.style.maxWidth = '300px';
            els.pixelGrid.style.margin = '0 auto';

            TOMATO_MAP.flat().forEach((val, index) => {
                const div = document.createElement('div');
                div.id = `pixel-${index}`;

                if (val === 0) {
                    div.className = 'pixel-block invisible';
                } else {
                    div.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                    div.dataset.type = val; // 1=Body, 2=Stem
                    // Keep aspect ratio roughly square
                    div.style.aspectRatio = '1/1';
                }
                els.pixelGrid.appendChild(div);
            });

            els.progressText.innerText = `0 / ${durationMinutes} min`;
        }

        function updatePixelDisplay() {
            const totalSeconds = durationMinutes * 60;
            const elapsed = totalSeconds - timeLeftSeconds;
            const percentage = elapsed / totalSeconds;
            const elapsedMins = Math.floor(elapsed / 60);

            // Update text
            els.progressText.innerText = `${elapsedMins} / ${durationMinutes} min`;

            // Calculate active pixels
            const allPixels = Array.from(els.pixelGrid.children);
            const fillablePixels = allPixels.filter(el => !el.classList.contains('invisible'));
            const countToFill = Math.floor(fillablePixels.length * percentage);

            fillablePixels.forEach((block, i) => {
                const type = block.dataset.type;
                if (i < countToFill) {
                    if (type === '2') {
                        block.style.backgroundColor = '#4ade80'; // Green stem
                    } else {
                        block.style.backgroundColor = '#f43f5e'; // Rose-500 (Redder Tomato)
                    }
                    block.classList.add('shadow-[0_0_5px_rgba(0,0,0,0.5)]');
                    // Add a slight "lit" effect override opacity/brightness if needed
                    block.style.filter = 'brightness(1.2)';
                } else {
                    block.style.backgroundColor = ''; // Revert to slate-800
                    block.classList.remove('bg-slate-800'); // Wait, we need base color
                    block.className = 'pixel-block bg-slate-800 rounded-sm transition-all duration-300';
                    block.style.filter = '';
                    block.style.boxShadow = '';
                }
            });
        }

        // === Tag Logic ===
        function toggleTagMenu() {
            els.tagMenu.classList.toggle('hidden');
        }

        function selectTag(id) {
            const t = tags.find(tag => tag.id === id);
            if (t) {
                currentTag = t;
                els.currentTagName.innerText = t.name;
                els.currentTagDot.style.backgroundColor = t.color;
                // Update visuals if not running
                if (currentState === 'stopped') {
                    // Update pixel colors if any were filled? No, they are empty when stopped.
                }
            }
            els.tagMenu.classList.add('hidden');
            checkSkipButton();
        }

        function renderTags(tagList) {
            if (tagList) {
                tags = tagList.map(r => ({
                    id: r.values[0],
                    name: r.values[1],
                    color: r.values[2],
                    isDefault: r.values[3] === 1
                }));
            }

            if (tags.length === 0) {
                // No tags found? Create defaults.
                console.log('[Pomodoro] No tags found, creating defaults...');
                createDefaultTags();
                return;
            }

            // Logic to determine selection
            let selected = null;
            if (currentTag) {
                // Try to keep current selection
                selected = tags.find(t => t.id === currentTag.id);
            }

            if (!selected) {
                // Fallback: Default tag or First tag
                selected = tags.find(t => t.isDefault) || tags[0];
            }

            // Update currentTag reference
            currentTag = selected;
            // Update UI for current tag
            if (currentTag) {
                try {
                    els.currentTagName.innerText = currentTag.name;
                    els.currentTagDot.style.backgroundColor = currentTag.color;
                    checkSkipButton();
                } catch (e) { }
            }

            els.tagList.innerHTML = tags.map(t => `
                <button onclick="selectTag(${t.id})" class="w-full text-left px-3 py-2 hover:bg-slate-700 transition flex items-center justify-between group">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${t.color}"></span>
                        <span class="text-sm text-slate-300 group-hover:text-white">${t.name}</span>
                    </div>
                    ${(currentTag && t.id === currentTag.id) ? '<i class="fas fa-check text-xs text-blue-500"></i>' : ''}
                </button>
            `).join('');
        }

        async function createDefaultTags() {
            const defaults = [
                { name: 'Work', color: '#3b82f6', is_default: 1 },
                { name: 'Relax', color: '#10b981', is_default: 0 },
                { name: 'Study', color: '#f59e0b', is_default: 0 }
            ];

            for (const d of defaults) {
                try {
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, ?)", [d.name, d.color, d.is_default]);
                } catch (e) { }
            }

            // Reload after short delay (or wait for event)
            setTimeout(requestData, 500); // reuse requestData which loads tags
        }

        // Add Tag color picker
        const presetColors = [
            '#64748b', '#78716c', // Slate, Stone
            '#ef4444', '#f97316', '#f59e0b', '#eab308', // Red, Orange, Amber, Yellow
            '#84cc16', '#22c55e', '#10b981', '#14b8a6', // Lime, Green, Emerald, Teal
            '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', // Cyan, Sky, Blue, Indigo
            '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e' // Violet, Purple, Fuchsia, Pink, Rose
        ];
        let newTagColor = presetColors[0];

        function openAddTagModal() {
            els.tagMenu.classList.add('hidden');
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = presetColors.map(c => `
                <button onclick="selectNewTagColor('${c}')" class="w-6 h-6 rounded-full border-2 ${c === newTagColor ? 'border-white' : 'border-transparent'} hover:scale-110 transition" style="background-color: ${c}"></button>
            `).join('');
            document.getElementById('addTagModal').classList.remove('hidden');
        }

        function closeAddTagModal() {
            document.getElementById('addTagModal').classList.add('hidden');
        }

        function selectNewTagColor(c) {
            newTagColor = c;
            openAddTagModal(); // Re-render selection
        }

        async function confirmAddTag() {
            const name = document.getElementById('newTagName').value.trim();
            if (!name) return;

            try {
                await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES (?, ?, 0)", [name, newTagColor]);
            } catch (e) { console.error('Add Tag Failed:', e); }

            document.getElementById('addTagModal').classList.add('hidden');
            document.getElementById('newTagName').value = '';
        }


        // === Stats Logic ===
        function openStats() {
            els.statsOverlay.classList.remove('translate-y-full');
            // Load stats data
            requestData();
        }

        function closeStats() {
            els.statsOverlay.classList.add('translate-y-full');
        }

        async function requestData() {
            if (!db.isOpen) {
                // console.warn('Database not open');
                if (!document.getElementById('db-warning-toast')) {
                    const toast = document.createElement('div');
                    toast.id = 'db-warning-toast';
                    toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full shadow-lg z-50 animate-bounce';
                    toast.innerText = '请先在主页打开数据库 / Please open database in Dashboard';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
                return;
            }

            // Calculate Start of Week (Monday)
            const now = new Date();
            const day = now.getDay() || 7;
            if (day !== 1 || now.getHours() !== 0 || now.getMinutes() !== 0 || now.getSeconds() !== 0 || now.getMilliseconds() !== 0) {
                now.setHours(0, 0, 0, 0);
                now.setDate(now.getDate() - (day - 1));
            }
            const startOfWeek = now.toISOString();

            try {
                // 1. Get Tags
                console.log('[Pomodoro] Querying tags...');
                const tagsResult = await db.query("SELECT id, name, color, is_default FROM pomodoro_tags");
                console.log('[Pomodoro] Tags result:', tagsResult);
                if (tagsResult && tagsResult.length > 0) {
                    const formattedTags = tagsResult[0].values.map(v => ({ values: v }));
                    console.log('[Pomodoro] Formatted tags:', formattedTags);
                    renderTags(formattedTags);
                } else {
                    console.log('[Pomodoro] No tags found in database');
                }

                // 2. Get Sessions
                console.log('[Pomodoro] Querying sessions from', startOfWeek);
                const sessionsResult = await db.query("SELECT id, start_time, end_time, duration_minutes, tag_id, status, description FROM pomodoro_sessions WHERE start_time >= ? ORDER BY start_time DESC", [startOfWeek]);
                console.log('[Pomodoro] Sessions result:', sessionsResult);

                if (sessionsResult && sessionsResult.length > 0) {
                    const raw = sessionsResult[0].values;
                    sessions = raw.map(r => ({
                        id: r[0], startTime: r[1], endTime: r[2], duration: r[3], tagId: r[4], status: r[5], description: r[6] || ''
                    }));
                    console.log('[Pomodoro] Parsed sessions:', sessions.length);
                } else {
                    sessions = [];
                    console.log('[Pomodoro] No sessions found');
                }

                if (!els.statsOverlay.classList.contains('translate-y-full')) {
                    updateStatsUI();
                }

            } catch (err) {
                console.error('[Pomodoro] Data Load Error:', err);
            }
        }

        // Listen for updates (reload data + save to IDB)
        db.on('db_updated', () => {
            console.log('[Pomodoro] DB Updated, reloading...');
            requestData();
            // Note: saveSnapshotToIDB is registered separately below
        });


        let trendChart = null;
        let distChart = null;

        function updateStatsUI() {
            // Helper: get tag
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
            const isRelax = (s) => getTag(s.tagId).name === 'Relax';

            const now = new Date();

            // 1. Summary Cards (Exclude Relax)
            // Filter out Relax for ALL summary metrics
            const focusSessions = sessions.filter(s => !isRelax(s));

            const today = focusSessions.filter(s => new Date(s.startTime).toDateString() === now.toDateString());
            const todayMins = today.reduce((sum, s) => sum + s.duration, 0);

            // Week start (Monday)
            const d = new Date(now);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const weekStart = new Date(d.setDate(diff));
            weekStart.setHours(0, 0, 0, 0);

            const week = focusSessions.filter(s => new Date(s.startTime) >= weekStart);
            const totalMins = focusSessions.reduce((sum, s) => sum + s.duration, 0);

            document.getElementById('todayCount').innerText = today.length;
            document.getElementById('todayMins').innerText = todayMins;
            document.getElementById('weekCount').innerText = week.length;
            document.getElementById('totalHours').innerText = (totalMins / 60).toFixed(1);

            // 2. Charts
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            const ctxDist = document.getElementById('distChart').getContext('2d');

            // Trend: Last 7 Days Timeline (0-24h) - INCLUDE Relax (User request)
            const timelineData = [];
            const timelineColors = [];
            const dayLabels = [];

            // 1. Generate last 7 days labels (Y-axis categories)
            for (let i = 0; i < 7; i++) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dayStr = d.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }); // e.g. 12/13
                dayLabels.unshift(dayStr);
            }

            // 2. Map sessions to timeline bars
            sessions.forEach(s => {
                const sDate = new Date(s.startTime);
                const dayStr = sDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });

                // Only include if this day is in our last 7 days
                const dayIndex = dayLabels.indexOf(dayStr);
                if (dayIndex !== -1) {
                    const startDisp = sDate.getHours() + sDate.getMinutes() / 60;
                    const endDisp = startDisp + (s.duration / 60);

                    const tag = getTag(s.tagId);

                    timelineData.push({
                        x: [startDisp, endDisp],
                        y: dayStr, // Matches Y-axis label
                        tag: tag.name, // For tooltip
                        rawStart: sDate // For tooltip formatting
                    });
                    timelineColors.push(tag.color); // Color by tag
                }
            });

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctxTrend, {
                type: 'bar',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: '专注记录',
                        data: timelineData,
                        backgroundColor: timelineColors,
                        borderWidth: 0,
                        barPercentage: 0.6, // Thinner bars for elegance
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    // Move Tag and Duration to Title
                                    const raw = context[0].raw;
                                    const durationHours = raw.x[1] - raw.x[0];
                                    const totalMins = Math.round(durationHours * 60);

                                    let durationStr = '';
                                    if (totalMins < 60) {
                                        durationStr = `${totalMins}分钟`;
                                    } else {
                                        const h = Math.floor(totalMins / 60);
                                        const m = totalMins % 60;
                                        durationStr = m > 0 ? `${h}小时${m}分钟` : `${h}小时`;
                                    }
                                    return `${raw.y} · ${raw.tag} · ${durationStr}`;
                                },
                                label: function (context) {
                                    // Only show Time Range in body
                                    const raw = context.raw;
                                    const st = raw.rawStart;
                                    const itemDuration = raw.x[1] - raw.x[0];
                                    const ed = new Date(st.getTime() + itemDuration * 3600000);

                                    const formatTime = (d) => d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                                    return `${formatTime(st)} - ${formatTime(ed)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 24, // WILL BE OVERRIDDEN by slider logic immediately after
                            grid: { color: '#334155' },
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return value + ':00';
                                },
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#cbd5e1' }
                        }
                    }
                }
            });



            // 3. Distribution Chart (Rendered separately)
            renderDistChart();

            // 4. History List
            renderHistoryList();

            // 4. Set Initial Slider Position (Center on Now)
            const currentHour = new Date().getHours();
            let safeStart = currentHour - 2;
            if (safeStart < 0) safeStart = 0;
            if (safeStart > 20) safeStart = 20;

            document.getElementById('chartSlider').value = safeStart;
            onSliderChange(safeStart);
        }

        let isFullView = false;
        let lastSliderVal = 0;

        function toggleFullView() {
            if (!trendChart) return;
            const btn = document.getElementById('fullViewBtn');
            const slider = document.getElementById('chartSlider');
            const sliderContainer = document.getElementById('sliderContainer');

            isFullView = !isFullView;

            if (isFullView) {
                // Switch to Full View
                lastSliderVal = slider.value;
                trendChart.options.scales.x.min = 0;
                trendChart.options.scales.x.max = 24;
                trendChart.options.scales.x.ticks.stepSize = 4; // Less dense ticks
                trendChart.update();

                btn.classList.add('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.remove('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-compress"></i> 退出';

                sliderContainer.classList.add('opacity-50', 'pointer-events-none');
                slider.disabled = true;
            } else {
                // Restore Focus View
                trendChart.options.scales.x.min = parseInt(lastSliderVal);
                trendChart.options.scales.x.max = parseInt(lastSliderVal) + 4;
                trendChart.options.scales.x.ticks.stepSize = 1; // Detailed ticks
                trendChart.update();

                btn.classList.remove('bg-blue-600', 'border-blue-500', 'text-white');
                btn.classList.add('text-slate-400', 'border-slate-600');
                btn.innerHTML = '<i class="fas fa-expand"></i> 全景';

                sliderContainer.classList.remove('opacity-50', 'pointer-events-none');
                slider.disabled = false;
            }
        }

        function moveSlider(delta) {
            const slider = document.getElementById('chartSlider');
            let val = parseInt(slider.value) + delta;
            // Clamp
            if (val < 0) val = 0;
            if (val > 20) val = 20;

            slider.value = val;
            onSliderChange(val);
        }

        function onSliderChange(val) {
            if (isFullView) return; // Ignore if in full view
            const start = parseInt(val);
            if (trendChart) {
                trendChart.options.scales.x.min = start;
                trendChart.options.scales.x.max = start + 4; // Fixed 4h window
                trendChart.update('none'); // Efficient update works better
            }
        }

        function setDistMode(mode) {
            currentDistMode = mode;
            // Update Toggle UI
            const btnToday = document.getElementById('distModeToday');
            const btnWeek = document.getElementById('distModeWeek');

            if (mode === 'today') {
                btnToday.className = 'px-3 py-1 text-xs rounded-md transition bg-slate-700 text-white shadow-sm';
                btnWeek.className = 'px-3 py-1 text-xs rounded-md transition text-slate-400 hover:text-white';
            } else {
                btnToday.className = 'px-3 py-1 text-xs rounded-md transition text-slate-400 hover:text-white';
                btnWeek.className = 'px-3 py-1 text-xs rounded-md transition bg-slate-700 text-white shadow-sm';
            }

            renderDistChart();
        }

        function renderDistChart() {
            const ctxDist = document.getElementById('distChart').getContext('2d');
            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };
            const isRelax = (s) => getTag(s.tagId).name === 'Relax';

            // Filter Sessions based on Mode
            const focusSessions = sessions.filter(s => !isRelax(s));
            const now = new Date();
            let distSource = [];

            if (currentDistMode === 'today') {
                distSource = focusSessions.filter(s => new Date(s.startTime).toDateString() === now.toDateString());
            } else {
                // Week
                const d = new Date(now);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const weekStart = new Date(d.setDate(diff));
                weekStart.setHours(0, 0, 0, 0);
                distSource = focusSessions.filter(s => new Date(s.startTime) >= weekStart);
            }

            const tagStats = {};
            distSource.forEach(s => {
                const t = getTag(s.tagId);
                tagStats[t.name] = (tagStats[t.name] || 0) + s.duration;
            });

            const distLabels = Object.keys(tagStats);
            const distData = Object.values(tagStats);
            const distColors = distLabels.map(name => tags.find(t => t.name === name)?.color || '#ccc');

            if (distChart) distChart.destroy();

            // Handle Empty Data
            if (distData.length === 0) {
                // Maybe show a "No Data" text or empty chart? 
                // Chart.js handles empty data okay, but let's just render it.
            }

            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: distLabels,
                    datasets: [{
                        data: distData,
                        backgroundColor: distColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: ${value}分钟 (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderHistoryList() {
            const filter = document.getElementById('historyFilter').value;
            const list = document.getElementById('historyList');
            const now = new Date();

            let displayedSessions = [...sessions];
            console.log(`[Pomodoro] Render History - Total: ${sessions.length}, Filter: ${filter}`);

            if (filter === 'today') {
                displayedSessions = displayedSessions.filter(s => {
                    const match = new Date(s.startTime).toDateString() === now.toDateString();
                    // console.log(`Date Check: ${s.startTime} vs ${now.toISOString()} -> ${match}`);
                    return match;
                });
            } else if (filter === 'week') {
                const d = new Date(now);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const weekStart = new Date(d.setDate(diff));
                weekStart.setHours(0, 0, 0, 0);
                displayedSessions = displayedSessions.filter(s => new Date(s.startTime) >= weekStart);
            }

            console.log(`[Pomodoro] Displayed Sessions: ${displayedSessions.length}`);

            if (displayedSessions.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-slate-500">暂无记录</div>';
                return;
            }

            const getTag = (id) => tags.find(t => t.id === id) || { name: 'Unknown', color: '#ccc' };

            list.innerHTML = displayedSessions.map(s => {
                const tag = getTag(s.tagId);
                const date = new Date(s.startTime);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="p-4 hover:bg-slate-700/50 transition flex items-center justify-between group">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-slate-400 font-bold shrink-0">
                                ${s.duration}
                            </div>
                            <div class="min-w-0 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="w-2 h-2 rounded-full" style="background-color: ${tag.color}"></span>
                                    <span class="font-medium text-slate-200">${tag.name}</span>
                                </div>
                                ${s.description ? `<div class="text-sm text-slate-300 mb-1 break-words">${s.description}</div>` : ''}
                                <div class="text-xs text-slate-500">${dateStr}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                            <button onclick="editSession(${s.id})" class="text-slate-500 hover:text-blue-500 p-2" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSession(${s.id})" class="text-slate-500 hover:text-rose-500 p-2" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteSession(id) {
            if (confirm('确定删除这条记录吗？')) {
                try {
                    await db.execute('DELETE FROM pomodoro_sessions WHERE id = ?', [id]);
                } catch (e) { console.error('Delete Failed:', e); }
            }
        }


        function exportData() {
            // Let parent handle it via standard Export button in index.html? 
            // Or we can trigger a CSV export here.
            // User asked for "Export Data", parent has global DB export.
            // Let's rely on parent's global export for simplicity and consistency ("Export Database").
            // But if user wants CSV:
            if (confirm('是否要导出所有番茄钟记录为 CSV？')) {
                const csvContent = "data:text/csv;charset=utf-8,"
                    + "ID,StartTime,EndTime,Duration,TagName,Status\n"
                    + sessions.map(s => {
                        const t = tags.find(tag => tag.id === s.tagId)?.name || 'Unknown';
                        return `${s.id},${s.startTime},${s.endTime},${s.duration},${t},${s.status}`;
                    }).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "pomodoro_history.csv");
                document.body.appendChild(link);
                link.click();
            }
        }



        let currentEditSessionId = null;

        function editSession(id) {
            const session = sessions.find(s => s.id === id);
            if (!session) return;

            currentEditSessionId = id;

            // Format times for datetimelocal (YYYY-MM-DDTHH:mm)
            const formatForInput = (isoStr) => {
                const d = new Date(isoStr);
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            document.getElementById('editStartTime').value = formatForInput(session.startTime);
            document.getElementById('editEndTime').value = formatForInput(session.endTime);
            document.getElementById('editDescription').value = session.description || '';

            // Populate tags
            const select = document.getElementById('editTagSelect');
            select.innerHTML = tags.map(t => `<option value="${t.id}" ${t.id === session.tagId ? 'selected' : ''}>${t.name}</option>`).join('');

            document.getElementById('editSessionModal').classList.remove('hidden');
        }

        function closeEditSessionModal() {
            document.getElementById('editSessionModal').classList.add('hidden');
            currentEditSessionId = null;
        }

        async function confirmEditSession() {
            if (!currentEditSessionId) return;

            const stVal = document.getElementById('editStartTime').value;
            const etVal = document.getElementById('editEndTime').value;
            const tagId = parseInt(document.getElementById('editTagSelect').value);
            const desc = document.getElementById('editDescription').value.trim();

            if (!stVal || !etVal) {
                alert('请填写完整的时间');
                return;
            }

            const start = new Date(stVal);
            const end = new Date(etVal);

            if (end <= start) {
                alert('结束时间必须晚于开始时间');
                return;
            }

            const durationMins = Math.round((end - start) / 60000);

            try {
                await db.execute(
                    `UPDATE pomodoro_sessions SET start_time = ?, end_time = ?, duration_minutes = ?, tag_id = ?, description = ? WHERE id = ?`,
                    [start.toISOString(), end.toISOString(), durationMins, tagId, desc, currentEditSessionId]
                );
            } catch (e) { console.error('Update Failed:', e); }

            closeEditSessionModal();
        }

        async function initTables() {
            console.log('[Pomodoro] initTables() called');
            try {
                console.log('[Pomodoro] Creating pomodoro_tags table...');
                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_tags (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        color TEXT NOT NULL,
                        is_default INTEGER DEFAULT 0
                    )
                `);

                // Tags Check
                console.log('[Pomodoro] Checking if tags exist...');
                const countRes = await db.query("SELECT COUNT(*) FROM pomodoro_tags");
                console.log('[Pomodoro] Tag count result:', countRes);
                if (countRes && countRes[0].values[0][0] === 0) {
                    console.log('[Pomodoro] No tags found, inserting defaults...');
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Work', '#3b82f6', 1)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Study', '#a855f7', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Workout', '#e11d48', 0)");
                    await db.execute("INSERT INTO pomodoro_tags (name, color, is_default) VALUES ('Relax', '#10b981', 0)");
                    console.log('[Pomodoro] Default tags inserted');
                } else {
                    console.log('[Pomodoro] Tags already exist, count:', countRes[0].values[0][0]);
                }

                await db.execute(`
                    CREATE TABLE IF NOT EXISTS pomodoro_sessions (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        start_time TEXT NOT NULL,
                        end_time TEXT NOT NULL,
                        duration_minutes INTEGER NOT NULL,
                        tag_id INTEGER,
                        status TEXT,
                        description TEXT,
                        created_at TEXT NOT NULL
                    )
                `);

            } catch (err) {
                console.error('Init Tables Failed:', err);
            }
        }

        // === File Permission & Sync Functions ===
        let lastSyncFailed = false;
        let syncFailAlertShown = false;

        function updateSyncStatus(success, message = '') {
            if (success) {
                lastSyncFailed = false;
                syncFailAlertShown = false;
            } else {
                lastSyncFailed = true;
                // Show alert only once per failure sequence
                if (message && !syncFailAlertShown) {
                    syncFailAlertShown = true;
                    console.warn('[Pomodoro] Sync failed:', message);
                    // Show a non-blocking toast warning
                    showSyncWarningToast(message);
                }
            }
        }

        function showSyncWarningToast(message) {
            // Remove existing toast if any
            const existingToast = document.getElementById('sync-warning-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'sync-warning-toast';
            toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-amber-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:text-amber-200">&times;</button>
            `;
            document.body.appendChild(toast);
            // Auto-remove after 8 seconds
            setTimeout(() => toast.remove(), 8000);
        }

        async function ensureFilePermission() {
            try {
                const idb = await openIndexedDB();
                const tx = idb.transaction(IDB_STORE, 'readonly');
                const store = tx.objectStore(IDB_STORE);
                const request = store.get(IDB_KEY);
                const existing = await new Promise(resolve => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });

                if (!existing?.handle) {
                    console.log('[Pomodoro] No file handle found');
                    return false;
                }

                const opts = { mode: 'readwrite' };
                let perm = await existing.handle.queryPermission(opts);

                if (perm !== 'granted') {
                    console.log('[Pomodoro] Requesting file permission...');
                    perm = await existing.handle.requestPermission(opts);
                }

                if (perm === 'granted') {
                    console.log('[Pomodoro] ✅ File permission granted');
                    updateSyncStatus(true);
                    return true;
                } else {
                    console.warn('[Pomodoro] File permission denied');
                    updateSyncStatus(false, '文件权限被拒绝');
                    return false;
                }
            } catch (err) {
                console.error('[Pomodoro] Permission check failed:', err);
                return false;
            }
        }

        // === IDB Loading for Standalone Operation ===
        const IDB_NAME = 'LocalForgeDB';
        const IDB_STORE = 'snapshots';
        const IDB_KEY = 'main_db';

        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(IDB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const idb = event.target.result;
                    if (!idb.objectStoreNames.contains(IDB_STORE)) {
                        idb.createObjectStore(IDB_STORE);
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function loadSnapshotFromIDB() {
            try {
                const idb = await openIndexedDB();
                const tx = idb.transaction(IDB_STORE, 'readonly');
                const store = tx.objectStore(IDB_STORE);
                const request = store.get(IDB_KEY);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('[Pomodoro] IDB Load Error:', err);
                return null;
            }
        }

        async function saveSnapshotToIDB() {
            try {
                const data = await db.export();
                const idb = await openIndexedDB();

                // Read existing record to preserve file handle
                const readTx = idb.transaction(IDB_STORE, 'readonly');
                const readStore = readTx.objectStore(IDB_STORE);
                const existingReq = readStore.get(IDB_KEY);
                const existing = await new Promise(resolve => {
                    existingReq.onsuccess = () => resolve(existingReq.result);
                    existingReq.onerror = () => resolve(null);
                });

                // Build new record, preserving handle and filename from existing
                const record = {
                    data: data,
                    updated_at: Date.now(),
                    handle: existing?.handle || null,
                    filename: existing?.filename || 'auto_backup'
                };

                const writeTx = idb.transaction(IDB_STORE, 'readwrite');
                const writeStore = writeTx.objectStore(IDB_STORE);
                writeStore.put(record, IDB_KEY);
                await new Promise((resolve, reject) => {
                    writeTx.oncomplete = resolve;
                    writeTx.onerror = reject;
                });
                console.log('[Pomodoro] Saved to IDB (handle preserved:', !!record.handle, ')');
            } catch (err) {
                console.error('[Pomodoro] IDB Save Error:', err);
            }
        }

        // Auto-save to IDB AND file on every update
        db.on('db_updated', async () => {
            console.log('[Pomodoro] DB Updated, saving...');

            try {
                const data = await db.export();
                const idb = await openIndexedDB();

                // Read existing record to get file handle
                const readTx = idb.transaction(IDB_STORE, 'readonly');
                const readStore = readTx.objectStore(IDB_STORE);
                const existingReq = readStore.get(IDB_KEY);
                const existing = await new Promise(resolve => {
                    existingReq.onsuccess = () => resolve(existingReq.result);
                    existingReq.onerror = () => resolve(null);
                });

                // Try to save to file if handle exists
                if (existing?.handle) {
                    try {
                        const opts = { mode: 'readwrite' };
                        const perm = await existing.handle.queryPermission(opts);
                        if (perm === 'granted') {
                            const writable = await existing.handle.createWritable();
                            await writable.write(data);
                            await writable.close();
                            console.log('[Pomodoro] ✅ Saved to file:', existing.handle.name);
                            updateSyncStatus(true);
                        } else {
                            console.warn('[Pomodoro] File permission not granted, IDB only');
                            updateSyncStatus(false, '文件权限已丢失，请点击同步按钮重新授权');
                        }
                    } catch (fileErr) {
                        console.warn('[Pomodoro] File save failed:', fileErr.message);
                        updateSyncStatus(false, '文件保存失败: ' + fileErr.message);
                    }
                } else {
                    updateSyncStatus(false, '未找到文件句柄');
                }

                // Always save to IDB
                const record = {
                    data: data,
                    updated_at: Date.now(),
                    handle: existing?.handle || null,
                    filename: existing?.filename || 'auto_backup'
                };

                const writeTx = idb.transaction(IDB_STORE, 'readwrite');
                const writeStore = writeTx.objectStore(IDB_STORE);
                writeStore.put(record, IDB_KEY);
                await new Promise((resolve, reject) => {
                    writeTx.oncomplete = resolve;
                    writeTx.onerror = reject;
                });
                console.log('[Pomodoro] Saved to IDB');
            } catch (err) {
                console.error('[Pomodoro] Save Error:', err);
            }
        });

        // Startup: Load from IDB or wait for db_opened
        console.log('[Pomodoro] Setting up startup, db.isOpen =', db.isOpen);

        let initCalled = false;

        db.on('db_opened', () => {
            if (initCalled) return;
            initCalled = true;
            console.log('[Pomodoro] db_opened event received, calling init()...');
            init();
        });

        if (db.isOpen) {
            initCalled = true;
            console.log('[Pomodoro] DB already open, calling init() immediately...');
            init();
        } else {
            console.log('[Pomodoro] DB not open, waiting for worker ready...');

            // Wait for worker ready, then load from IDB
            const tryLoadFromIDB = async () => {
                if (initCalled) return;
                console.log('[Pomodoro] Worker ready, trying to load from IDB...');
                try {
                    const snapshot = await loadSnapshotFromIDB();
                    if (initCalled) return;
                    if (snapshot && snapshot.data) {
                        console.log('[Pomodoro] Found IDB snapshot, initializing DB...');
                        await db.init(snapshot.data);
                        // db_opened event will be fired by the worker
                    } else {
                        console.error('[Pomodoro] No database found in IDB!');
                        alert('数据库未找到！请先在主页 Settings 中打开数据库文件。\n\nNo database found! Please open a database file in Settings first.');
                    }
                } catch (err) {
                    console.error('[Pomodoro] Failed to load from IDB:', err);
                    alert('数据库加载失败！\n\nFailed to load database!');
                }
            };

            if (db.isReady) {
                tryLoadFromIDB();
            } else {
                db.on('ready', tryLoadFromIDB);
            }
        }


        // Expose to window for HTML events
        window.toggleTagMenu = toggleTagMenu;
        window.openAddTagModal = openAddTagModal;
        window.closeAddTagModal = closeAddTagModal;
        window.selectTag = selectTag;
        window.selectNewTagColor = selectNewTagColor;
        window.confirmAddTag = confirmAddTag;
        window.openStats = openStats;
        window.closeStats = closeStats;
        window.toggleFullView = toggleFullView;
        window.onSliderChange = onSliderChange;
        window.exportData = exportData;
        window.editSession = editSession;
        window.closeEditSessionModal = closeEditSessionModal;
        window.confirmEditSession = confirmEditSession;
        window.deleteSession = deleteSession;
        window.toggleTimer = toggleTimer;
        window.resetTimer = resetTimer;
        window.askCustomDuration = askCustomDuration;
        window.closeCustomDuration = closeCustomDuration;
        window.adjustCustomInput = adjustCustomInput;
        window.confirmCustomDuration = confirmCustomDuration;
        window.confirmSaveSession = confirmSaveSession;
        window.discardSession = discardSession;
        window.saveTag = saveTag;
        window.deleteTag = deleteTag;
        window.setDuration = setDuration;
        window.setDistMode = setDistMode;
        window.renderHistoryList = renderHistoryList;
        window.moveSlider = moveSlider;
        window.skipRelax = skipRelax;

        // === Immediate UI Init ===
        console.log('[Pomodoro] Executing immediate UI init...');
        setDuration(25);
        document.getElementById('historyFilter').value = 'today';

    </script>
</body>

</html>